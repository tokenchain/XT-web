<link href="<%= STATIC %>/styles/u.css" rel="stylesheet" type="text/css">

<div id="trade-index" :class="{'loaded': loaded}">
  <div class="centre" ref="center">
    <div class="centre-content">
      <div class="chart">
        <div class="hd">
          <h2 class="vue-init">{{marketDisplay}}</h2>
          <p class="tab">
            <a role="button" :class="{'on': chartType == 'kline'}" @click="setChartType('kline')"><%= LANG('K线图') %></a>
            <a role="button" :class="{'on': chartType == 'depth'}" @click="setChartType('depth')"><%= LANG('深度') %></a></p>
          <p class="tab" v-cloak="">
            <a role="button" :class="{'on': moneyType == klineMoney }" @click="setChartMoney(moneyType)">{{moneyType.toUpperCase()}}</a>
            <a role="button" :class="{'on': moneyType != klineMoney }" @click="setChartMoney('<%= MONEY %>')"><%= MONEY.toUpperCase() %></a>
          </p>
          <p class="tab timelist">
            <span class="crosswise">

              <a role="button" @click="switchPeriod('1w')" :class="[period == '1w' ? 'on' : '']"><%= LANG('周') %></a>
              <a role="button" @click="switchPeriod('1d')" :class="[period == '1d' ? 'on' : '']"><%= LANG('日') %></a>
              <a role="button" @click="switchPeriod('1h')" :class="[period == '1h' ? 'on' : '']"><%= LANG('时') %></a>
              <a role="button" @click="switchPeriod('30m')" :class="[period == '30m' ? 'on' : '']">30<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('15m')" :class="[period == '15m' ? 'on' : '']">15<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('1m')" :class="[period == '1m' ? 'on' : '']">1<%= LANG('分') %></a>

            </span>

            <span class="vertical">
              <em v-if="period == '1w'"><%= LANG('周') %></em>
              <em v-if="period == '1d'"><%= LANG('日') %></em>
              <em v-if="period == '1h'"><%= LANG('时') %></em>
              <em v-if="period == '30m'">30<%= LANG('分') %></em>
               <em v-if="period == '15m'">15<%= LANG('分') %></em>
               <em v-if="period == '1m'">1<%= LANG('分') %></em>

              <i>
              <a role="button" @click="switchPeriod('1w')" :class="[period == '1w' ? 'on' : '']"><%= LANG('周') %></a>
              <a role="button" @click="switchPeriod('1d')" :class="[period == '1d' ? 'on' : '']"><%= LANG('日') %></a>
              <a role="button" @click="switchPeriod('1h')" :class="[period == '1h' ? 'on' : '']"><%= LANG('时') %></a>
              <a role="button" @click="switchPeriod('30m')" :class="[period == '30m' ? 'on' : '']">30<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('15m')" :class="[period == '15m' ? 'on' : '']">15<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('1m')" :class="[period == '1m' ? 'on' : '']">1<%= LANG('分') %></a>
              </i>
            </span>


          </p>
          <a title="<%= LANG('全屏') %>" href="/kline/<%= market %>" class="qp"><i class="iconfont icon-quanping"></i></a>

          <div class="notice-list t_news vue-init">
            <ul class="news_li">
              <li><a href="#">什么是XBTC  </a></li>
              <li><a href="#">ETC涨跌对投资收益有影响么？ </a></li>
              <li><a href="#">XBTC基于以太坊ETC发布和定价 </a></li>
              <li><a href="#">XBTC发行认购进度 </a></li>
            </ul>
              <ul class="swap"></ul>
          </div>
        </div>
        <div class="bd">
          <div v-show="chartType === 'kline'" class="chart-box">
            <iframe src="/kline/lite/<%= market %>" id="marketFrame" class="marketFrame" name="marketFrame" onload="" frameborder="0" width="100%" style="height:300px" hspace="0" scrolling="no"></iframe>
          </div>
          <div v-show="chartType === 'depth'" class="chart-box">
            <vue-highcharts class="depth-chart" :options="depthChartOptions" ref="depth"></vue-highcharts>
          </div>
        </div>
      </div>
      <div class="fillin clearfix">
        <div class="box">

          <div class="buy">
            <ul>
              <li ref="buy">
                <label><%= LANG('购买价格') %>：</label>
                <input ref="buyPrice" type="text" @input="priceInput" @focus="setShowTip('buy')" class="form-control" data-model="buyPrice"  data-money="buyMoney" :data-fixed="marketInfo.exchangeBixDian" value="" autocomplete="off">
                <span class="company vue-init">{{marketDisplay.split('/')[1]}}</span>
                <transition name="fadeInUp" style="display: none">
                  <div class="tip" v-show="showBuyTip">
                    <span><%= LANG('约等于') %></span>
                    <input ref="buyMoney" type="text" @input="moneyInput" @focus="setShowTip('buy')" data-model="buyPrice" :data-fixed="3" value=""  autocomplete="off" placeholder="">
                    <span class="unit"><%= MONEY.toUpperCase() %></span>
                  </div>
                </transition>
              </li>
              <li>
                <label><%= LANG('购买数量') %>：</label>
                <input type="text" ref="buyQuantity" @input="priceInput" data-model="buyQuantity" :data-fixed="marketInfo.numberBixDian" value="" class="form-control b" autocomplete="off" :placeholder="'最多 ' + canBuy">
                <p class="company vue-init">{{marketDisplay.split('/')[0]}}</p>
              </li>
              <li><%= LANG('可用金额') %>：<span class="vue-init"><em></em>{{useableBTC + ' BTC'}}  </span></li>
              <li><%= LANG('交易金额') %>：<span class="vue-init"><em></em>{{buyTotal + ' ' + marketDisplay.split('/')[1]}}</span></li>
            </ul>
            <a href="javascript:;" v-on:click="handleBuy" class="btn"><%= LANG('立即购买') %></a>

          </div>
        </div>
        <div class="box">
          <div class="sell">
            <ul>
              <li ref="sell">
                <label><%= LANG('卖出价格') %>：</label>
                <input ref="sellPrice" type="text" @input="priceInput" @focus="setShowTip('sell')" data-model="sellPrice" data-money="sellMoney" :data-fixed="marketInfo.exchangeBixDian" value="" class="form-control b" autocomplete="off">
                <span class="company vue-init">{{marketDisplay.split('/')[1]}}</span>
                <transition name="fadeInUp" style="display: none">
                  <div class="tip" v-show="showSellTip">
                    <span><%= LANG('约等于') %></span>
                    <input ref="sellMoney" type="text" @input="moneyInput" @focus="setShowTip('sell')" data-model="sellPrice" :data-fixed="3" value=""  autocomplete="off" placeholder="">
                    <span class="unit"><%= MONEY.toUpperCase() %></span>
                  </div>
                </transition>
              </li>
              <li>
                <label><%= LANG('卖出数量') %>：</label>
                <input type="text" ref="sellQuantity" @input="priceInput" data-model="sellQuantity" :data-fixed="marketInfo.numberBixDian" value="" class="form-control b" autocomplete="off" :placeholder="'最多 ' + useable">
                <p class="company vue-init">{{marketDisplay.split('/')[0]}}</p>
              </li>
              <li><%= LANG('可用金额') %>：<span class="vue-init"><em></em>{{useable + ' ' + marketDisplay.split('/')[0]}}</span></li>
              <li><%= LANG('交易金额') %>：<span class="vue-init"><em></em>{{sellTotal + ' ' + marketDisplay.split('/')[1]}}</span></li>
            </ul>
            <a href="javascript:;" class="btn" v-on:click="handleSell"><%= LANG('立即卖出') %></a>
          </div>
        </div>
        <modal class="vue-init modal-form" :is-open="showSafePwd">
          <h3 slot="header"><%= LANG('请输入二级密码') %></h3>
          <div slot="body">
            <div class="form-group">
              <span class="name"><%= LANG('二级密码') %>：</span>
              <div class="control">
                <input v-model="safePwd" placeholder="<%= LANG('请输入二级密码') %>" type="password" />
              </div>
            </div>
          </div>
          <div slot="footer">
            <button v-on:click="handleEntrustSubmit" class="btn"><%= LANG('确定') %></button>
            <button v-on:click="cancelSafePwd" class="btn"><%= LANG('取消') %></button>
          </div>
        </modal>
      </div>
      <div class="entrust">
        <div class="hd">
          <h2><%= LANG('最近委托') %></h2>
          <p><a :href="'/entrust/' + market"><%= LANG('历史委托') %></a></p>
        </div>
        <div class="bd">
          <json-table :settings="entrustTableSettings" class="sell" :columns="entrustCols" :rows="entrustRows" ></json-table>
        </div>
      </div>
    </div>
  </div>

  <div class="right" ref="right">

    <div id="orderbook" class="price">
      <div class="orderTitle clearfix">
        <span style="width:25%;"><%= LANG('价格') %>(<%= market.split("_")[1] %>)</span>
        <span style="width:25%"><%= LANG('折合') %>(<%= MONEY.toUpperCase() %>)</span>
        <span style="width:25%"><%= LANG('数量') %>(<%= market.split("_")[0] %>)</span>
        <span style="width:25%; text-align: left; padding-left:10px;"><%= LANG('深度') %></span>
      </div>
      <div id="asks">
        <div class="table">
        </div>
      </div>
      <div @click="setPrice(currentPrice)" class="current-price vue-init" :class="priceTrend">
        <em>
          <b>￥</b>
          <animated-number :number="currentPrice"></animated-number>
        </em>
        <i></i>
      </div>
      <div id="bids">
        <div class="table">
        </div>
      </div>
      <div class="choice clearfloat hide">
        <p><%= LANG('深度') %>：</p>
        <select autocomplete="off">
          <option value="1"><%= LANG('默认') %></option>
          <option value="1">0.001</option>
          <option value="2">0.005</option>
          <option value="3">0.01</option>
        </select>
      </div>
    </div>

    <div class="deal-time" ref="deal">
      <json-animate-grid class="sell-grid" :columns="dealRecordCols" keyfield="tid" :rows="dealRecord" ></json-animate-grid>
    </div>

  </div>

</div>

<%-include("../component/animated_number.html")%>
<%-include("../component/json_table.html")%>
<%-include("../component/json_animate_grid.html")%>
<%-include("../component/vue_highcharts.html")%>

<script>
  require(['vue', 'jquery', 'common/methods', 'common/juabox'], function(Vue, $, Methods, JuaBox) {
    EXX.tradeIndex = new Vue({
      el: "#trade-index",
      data: function () {
        return {
          sharedState: store.state,
          klineMoney : MONEY,
          pubKey: '',
          period : '15m',
          theme: 'light',
          chartType: 'kline',
          showSafePwd: false,
          showSellTip: false,
          showBuyTip: false,
          loaded: true,
          market: '<%= market %>',
          currentPrice: '',
          priceTrend: 'up',
          buyPrice: '',
          buyQuantity: '',
          sellPrice: '',
          sellQuantity: '',
          safePwd: '',
          isBuy: -1,
          isReal: false,
          ask: [],  //卖单盘口数据
          bid: [],  //买单盘口数据
          rate : 6.4997,
          coinType: '<%= market.split("_")[0] %>',
          moneyType: '<%= market.split("_")[1] %>',
          allPriceRate :store.state.allPriceRate,
          oriPrice:'',
          maxAsksNum : 0,
          maxBidsNum : 0,
          chartAsks: [],
          chartBids: [],
          dealRecordCols: [
            {label: "<%= LANG('成交时间') %>", key: 'date', cell: function(item){
              return Methods.getDateTime(parseInt(item.date * 1000), 'HH:MM:SS');
            }},
            {label: "<%= LANG('价格') %>", key: 'price'},
            {label: "<%= LANG('数量') %>", key: 'amount'}
          ],
          lastDepth :'',
          depthShowSize: 20,
          dealRecord: [],
          entrustRecord: [],
          entrustCols: [
            {
              label: ' ',
              key: 'type',
              cell: function(item) {
                var text = '';
                if (item.type === 1) {
                  text = "<em><%= LANG('买') %></em>";
                } else if (item.type === 0) {
                  text = "<em><%= LANG('卖') %></em>";
                }
                return text;
              }
            },
            {label: "<%= LANG('时间/序列号') %>", key: 'date', cell: function(item){
              return Methods.getDateTime(item.date);
            }},
            {label: "<%= LANG('委托量/价格') %>", key: 'num_price'},
            {label: "<%= LANG('成交量/均价') %>", key: 'deal_price'},
            {label: "<%= LANG('成交额/费用') %>", key: 'totalMoney'},
            {label: "<%= LANG('状态/操作') %>", key: 'actions', cell: function(item){
              //var el = createElement('span', 'test');
              if (item.status === 0) {
                return '<a onclick="EXX.tradeIndex.handleEntrustCancel(' + item.id + ',' + item.isReal + ')">' + "<%= LANG('取消') %>" + '</a>';
              } else if (item.status === 1) {
                return "<span class='canceled'><%= LANG('已取消') %></span>";
              } else if (item.status === 2) {
                return "<span class='success'><%= LANG('已成交') %></span>";
              } else if (item.status === 3) {
                return "<span class='in-action'><%= LANG('交易中') %></span> | <a onclick='EXX.tradeIndex.handleEntrustCancel(" + item.id + ',' + item.isReal + ")'" + "><%= LANG('取消') %></a>";
              }
            }.bind(this)}
          ],
          entrustTableSettings: {
            rowClass: function(item) {
              if (item.type === 1) {
                return 'buy';
              } else if (item.type === 0) {
                return 'sell';
              }
              return current;
            }
          }
        }
      },
      computed: {
        currencyList: function () {
            try{
                return EXX.userLeft.$data.currencyList || [];
            }catch(err){
                console.log('Miss leftMenu component')
            }
        },
        moneyPrice: function(){
            return this.allPriceRate[MONEY][this.moneyType]
        },
        marketInfo: function() {
          var markets = this.sharedState.markets;
          var marketInfo = {};
          if (markets.length) {
            marketInfo = markets.getObject('type', this.market);
          }
          return marketInfo;
        },
        buyPriceMoney: function() {
          return parseFloat(this.buyPrice * this.moneyPrice).toFixed(3);
        },
        sellPriceMoney: function() {
          return parseFloat(this.sellPrice * this.moneyPrice).toFixed(3);
        },
        askRows: function() {
          var rows = [];
          var ask = this.ask || [];
          ask.forEach(function(a) {
            var item = {};
            item.price = a[0];
            item.amount = a[1];
            item.depth = a[2];
            rows.push(item);
          });
          return rows;
        },
        bidRows: function() {
          var rows = [];
          var bid = this.bid || [];
          bid.forEach(function(b) {
            var item = {};
            item.price = b[0];
            item.amount = b[1];
            item.depth = b[2];
            rows.push(item);
          });
          return rows.reverse();
        },
        entrustRows: function() {
          var rows = [];
          var entrust = this.entrustRecord || [];
          entrust.forEach(function(b) {
            var item = {};
            item.isReal = b.length >= 16 ? true : false;
            item.id = b[0];
            item.num_price = [b[2], b[1]].join(' / ');
            item.deal_price = [b[3], b[4]].join(' / ');
            item.totalMoney = [b[4], b[8]].join(' / ');
            item.type = b[5];
            item.date = b[6];
            item.status = b[7];
            rows.push(item);
          });
          return rows;
        },
        depthChartOptions: function() {
          //var asks = this.chartAsks.reverse() || [];
          //var bids = this.chartBids || [];
          var asks = this.ask.reverse() || [];
          var bids = this.bid || [];
          var currentPrice = [[Number(this.currentPrice), 0]];
          var sumAsks = 0;
          var sumBids= 0;
          var fasks = asks.map(function(ask, index){
            if (index > 0) {
              sumAsks = (Number(ask[1])+Number(sumAsks)).toFixed(4);
              //console.log(Number(ask[1])+Number(sumAsks));

            } else {
              sumAsks = ask[1]
            }
            return [Number(ask[0]), Number(sumAsks)];
          });
          //for(var i=0;i<asks.length;i++){
          //  if(i>0){
          //    asks[i][1]=Number(Number(asks[i][1]+asks[i-1][1]).toFixed(4));
          //  }
          //}
//          for(var i=0;i<bids.length;i++){
//            if(i>0){
//              bids[i][1]=Number(Number(bids[i][1]+bids[i-1][1]).toFixed(4));
//            }
//          }
          var fbids = bids.map(function(bid, index){
            if (index > 0) {
              sumBids = (Number(bid[1])+Number(sumBids)).toFixed(4);
            } else {
              sumBids = bid[1]
            }
            return [Number(bid[0]), Number(sumBids)];
          });
          fbids.reverse();
          var opts = {
            title:null,
            rangeSelector : {selected : 1},
            rangeSelector: {enabled:false},
            exporting:{enabled:false},
            credits: {
              enabled: false
            },
            chart:{
              alignTicks:true,
              plotBorderColor: '#FFF',
              plotBorderWidth: 1,
              backgroundColor:"#FFF",
              marginBottom:50
			},
            legend: {
              backgroundColor: "#FFF",
              y:20,
              shadow:false,
              itemHoverStyle: { color: '#EBEBEB' },
              itemStyle: { cursor: 'pointer', color: '#333' }
            },
            xAxis: {
              title: null,
              labels: {
                formatter: function() {
                  return this.value;
                }
              },
              minPadding:0.001,
              maxPadding:0.001,
              tickWidth:1,
              tickLength:5,
              tickColor:"#EBEBEB",
              lineColor:"#EBEBEB"
            },
            yAxis: [
              {
            	type: 'datetime',
	            title: null,
	            reversed:true
	          },
              {
	            title:null,
	            labels: {
	                format: "{value}"
	            },
	            opposite: true,
	            min:0,
                gridLineDashStyle: 'solid',
                gridLineColor:"#EBEBEB",
                gridLineWidth:1
	          }
	        ],
            plotOptions: {
              areaspline: {
                marker: {
                  symbol: 'circle',
                  radius: 0,
                  states: {
                    hover: {
                      enabled: true
                    }
                  }
                }
              },
              scatter: {
                radius:5,
                marker: {
                  radius: 5,
                  symbol:"triangle-down"
                },
                states: {
                  hover: {
                    enabled: false
                  },
                  select:{
                    enabled: false
                  }
                },
                tooltip: {
                  headerFormat: ' <b>{series.name}</b><br>',
                  pointFormat: ' <b>{point.x}'
                },
                cursor:"pointer"
              }
            },
            series : [
              {
                name : '<%= LANG("买单") %>',
                data : fasks,
                type : 'areaspline',
                color:"#31c871",
                yAxis: 1,
                zIndex:1
              },
              {
                name: "<%= LANG('最新价') %>",
                data : currentPrice,
                type : 'scatter',
                color:"#6baffb",
                yAxis: 1,
                zIndex:2
              },
              /*{
                  name: "价格",
                  data : [],
                  type : 'spline',
                  color:"#40bb28",
                  yAxis: 0
              },*/
              {
                name: '<%= LANG("卖单") %>',
                data: fbids,
                type: 'areaspline',
                color:"#ec483a",
                yAxis: 1,
                zIndex:1
              }
            ]
          };
          return opts;
        },
        marketDisplay: function() {
          return this.market.toUpperCase().replace('_', '/');
        },
        useable: function() {
          var coinName = this.marketDisplay.split('/')[0];
          var asset = this.sharedState.coinAccets[coinName];
          return asset ? asset.usable : 0;
        },
        useableBTC: function() {
          var asset = this.sharedState.coinAccets['BTC'];
          return asset ? asset.usable : 0;
        },
        canBuy: function() {
          if (this.bid.length) {
            return Methods.numDivider(this.useableBTC, this.bid[0][0]).toFixed(3);
          } else {
            return 0;
          }
        },
        buyTotal: function() {
          return Methods.numMultiply(this.buyPrice, this.buyQuantity);
        },
        sellTotal: function() {
          return Methods.numMultiply(this.sellPrice, this.sellQuantity);
        }
      },
      methods: {
        switchPeriod: function(period){
          this.setChartType('kline');
          this.period = period  ;
          window.frames['marketFrame'].switch_period(period);
        },
        switchTheme: function(theme){
          this.theme = theme ;
          window.frames['marketFrame'].switch_theme(theme);
        },
        setChartMoney: function(type) {
            this.setChartType('kline');
            this.klineMoney = type;
            window.frames['marketFrame'].chart_switch_money(type);
        },
        setChartType: function(type) {
          this.chartType = type;
        },
        setShowTip: function(name) {
          if (name == 'sell') {
            this.showSellTip = true;
            var val = this.$refs.sellPrice.value;
            if (val) {
              this.$refs.sellMoney.value = (val * this.moneyPrice).toFixed(3);
            }
          } else if (name == 'buy') {
            this.showBuyTip = true;
            var val = this.$refs.buyPrice.value;
            if (val) {
              this.$refs.buyMoney.value = (val * this.moneyPrice).toFixed(3);
            }
          } else {
            this.showBuyTip = false;
            this.showSellTip = false;
          }
        },
        getCookie : function (name) {
          var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
          if(arr=document.cookie.match(reg)){
              return unescape(arr[2]);
          }else {
              return false;
          }
        },
        getPubKey: function () {
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getPubTag',
            success: function(res) {
              this.pubKey = res.datas.pubTag;
            }.bind(this)
          });
        },
        // 限制输入指定位小数
        priceInput: function(el) {
          var vm = this;
          var val = el.target.value;
          var model = el.target.dataset.model;
          var money = el.target.dataset.money;
          var fixed = el.target.dataset.fixed;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (!val) {
            if (money) {
              vm.$refs[money].value = '';
            }
            vm[model] = val;
            return
          } else if (!val.match(re)) {
            el.target.value = val.replace(/.$/, '');
          } else {
            // 如果需要关联法币输入
            if (money) {
              vm.$refs[money].value = (Number(val) * this.moneyPrice).toFixed(3);
            }
            vm[model] = val;
          }
        },
        //输入法币自动转换成虚拟币价格
        moneyInput: function(el) {
          var vm = this;
          var val = el.target.value;
          var model = el.target.dataset.model;
          var fixed = el.target.dataset.fixed;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (!val) {
            vm.$refs[model].value = '';
            vm[model] = '';
            return
          } else if (!val.match(re)) {
            el.target.value = val.replace(/.$/, '');
          } else {
            el.target.value = val;
            var modelFixed = vm.$refs[model].dataset.fixed;
            vm.$refs[model].value = (parseFloat(val)/this.moneyPrice).toFixed(modelFixed);
            vm[model] = Number(val)/this.moneyPrice;
          }
        },
        //获取图表的默认设置
        getChartSettings : function () {
            var chartSettings = this.getCookie('chartSettings');
            if(chartSettings){
                chartSettings = JSON.parse(chartSettings);
                this.period = chartSettings.charts.period;
                this.theme = chartSettings.theme.toLowerCase();
            }
        },
        // 获取市场成交记录
        getDealRecord: function() {
          var data = {
            market: this.market,
            pageSize: 15
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getDealRecord',
            data: data,
            success: function (res) {
              this.dealRecord = res.datas.slice(0, 18);
            }.bind(this)
          });
        },
        // 获取盘口数据
        getDishData: function() {
          var data = {
            market: this.market,
            length: this.depthShowSize
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getDishData',
            data: data,
            success: function (res) {
              this.currentPrice = res.datas.currentPrice;
              this.updateDepth(res.datas);
              this.ask = res.datas.asks;
              this.bid  = res.datas.bids;
            }.bind(this)
          });
        },
        // 获取图表的盘口数据
        getKlineDish: function() {
          var data = {
            market: this.market,
            length: 5
          };
          if (this.chartType === 'depth') {
            Methods.getJSONP({
              url: DOMAIN_TRADE + API_PREFIX + 'getKlineDish',
              data: data,
              success: function (res) {
                this.chartAsks = res.datas.asks;
                this.chartBids = res.datas.bids;
              }.bind(this)
            });
          }
        },
        // 获取币价汇率
        getPriceRate: function(callback) {
          Methods.getJSONP({
            url: DOMAIN_MAIN + API_PREFIX + 'getPricesAndRate',
            success: function (res) {
              var oriPrice = res.datas.prices[this.moneyType];
              if (res.datas.rate['USD_CNY']) {
                this.rate = res.datas.rate['USD_CNY'];
              }
              this.oriPiece = oriPrice;
              //this.moneyPrice = oriPrice/this.rate;
              if(typeof callback == 'function'){
                callback();
              }
            }.bind(this)
          });
        },
        //获取用户委托记录
        getEntrustRecord: function() {
          var data = {
            market: this.market,
            userId: this.sharedState.currentAccountId,
            pageSize: 5
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getEntrustRecord',
            data: data,
            success: function (res) {
              this.entrustRecord = res.datas.record;
            }.bind(this)
          });
        },
        cancelSafePwd: function() {
          this.showSafePwd = false;
          this.safePwd = '';
        },
        bindSetPrice: function () {
            var _this = this;
            $("#orderbook .table").on('click', '.row', function () {
                _this.setPrice($(this).find('.prices').text());
            });
            $("#orderbook .current-price").on('click', function () {
                _this.setPrice($(this).find('span').text());
            });
        },
        setPrice: function(price) {
          this.$refs.buyPrice.value = price;
          this.$refs.sellPrice.value = price;
          this.sellPrice = price;
          this.buyPrice = price;
        },
        setBuyPrice: function(price) {
          this.buyPrice = price;
        },
        setSellPrice: function(price) {
          this.sellPrice = price;
        },
        handleBuy: function() {
          if (this.buyPrice.toString().length && this.buyQuantity.toString().length) {
            //this.showSafePwd = true;
            this.isBuy = 1;
            this.handleEntrustSubmit();
          } else {
            JuaBox.showWrong("<%= LANG('请输入价格和数量') %>")
          }
        },
        handleSell: function() {
          if (this.sellPrice.toString().length && this.sellQuantity.toString().length) {
            //this.showSafePwd = true;
            this.isBuy = 0;
            this.handleEntrustSubmit();
          } else {
            JuaBox.showWrong("<%= LANG('请输入价格和数量') %>")
          }
        },
        // 提交委托
        handleEntrustSubmit: function() {
          var unitPrice = '';
          var triggerPrice = '';
          var number = '';
          if (this.isBuy === 1 && !this.isReal) {
            unitPrice = this.buyPrice;
            number = this.buyQuantity;
          } else if (this.isBuy === 1 && this.isReal) {
            triggerPrice = this.buyPrice;
            number = this.buyQuantity;
          } else if (this.isBuy === 0 && !this.isReal) {
            unitPrice = this.sellPrice;
            number = this.sellQuantity;
          } else if (this.isBuy === 0 && !this.isReal) {
            triggerPrice = this.sellPrice;
            number = this.sellQuantity;
          }
          var data = {
            //safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
            safePwd: this.safePwd,
            userId: this.sharedState.currentAccountId,
            market: this.market,
            isBuy: this.isBuy,
            isReal: this.isReal,
            unitPrice: unitPrice,
            number: number,
            triggerPrice: triggerPrice
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'doEntrust',
            data: data,
            success: function (res) {
              this.showSafePwd = false;
              this.buyPrice = '';
              this.$refs.buyPrice.value = '';
              this.$refs.sellPrice.value = '';
              this.$refs.sellQuantity.value = '';
              this.$refs.buyQuantity.value = '';
              this.sellPrice = '';
              this.safePwd = '';
              this.sellQuantity = '';
              this.buyQuantity = '';
              this.getEntrustRecord();
              JuaBox.showRight("<%= LANG('提交委托成功') %>");
            }.bind(this)
          });
        },
        getChartData: function() {
          var data = {
            market: this.market
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getChartData',
            data: data,
            success: function (res) {
            }.bind(this)
          });
        },
        handleEntrustCancel: function(id, isReal) {
          var data = {
            isReal: isReal,
            market: this.market,
            entrustId: id
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'doCancelEntrust',
            data: data,
            success: function (res) {
              JuaBox.showRight("<%= LANG('取消委托成功') %>");
              this.getEntrustRecord();
            }.bind(this)
          });
        },
        equalHeight: function() {
          var centerHeight = this.$refs.center.offsetHeight;
          this.$refs.deal.style.height = (centerHeight - 483) + 'px'
        },
        //盘口处理方法
        updateDepth:function(data){
          if(!data)return;
          this.maxAsksNum = 0;
          this.maxBidsNum = 0;
          //求卖单最大深度值
          for(var i = 0;i < data.asks.length; i++){
            if(parseFloat(data.asks[i][1]) > this.maxAsksNum){
              this.maxAsksNum = parseFloat(data.asks[i][1]);
            }
          }
          //求买单最大深度值
          for(var i = 0;i < data.bids.length; i++){
            if(parseFloat(data.bids[i][1]) > this.maxBidsNum){
              this.maxBidsNum = parseFloat(data.bids[i][1]);
            }
          }
          if(this.lastDepth == ''){
            this.lastDepth={};
            this.lastDepth.asks=data.asks;
            this.lastDepth.bids=data.bids;
            this.depthInit(this.lastDepth.asks, $("#asks .table"));
            this.depthInit(this.lastDepth.bids, $("#bids .table"));
          }else{
            var parentAsks=$("#asks .table");
            parentAsks.find("div.remove").remove();
            parentAsks.find("div.add").removeClass("add");
            var newasks=data.asks;
            var oldasks=this.lastDepth.asks.reverse();
            this.asksAndBids(newasks.slice(0),oldasks,parentAsks,this.maxAsksNum);
            this.lastDepth.asks=newasks;
            //console.log(newasks.slice(0),oldasks);

            var parentBids=$("#bids .table");
            parentBids.find("div.remove").remove();
            parentBids.find("div.add").removeClass("add");
            var newbids=data.bids;
            var oldbids=this.lastDepth.bids;
            this.asksAndBids(newbids.slice(0),oldbids,parentBids,this.maxBidsNum);
            this.lastDepth.bids=newbids;
            //console.log(newbids.slice(0),oldbids);
          }
        },
        //初始化盘口
        depthInit:function(data,$obj){
          $obj.empty();
          //console.log(data);
          if(data && data.length>0){
            var lastInt,view="",maxDepthNum = 0;
            //求最大深度值
            for(var i = 0;i < data.length; i++){
              if(parseFloat(data[i][1]) > maxDepthNum){
                maxDepthNum = parseFloat(data[i][1]);
              }
            }
            for(var i = 0;i < data.length; i++){
              var arr = (data[i][0]+"").split(".");
              var prices = this.getPrice(arr,lastInt);
              lastInt=arr[0];
              arr=(data[i][1]+"").split(".");
              var amounts=this.getAmount(arr);
              var usd = parseFloat(data[i][0]) * this.moneyPrice;
              var depth = parseFloat(data[i][1]) / maxDepthNum * 100;
              view+="<div class='row'>";
              view+="<span class='prices'>"+prices[0]+"<g>."+prices[1]+"</g></span>";
              view+="<span class='usd'>"+usd.toFixed(3).split('.')[0]+"<g>."+usd.toFixed(3).split('.')[1]+"</span>";
              view+="<span class='amount'>"+amounts[0]+"<g>."+amounts[1]+"</g></span>";
              view+="<span class='depth'><i style='width:"+depth+"%'></i></span>";
              view+="</div>";
            }
            $obj.append(view);
            view=null;
            //绑定盘口点击事件
            this.bindSetPrice();
          }
        },
        //盘口动画效果
        asksAndBids:function(addasks,oldasks,tbDiv,maxDepth){
          for(var i=0;i<oldasks.length;i++){
            var isExist=false;
            for(var j=0;j<addasks.length;j++){
              if(oldasks[i][0]==addasks[j][0]){
                isExist=true;
                if(oldasks[i][1] != addasks[j][1]){
                    //console.log(oldasks , addasks);
                  var $amount=tbDiv.find("div:eq("+i+") .amount");
                  var $depth=tbDiv.find("div:eq("+i+") .depth i");
                  var amounts=this.getAmount((addasks[j][1]+"").split("."));
                  var depth = (parseFloat(addasks[j][1]) / maxDepth * 100) + '%';
                  $amount.addClass(oldasks[i][1]>addasks[j][1]?"red":"green");
                  $depth.css("width", depth);
                  setTimeout((function($amount,amounts){
                    return function(){
                      $amount.html(amounts[0]+"<g>."+amounts[1]+"</g>");
                      $amount.removeClass("red").removeClass("green");
                      $amount=null;
                      amounts=null;
                    };
                  })($amount,amounts), 500);
                }
                addasks.splice(j,1);
                break;
              }
            }
            if(!isExist){
              tbDiv.find("div:eq("+i+")").addClass("remove");
              oldasks[i][2]=-1;//标识该数据对应div被移除
            }
          }
          for(var j=0;j<oldasks.length;j++){
            for(var i=0;i<addasks.length;i++){
              if(addasks[i][0]>oldasks[j][0]){
                var arr=(addasks[i][1]+"").split(".");
                var prices = addasks[i][0];
                var amounts=this.getAmount(arr);
                var usd = parseFloat(addasks[i][0]) * this.moneyPrice;
                var depth = parseFloat(addasks[i][1]) / maxDepth * 100;
                tbDiv.find("div:eq("+j+")").before("<div class='row add'>" +
                    "<span class='prices'></span> " +
                    "<span class='usd'>"+usd.toFixed(3)+"</span> " +
                    "<span class='amount'>"+amounts[0]+"<g>."+amounts[1]+"</g></span>" +
                    "<span class='depth'><i style='width:"+depth+"%'></i></span>" +
                    "</div>");
                oldasks.splice(j,0,addasks[i]);
                addasks.splice(i,1);
                break;
              }
            }
          }
          var totalDiv="";
          for(var i=0;i<addasks.length;i++){
            oldasks.push(addasks[i]);
            var arr=(addasks[i][1]+"").split(".");
            var amounts=this.getAmount(arr);
            var prices = addasks[i][0];
            var usd = parseFloat(addasks[i][0]) * this.moneyPrice;
            var depth = parseFloat(addasks[i][1]) / maxDepth * 100;
            totalDiv+="<div class='row add'>" +
                "<span class='prices'></span>" +
                "<span class='usd'>"+usd.toFixed(3)+"</span> " +
                "<span class='amount'>"+amounts[0]+"<g>."+amounts[1]+"</g></span>" +
                "<span class='depth'><i style='width:"+depth+"%'></i></span>" +
                "</div>";
          }
          if(totalDiv.length>0){
            tbDiv.append(totalDiv);
          }
          totalDiv=null;

          var lastInt;
          for(var i=0;i<oldasks.length;i++){
            var $div=tbDiv.find("div:eq("+i+")");
            if(!(oldasks[i].length>=3 && oldasks[i][2]==-1)){
              var arr=(oldasks[i][0]+"").split(".");
              var prices=this.getPrice(arr,lastInt);
              lastInt=arr[0];
              $div.find(".prices").html(prices[0]+"<g>."+prices[1]+"</g>");
            }
          }
          addasks=null;
          oldasks=null;
          tbDiv.find("div.add").slideDown(800);
          setTimeout((function($remove,$add){
            return function(){
              $remove.slideUp(500,function(){
                $(this).remove();
              });
              $add.removeClass("add");
            };
          })(tbDiv.find("div.remove"),tbDiv.find("div.add")), 1000);
        },
        getAsks:function(array,len){
          if(array && array.length>len){
            array.splice(0,array.length-len);
          }
          return array;
        },
        getBids:function(array,len){
          if(array && array.length>len){
            array.splice(len,array.length-1);
          }
          return array;
        },
        getPrice:function(arr,lastInt){
          if(arr[1] == undefined){
            arr[1] = 0;
          }
          var arrStr = arr[0] + "." + arr[1];
          arrStr = Methods.fixNumber(parseFloat(arrStr),6);
          arrStr = arrStr.split(".");

          return [arrStr[0],arrStr[1]];
        },
        getAmount:function(arr){
          if(arr[1] == undefined){
            arr[1] = 0;
          }
          var arrStr = arr[0] + "." + arr[1];
          arrStr = Methods.fixNumber(parseFloat(arrStr),3);
          var	arrStr = arrStr.split(".");

          return [arrStr[0],arrStr[1]];
        },
        handleClickOutsideTip: function (e) {
          var sell = this.$refs.sell;
          var buy = this.$refs.buy;
          if (!sell.contains(e.target)) {
            this.showSellTip = false;
          }
          if (!buy.contains(e.target)) {
            this.showBuyTip = false;
          }
        }
      },
      created: function() {
        this.getPriceRate(this.getDishData);
        this.getChartSettings();
        this.getPubKey();
        this.getDealRecord();
        this.getEntrustRecord();
      },
      mounted: function () {
        //this.equalHeight();
        //setInterval(this.getKlineDish, 2000);
        setInterval(this.getDishData, 2000);
        setInterval(this.getEntrustRecord, 2000);
        setInterval(this.getDealRecord, 2000);
        setInterval(this.getPriceRate, 30000);
        //this.getChartData();
        document.addEventListener('click', this.handleClickOutsideTip, true);
      },
      watch: {
        currentPrice: function(newVal, oldVal) {
          this.priceTrend = (newVal > oldVal) ? 'up' : 'down';
        }
      },
      beforeDestroy: function() {
        document.removeEventListener('click', this.handleClickOutsideTip, true)
      }
    });
    function b(){
      t = parseInt(x.css('top'));
      y.css('top','32px');
      x.animate({top: t - 32 + 'px'},'slow');	//19为每个li的高度
      if(Math.abs(t) == h-32){ //19为每个li的高度
        y.animate({top:'0px'},'slow');
        z=x;
        x=y;
        y=z;
      }
      setTimeout(b,3000);//滚动间隔时间 现在是3秒
    }

    $(function() {

      function textroll(){
        objtop = parseInt(theobj.css('top'));
        copyobj.css('top','32px');
        theobj.animate({top: objtop - 32 + 'px'},'slow');	//32为每个li的高度
        if(Math.abs(objtop) == objheight-32){ //32为每个li的高度
          copyobj.animate({top:'0px'},'slow');
          zobj=theobj;
          theobj=copyobj;
          copyobj=zobj;
        }
      }
      $('.swap').html($('.news_li').html());
      theobj = $('.news_li');
      copyobj = $('.swap');
      theParent = theobj.parent();
      objheight = $('.news_li li').length * 32; //32为每个li的高度
      var theTime = setInterval(textroll,3000);//滚动间隔时间 现在是3秒
      theParent.mouseenter(function(){
        clearInterval(theTime);
        return;
      });
      theParent.mouseout(function(){
        theTime = setInterval(textroll,3000);
        return;
      })

    });
  });

</script>