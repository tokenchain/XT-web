
<div id="trade-sidebar" class="trade-sidebar" v-cloak="">

  <div class="ex-tab-choose">
    <a @click="changeMarketMain('user')" :class="{on: marketMain == 'user'}">自选</a>
    <a @click="changeMarketMain('usdx')" :class="{on: marketMain == 'usdx'}">USDX</a>
    <a @click="changeMarketMain('hsr')" :class="{on: marketMain == 'hsr'}">HSR</a>
    <a @click="changeMarketMain('qtum')" :class="{on: marketMain == 'qtum'}">QTUM</a>
  </div>

  <div v-cloak class="user-info box">
    <div @click="editUser(currentAccountInfo)" class="avatar">
      <div v-if="currentAccountInfo.userType == 3" class="gray-mask"><%= LANG('模拟') %></div>
      <img v-if="currentAccountInfo.photo" :src="'<%= STATIC %>/images/userhead/' + currentAccountInfo.photo">
      <img v-else src="<%= STATIC %>/images/userhead/default.jpg">
    </div>
    <div class="info">
      <div v-if="isLogin" @click="openAccountsList(true)" class="user-memo">
        <template v-if="currentAccountInfo.nickName != ''">{{currentAccountInfo.nickName}}</template>
        <template v-else>{{currentAccountInfo.userName}}</template>
        <div class="actions-group">
          <a class="button is-primary"><%= LANG('切换') %></a>
        </div>
      </div>
      <div v-if="!isLogin" class="user-memo">
        <a href="/login"><%= LANG('登录') %></a><%= LANG('或') %><a href="/register"><%= LANG('注册') %></a>
      </div>

      <div v-cloak class="total-asset" v-if="isLogin"   data-toggle="tooltip" data-placement="bottom" title="" data-original-title="<%= LANG('总资产折合为辅助货币') %>">
        <span class="int">{{selectedCurrency.symbol}}{{getNumberSplit(getMoneyDisplay(userAssets.userBtcNetTotal, 'btc'))[0]}}</span>
        <span class="decimal">{{getNumberSplit(getMoneyDisplay(userAssets.userBtcNetTotal, 'btc'))[1]}}</span>
      </div>
      <div v-cloak class="coin-dropdown">
        <div @click="openCurrencyList(true)" class="currency">
          <span><%= LANG('辅助显示货币') %></span>: <b v-cloak>{{selectedCurrency.name.toUpperCase()}}</b>
          <i class="iconfont icon-jiantou" ></i>
        </div>
        <transition v-cloak name="fadeInUp">
          <ul v-if="showCurrencyList" class="dropdown select-currency" v-cloak>
            <li v-for="coin in currencyList" @click="setCurrency(coin)"><i :class="'iconfont ' + coin.icon"></i>{{coin.name.toUpperCase()}}</li>
          </ul>
        </transition>
      </div>
    </div>

    <transition name="modal" v-cloak>
      <div v-if="showAccountsList" class="modal-mask select-account ">
        <ul v-cloak>
          <li  v-for="account in accountsList" @click="handleSelectSub(account)" :class="{current: account.id == currentAccountInfo.id}">
            <div class="avatar">
              <div v-if="account.userType == 3" class="gray-mask"><%= LANG('模拟') %></div>
              <img v-if="account.photo" :src="'<%= STATIC %>/images/userhead/' + account.photo">
              <img v-else src="<%= STATIC %>/images/userhead/default.jpg">
            </div>
            <div class="memo">
              <template v-if="account.nickName && account.nickName != ''">{{account.nickName}}</template>
              <template v-else>{{account.userName}}</template>
            </div>
          </li>
        </ul>
        <div class="button-group">
          <a href="/u"><i class="iconfont icon-home"></i> <%= LANG('管理账户') %></a>
        </div>
      </div>
    </transition>

    <div class="lever-info box" v-if="isLogin && marketMain == 'user'">
      <div class="lever-title">
        <div class="market-simple" :class="{'lever-on': currentAccountInfo.lever}">
          <span><%= LANG('精简') %></span>
          <div class="exx-slideselect">
            <input @click="toggleSimplify" :checked="isSimplify" type="checkbox"><label><i></i></label>
          </div>
        </div>
        <div class="lever-onoff" :class="{'lever-on': currentAccountInfo.lever}">
          <span><%= LANG('杠杆') %></span>
          <div class="exx-slideselect">
            <input @click="toggleLever(currentAccountId)" :checked="currentAccountInfo.lever" type="checkbox"><label><i></i></label>
          </div>
        </div>
      </div>
      <template v-if="currentAccountInfo.lever">
        <div class="remaining">
          <div class="r-hd">
            <span class="ld"><%= LANG('剩余额度') %></span>
            <span class="rd"><%= LANG('已使用') %></span>
          </div>
          <ul>
            <li v-for="(loan, coin) in userAssets.coinFundMap">
              <span class="ld">{{coin.toUpperCase()}}<b>{{ fixFloat((Number(loan.canLoan) - Number(loan.loanIn)), 8)}}</b></span>
              <span class="rd">{{loan.loanIn}}</span>
            </li>
          </ul>
        </div>

        <div class="level-risk">
          <span class="ld"><%= LANG('杠杆风险') %></span>
          <span class="rd">
              <b v-if="userAssets.repayLevel < 40" class="level-1"><%= LANG('低') %></b>
              <b v-if="userAssets.repayLevel >= 40 && userAssets.repayLevel < 70" class="level-2"><%= LANG('中') %></b>
              <b v-if="userAssets.repayLevel >= 70 && userAssets.repayLevel < 100" class="level-3"><%= LANG('高') %></b>
              <b v-if="userAssets.repayLevel == 100" class="level-3"><%= LANG('已平仓') %></b>
            </span>
        </div>

        <div class="level-evening-up">
          <span class="ld"><%= LANG('平仓价格') %></span>
          <span class="rd">{{selectedCurrency.symbol}}{{Number(currentAccountInfo.unwindPrice).toFixed(3)}}</span>
        </div>

      </template>
    </div>

  </div>





   <vue-scrollbar classes='markets-list' ref='marketsList' v-cloak>
    <!--page 1-->
    <div class="scroll-able marketlist-new">
      <template v-if="marketMain == 'user' && !isSimplify">
        <div v-for="(market, index) in reorderMarketsData" v-if="!isLogin || (isLogin && market.isVisible)" class="market-info box" :class="{'is-active': market.market == currentMarket}" :id="market.market">
          <div v-if="market.openTime > 0" class="gray-mask"><a :href="'/trade/'+ market.market"><%= LANG('暂未开放') %></a></div>
          <div @click="changeMarket(market.market)" class="line-chart-wrap" data-toggle="tooltip" data-placement="top" :title="market.market.toUpperCase().replace('_','/') + '<%= LANG('最近6小时行情走势') %>'">
            <inline-chart v-if="marketChartData[market.market]" type="line" :settings="getTransChartSettings(index)" :data="marketChartData[market.market]"></inline-chart>
          </div>
          <div class="price-info">
            <div class="price-col sell-col on">

              <div class="inner">

                <div class="marketname">
                  <span class="in-coin button is-small">{{marketFrom(market.market).toUpperCase()}}</span>
                  <div data-toggle="tooltip" data-placement="top" :title="'<%= LANG('当前可用') %>' + marketFrom(market.market).toUpperCase()" class="in-price">
                    <span class="int">{{getNumberSplit(getUseable(marketFrom(market.market)))[0]}}</span>
                    <span class="decimal">{{getNumberSplit(getUseable(marketFrom(market.market)))[1]}}</span>
                  </div>
                </div>

                <div v-if="lang == 'cn'" data-toggle="tooltip"
                     data-placement="top"
                     :title="'用指定比例或数量的可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)).toFixed(3) + ')卖出' + marketFrom(market.market).toUpperCase()"
                     @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>

                  <div class="type"><%= LANG('卖') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[1]}}</span>
                </div>
                <div v-else data-toggle="tooltip"
                     data-placement="top"
                     title="Quick sell"
                     @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>

                  <div class="type"><%= LANG('卖') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[1]}}</span>
                </div>

              </div>

            </div>
            <div class="proportion" :class="contrastPrice(market.buyOne,market.lastPrice[0])">
              <i class="iconfont icon-arrow-down-lg"></i>
              <div class="num">{{getMoneyDisplay(contrastPrice(market.buyOne,market.lastPrice)[1], marketTo(market.market)).toFixed(2)}}</div>

              <!--
              {{getMoneyDisplay(contrastPrice(market.buyOne,market.lastPrice)[1], marketTo(market.market))}}
              <div class="num">{{getNumberSplit(getMoneyDisplay((market.buyOne - market.lastPrice ), marketTo(market.market)), 3)[0]}}</div>
              -->
            </div>
            <div class="price-col buy-col ">
              <div class="inner">

                <div class="marketname">
                  <span class="out-coin button is-small">{{marketTo(market.market).toUpperCase()}}</span>
                  <div data-toggle="tooltip" data-placement="top" :title="'<%= LANG('当前可用') %>' + marketTo(market.market).toUpperCase()"  class="out-price">
                    <span class="int">{{getNumberSplit(getUseable(marketTo(market.market)))[0]}}</span>
                    <span class="decimal">{{getNumberSplit(getUseable(marketTo(market.market)))[1]}}</span>
                  </div>

                </div>

                <div v-if="lang == 'cn'"  data-toggle="tooltip"
                     data-placement="top"
                     :title="'用指定比例或数量的可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)).toFixed(3) + ')买入' + marketFrom(market.market).toUpperCase()"
                     @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <div class="type"><%= LANG('买') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[1]}}</span>
                </div>
                <div v-else  data-toggle="tooltip"
                     data-placement="top"
                     title="Quick buy"
                     @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <div class="type"><%= LANG('买') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[1]}}</span>
                </div>

              </div>
            </div>
          </div>
          <div class="percent-choose">
            <div class="hd">
              <div class="actions-group">
                <a @click="openManualTrans(market)" v-if="currentMarket != market.market" data-toggle="tooltip" data-placement="right" title="<%= LANG('手动编辑委托信息') %>"><i class="iconfont icon-bianji"></i></a>
                <a v-if="isLogin" @click="openEntrust(market.market)" data-toggle="tooltip" data-placement="right" title="<%= LANG('委托记录') %>"><i class="iconfont icon-icon-408004712"></i></a>
                <a v-if="isLogin" @click="openBill(marketFrom(market.market))" data-toggle="tooltip" data-placement="right" title="<%= LANG('账单') %>"><i class="iconfont icon-icon15-copy"></i></a>
                <a v-if="currentMarket == market.market" id="calculatorBtn"  data-toggle="tooltip" data-placement="right" title="<%= LANG('计算器') %>"><i class="iconfont icon-jisuanqi"></i></a>
              </div>
              <input data-toggle="tooltip" data-placement="top" title="<%= LANG('快速委托的比例或数量') %>" :ref="[market.market, 'percentInput'].join('_')" @input="percentInput" value="1%" class="percentnum">
              <a class="a-down"><i class="iconfont icon-expand_more"></i></a>
              <a @click="lockPercentInput" :data-market="market.market" :data-id="currentAccountId" class="a-locking" :class="{on: getMarketCookie(market.market)}" data-toggle="tooltip" data-placement="left" title="<%= LANG('锁定当前买卖比例') %>"><i class="iconfont icon-suo"></i></a>
            </div>
            <div class="bd">
              <ul>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用25%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '25%')" class="a-buy">买</a>
                  <span>25%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用25%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '25%')" class="a-sell">卖</a>
                </li>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用50%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '50%')" class="a-buy">买</a>
                  <span>50%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用50%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '50%')" class="a-sell">卖</a>
                </li>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用75%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '75%')" class="a-buy">买</a>
                  <span>75%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用75%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '75%')" class="a-sell">卖</a>
                </li>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用100%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '100%')" class="a-buy">买</a>
                  <span>100%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用100%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '100%')" class="a-sell">卖</a>
                </li>
              </ul>

            </div>
          </div>
          <div class="entrust-form">
            <div class="inner">
              <div class="field">
                <label class="label"><%= LANG('价格')%>({{selectedCurrency.name.toUpperCase()}})</label>
                <div class="control">
                  <input class="priceInput" @input="priceInput" data-ori="" value="" type="text" />
                </div>
                <div class="btn-edit">
                  <a class="add" @click="stepPrice('add', market)"><i class="iconfont icon-expand_less"></i></a>
                  <a class="reduce" @click="stepPrice('reduce', market)"><i class="iconfont icon-expand_more"></i></a>
                </div>
              </div>
              <div class="field">
                <label class="label"><%= LANG('数量') %>({{coinType.toUpperCase()}})</label>
                <div class="control">
                  <input class="numberInput" @input="numberInput" value="" type="text" :data-useable="getUseable(marketFrom(market.market))" />
                </div>
                <div class="btn-edit">
                  <a class="add" @click="stepNumber('add', market)"><i class="iconfont icon-expand_less"></i></a>
                  <a class="reduce" @click="stepNumber('reduce', market)"><i class="iconfont icon-expand_more"></i></a>
                </div>
              </div>
              <div class="field button-field">
                <div data-toggle="tooltip" data-placement="top" title="<%= LANG('以输入的价格和数量买入') %>" @click="handleNormalTrans(1, market.market)" class="button buy disabled">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <%= LANG('买入') %>
                </div>
                <div data-toggle="tooltip" data-placement="top" title="<%= LANG('以输入的价格和数量卖出') %>" @click="handleNormalTrans(0, market.market)" class="button sell disabled" :class="{disabled: lockTrade}">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <%= LANG('卖出') %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </template>

      <template v-if="marketMain == 'user' && isSimplify">
        <div v-for="(market, index) in reorderMarketsData" v-if="!isLogin || (isLogin && market.isVisible && market.market == currentMarket)" class="market-info box" :class="{'is-active': market.market == currentMarket}" :id="market.market">
          <div v-if="market.openTime > 0" class="gray-mask"><a :href="'/trade/'+ market.market"><%= LANG('暂未开放') %></a></div>
          <div @click="changeMarket(market.market)" class="line-chart-wrap" data-toggle="tooltip" data-placement="top" :title="market.market.toUpperCase().replace('_','/') + '<%= LANG('最近6小时行情走势') %>'">
            <inline-chart v-if="marketChartData[market.market]" type="line" :settings="getTransChartSettings(index)" :data="marketChartData[market.market]"></inline-chart>
          </div>
          <div class="price-info">
            <div class="price-col sell-col on">

              <div class="inner">

                <div class="marketname">
                  <span class="in-coin button is-small">{{marketFrom(market.market).toUpperCase()}}</span>
                  <div data-toggle="tooltip" data-placement="top" :title="'<%= LANG('当前可用') %>' + marketFrom(market.market).toUpperCase()" class="in-price">
                    <span class="int">{{getNumberSplit(getUseable(marketFrom(market.market)))[0]}}</span>
                    <span class="decimal">{{getNumberSplit(getUseable(marketFrom(market.market)))[1]}}</span>
                  </div>
                </div>

                <div v-if="lang == 'cn'" data-toggle="tooltip"
                     data-placement="top"
                     :title="'用指定比例或数量的可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)).toFixed(3) + ')卖出' + marketFrom(market.market).toUpperCase()"
                     @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>

                  <div class="type"><%= LANG('卖') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[1]}}</span>
                </div>
                <div v-else data-toggle="tooltip"
                     data-placement="top"
                     title="Quick sell"
                     @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>

                  <div class="type"><%= LANG('卖') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.buyOne, marketTo(market.market)))[1]}}</span>
                </div>

              </div>

            </div>
            <div class="proportion" :class="contrastPrice(market.buyOne,market.lastPrice[0])">
              <i class="iconfont icon-arrow-down-lg"></i>
              <div class="num">{{getMoneyDisplay(contrastPrice(market.buyOne,market.lastPrice)[1], marketTo(market.market)).toFixed(2)}}</div>

              <!--
              {{getMoneyDisplay(contrastPrice(market.buyOne,market.lastPrice)[1], marketTo(market.market))}}
              <div class="num">{{getNumberSplit(getMoneyDisplay((market.buyOne - market.lastPrice ), marketTo(market.market)), 3)[0]}}</div>
              -->
            </div>
            <div class="price-col buy-col ">
              <div class="inner">

                <div class="marketname">
                  <span class="out-coin button is-small">{{marketTo(market.market).toUpperCase()}}</span>
                  <div data-toggle="tooltip" data-placement="top" :title="'<%= LANG('当前可用') %>' + marketTo(market.market).toUpperCase()"  class="out-price">
                    <span class="int">{{getNumberSplit(getUseable(marketTo(market.market)))[0]}}</span>
                    <span class="decimal">{{getNumberSplit(getUseable(marketTo(market.market)))[1]}}</span>
                  </div>

                </div>

                <div v-if="lang == 'cn'"  data-toggle="tooltip"
                     data-placement="top"
                     :title="'用指定比例或数量的可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)).toFixed(3) + ')买入' + marketFrom(market.market).toUpperCase()"
                     @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <div class="type"><%= LANG('买') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[1]}}</span>
                </div>
                <div v-else  data-toggle="tooltip"
                     data-placement="top"
                     title="Quick buy"
                     @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)))"
                     class="price">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <div class="type"><%= LANG('买') %></div>
                  <span class="unit">{{selectedCurrency.symbol}}</span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[0]}}<span>{{getNumberSplit(getMoneyDisplay(market.sellOne, marketTo(market.market)))[1]}}</span>
                </div>

              </div>
            </div>
          </div>
          <div class="percent-choose">
            <div class="hd">
              <div class="actions-group">
                <a @click="openManualTrans(market)" v-if="currentMarket != market.market" data-toggle="tooltip" data-placement="right" title="<%= LANG('手动编辑委托信息') %>"><i class="iconfont icon-bianji"></i></a>
                <a v-if="isLogin" @click="openEntrust(market.market)" data-toggle="tooltip" data-placement="right" title="<%= LANG('委托记录') %>"><i class="iconfont icon-icon-408004712"></i></a>
                <a v-if="isLogin" @click="openBill(marketFrom(market.market))" data-toggle="tooltip" data-placement="right" title="<%= LANG('账单') %>"><i class="iconfont icon-icon15-copy"></i></a>
                <a v-if="currentMarket == market.market" id="calculatorBtn"  data-toggle="tooltip" data-placement="right" title="<%= LANG('计算器') %>"><i class="iconfont icon-jisuanqi"></i></a>
              </div>
              <input data-toggle="tooltip" data-placement="top" title="<%= LANG('快速委托的比例或数量') %>" :ref="[market.market, 'percentInput'].join('_')" @input="percentInput" value="1%" class="percentnum">
              <a class="a-down"><i class="iconfont icon-expand_more"></i></a>
              <a @click="lockPercentInput" :data-market="market.market" :data-id="currentAccountId" class="a-locking" :class="{on: getMarketCookie(market.market)}" data-toggle="tooltip" data-placement="left" title="<%= LANG('锁定当前买卖比例') %>"><i class="iconfont icon-suo"></i></a>
            </div>
            <div class="bd">
              <ul>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用25%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '25%')" class="a-buy">买</a>
                  <span>25%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用25%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '25%')" class="a-sell">卖</a>
                </li>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用50%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '50%')" class="a-buy">买</a>
                  <span>50%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用50%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '50%')" class="a-sell">卖</a>
                </li>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用75%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '75%')" class="a-buy">买</a>
                  <span>75%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用75%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '75%')" class="a-sell">卖</a>
                </li>
                <li>
                  <a data-toggle="tooltip" data-placement="right" :title="'用100%可用资金以卖一价(' + getMoneyDisplay(market.sellOne, marketTo(market.market)) + ')买入' + marketFrom(market.market)" @click="handleQuickTrans(1,market, market.sellOne, getUseable(marketTo(market.market)), '100%')" class="a-buy">买</a>
                  <span>100%</span>
                  <a data-toggle="tooltip" data-placement="top" :title="'用100%可用资金以买一价(' + getMoneyDisplay(market.buyOne, marketTo(market.market)) + ')卖出' + marketFrom(market.market)" @click="handleQuickTrans(0,market, market.buyOne, getUseable(marketFrom(market.market)), '100%')" class="a-sell">卖</a>
                </li>
              </ul>

            </div>
          </div>
          <div class="entrust-form">
            <div class="inner">
              <div class="field">
                <label class="label"><%= LANG('价格')%>({{selectedCurrency.name.toUpperCase()}})</label>
                <div class="control">
                  <input class="priceInput" @input="priceInput" data-ori="" value="" type="text" />
                </div>
                <div class="btn-edit">
                  <a class="add" @click="stepPrice('add', market)"><i class="iconfont icon-expand_less"></i></a>
                  <a class="reduce" @click="stepPrice('reduce', market)"><i class="iconfont icon-expand_more"></i></a>
                </div>
              </div>
              <div class="field">
                <label class="label"><%= LANG('数量') %>({{coinType.toUpperCase()}})</label>
                <div class="control">
                  <input class="numberInput" @input="numberInput" value="" type="text" :data-useable="getUseable(marketFrom(market.market))" />
                </div>
                <div class="btn-edit">
                  <a class="add" @click="stepNumber('add', market)"><i class="iconfont icon-expand_less"></i></a>
                  <a class="reduce" @click="stepNumber('reduce', market)"><i class="iconfont icon-expand_more"></i></a>
                </div>
              </div>
              <div class="field button-field">
                <div data-toggle="tooltip" data-placement="top" title="<%= LANG('以输入的价格和数量买入') %>" @click="handleNormalTrans(1, market.market)" class="button buy disabled">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <%= LANG('买入') %>
                </div>
                <div data-toggle="tooltip" data-placement="top" title="<%= LANG('以输入的价格和数量卖出') %>" @click="handleNormalTrans(0, market.market)" class="button sell disabled" :class="{disabled: lockTrade}">
                  <div class="t-animationload" onclick="$(this).addClass('active')">
                    <div class="t-preloader"></div>
                  </div>
                  <%= LANG('卖出') %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="ex-marketlist-s">
          <ul>
            <li v-for="market in reorderMarketsData" v-if="(!isLogin || (isLogin && market.isVisible)) && market.market != currentMarket">
              <i :class="'coin-icon-' + market.market.split('_')[0]"></i>
              <span class="market-name">{{market.market.toUpperCase().split('_').join('/')}}</span>
              <div class="price down">
                <span class="chg">%</span>
                <span class="bd-date">{{selectedCurrency.symbol}}{{getMoneyDisplay(market.lastPrice, 'btc').toFixed(3)}}</span>
              </div>
              <div class="btn-list">
                <a @click="openManualTrans(market)" data-toggle="tooltip" data-placement="top" data-original-title="交易">
                  <i class="iconfont icon-cf-c41"></i>
                </a>
                <a @click="editUserMarket('0', market.market)" data-toggle="tooltip" data-placement="top" data-original-title="删除">
                  <i class="iconfont icon-remove2"></i>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </template>

      <div class="ex-marketlist-s" v-if="marketMain == 'hsr'">
        <ul>
          <li @click="linkToMarket(market[0])" v-for="market in getMarketsForCoin('hsr')">
            <i :class="'coin-icon-' + market[0].split('_')[0]"></i>
            <span @click="linkToMarket(market[0])" class="market-name">{{market[0].toUpperCase().split('_').join('/')}}</span>
            <div @click="linkToMarket(market[0])" class="price" :class="market[1][8] >= 0 ? 'up' : 'down'">
              <span class="chg">{{ market[1][8] >= 0 ? '+' + market[1][8] : '' + market[1][8] }}%</span>
              <span class="bd-date">{{selectedCurrency.symbol}}{{getMoneyDisplay(market[1][0], market[0].split('_')[0])}}</span>
            </div>
            <div class="btn-list">
              <a  v-if="currentUserMarkets.indexOf(market[0]) != -1" @click="openManualTrans(marketInfo(market[0]))" data-toggle="tooltip" data-placement="top" data-original-title="交易">
                <i class="iconfont icon-cf-c41"></i>
              </a>
              <a @click="editUserMarket('1', market[0])" v-if="currentUserMarkets.indexOf(market[0]) == -1" data-toggle="tooltip" data-placement="top" data-original-title="添加">
                <i class="iconfont icon-unie62d"></i>
              </a>
              <a v-else @click="editUserMarket('0', market[0])" data-toggle="tooltip" data-placement="top" data-original-title="删除">
                <i class="iconfont icon-remove2"></i>
              </a>
            </div>
          </li>
        </ul>
      </div>

      <div class="ex-marketlist-s" v-if="marketMain == 'usdx'">
        <ul>
          <li v-for="market in getMarketsForCoin('usdx')">
            <i :class="'coin-icon-' + market[0].split('_')[0]"></i>
            <span @click="linkToMarket(market[0])" class="market-name">{{market[0].toUpperCase().split('_').join('/')}}</span>
            <div @click="linkToMarket(market[0])" class="price" :class="market[1][8] >= 0 ? 'up' : 'down'">
              <span class="chg">{{ market[1][8] >= 0 ? '+' + market[1][8] : '' + market[1][8] }}%</span>
              <span class="bd-date">{{selectedCurrency.symbol}}{{getMoneyDisplay(market[1][0], market[0].split('_')[0])}}</span>
            </div>
            <div class="btn-list">
              <a  v-if="currentUserMarkets.indexOf(market[0]) != -1" @click="openManualTrans(marketInfo(market[0]))" data-toggle="tooltip" data-placement="top" data-original-title="交易">
                <i class="iconfont icon-cf-c41"></i>
              </a>
              <a @click="editUserMarket('1', market[0])" v-if="currentUserMarkets.indexOf(market[0]) == -1" data-toggle="tooltip" data-placement="top" data-original-title="添加">
                <i class="iconfont icon-unie62d"></i>
              </a>
              <a v-else @click="editUserMarket('0', market[0])" data-toggle="tooltip" data-placement="top" data-original-title="删除">
                <i class="iconfont icon-remove2"></i>
              </a>
            </div>
          </li>
        </ul>
      </div>

      <div class="ex-marketlist-s" v-if="marketMain == 'qtum'">
        <ul>
          <li v-for="market in getMarketsForCoin('hsr')">
            <i :class="'coin-icon-' + market[0].split('_')[0]"></i>
            <span @click="linkToMarket(market[0])" class="market-name">{{market[0].toUpperCase().split('_').join('/')}}</span>
            <div @click="linkToMarket(market[0])" class="price" :class="market[1][8] >= 0 ? 'up' : 'down'">
              <span class="chg">{{ market[1][8] >= 0 ? '+' + market[1][8] : '' + market[1][8] }}%</span>
              <span class="bd-date">{{selectedCurrency.symbol}}{{getMoneyDisplay(market[1][0], market[0].split('_')[0])}}</span>
            </div>
            <div class="btn-list">
              <a  v-if="currentUserMarkets.indexOf(market[0]) != -1" @click="openManualTrans(marketInfo(market[0]))" data-toggle="tooltip" data-placement="top" data-original-title="交易">
                <i class="iconfont icon-cf-c41"></i>
              </a>
              <a @click="editUserMarket('1', market[0])" v-if="currentUserMarkets.indexOf(market[0]) == -1" data-toggle="tooltip" data-placement="top" data-original-title="添加">
                <i class="iconfont icon-unie62d"></i>
              </a>
              <a v-else @click="editUserMarket('0', market[0])" data-toggle="tooltip" data-placement="top" data-original-title="删除">
                <i class="iconfont icon-remove2"></i>
              </a>
            </div>
          </li>
        </ul>
      </div>

      <div v-if="isLogin && !currentAccountInfo.lever" class="add-market box">
        <a @click="openMarket" class="">+</a>
      </div>

    </div>

</vue-scrollbar>






  <!--添加市场-->
  <modal v-cloak class="modal-add-market" :open="showModal == 'addMarket'"  @close="showModal = false" >
    <%-include("_addMarket.html")%>
  </modal>
  <!-- 账单 -->
  <modal v-cloak class="modal-bill" :open="showModal == 'bill'"  @close="showModal = false" >
    <bill :params="billParams" theme="dark" />
  </modal>
  <!-- 委托记录 -->
  <modal v-cloak class="modal-entrust" :open="showModal == 'entrust'"  @close="showModal = false" >
    <modal-entrust :params="entrustParams" />
  </modal>
  <!-- 手动委托 -->
  <modal v-cloak class="modal-trans" :open="showModal == 'manualTrans'"  @close="showModal = false" >
    <modal-trans :params="manualTransParams" />
  </modal>
  <!-- 修改账户信息 -->
  <modal v-cloak class="modal-user" :open="showModal == 'userAction'"  @close="showModal = false" >
    <user-action :params="userParams" :done="userActionSuccess()" theme="dark" />
  </modal>
  <!-- 开启关闭杠杆 -->
  <modal v-cloak :open= "showModal == 'toggleUserAction'" @close="showModal = false">
    <toggle-user-action :params="userParams" :done="userActionSuccess()" theme="dark"/>
  </modal>

</div>
<%-include("../component/inline_chart.html")%>
<%-include("../component/json_table.html")%>
<%-include("../component/vue_scrollbar.html")%>
<%-include("../component/modal.html")%>

<%-include("../u/model/bill.html")%>
<%-include("../u/model/toggleUserAction.html")%>
<%-include("../u/model/userAction.html")%>
<%-include("_manualTrans.html")%>
<%-include("_entrust.html")%>

<script>
  require(['vue', 'common/methods'], function(Vue, Methods) {
    EXX.tradeSidebar = new Vue({
      el: "#trade-sidebar",
      data: function () {
        return {
          sharedState: store.state,
          lockTrade: false,
          lang: LAN,
          currentMarket: '<%= market %>',
          coinType: '<%= market.split("_")[0] %>',
          moneyType: '<%= market.split("_")[1] %>',
          isLogin: ISLOGIN ,
          isSimplify: false,
          loginUser: Methods.getLocalUserInfo(),
          marketMain: 'user',
          currentAccountId: '',
          allSubAccounts: [],
          usersInfo: [],
          assets: {},
          selectedMainCoin: '',
          showModal: false,
          showCurrencyList: false,
          showAccountsList: false,
          allMarketsData: [],
          //allMarketsPriceData: {"eth_hsr":[23.12,0,0,0,0,0,0,0,0.73],"eos_hsr":[13.78,0,0,0,0,0,0,0,-0.65],"hsr_usdx":[0,0,0,0,0,0],"deos_dhsr":[0,0,0,0,0,0],"etc_btc":[0.005843000,0.005801,0.005842,0.005843,0.005801,7.786,0.005801000,[[1506915480000,0.005801000],[1506937020000,0.005801000],[1506961920000,0.005843]],0.73],"deth_dhsr":[0,0,0,0,0,0],"dhsr_dusd":[0,0,0,0,0,0]},
          allMarketsPriceData: {},
          marketChartData: [],
          allMarketsInfo: [],
          billParams: {},
          userParams: {},
          entrustParams: {},
          manualTransParams: {},
          leverInfo: {

          },
          safePwd: '',
          inputPrice: '',
          inputNumber: '',
          currencyList: [
            {name: 'usd', icon: 'icon-meiyuan', symbol: '$',decimal : 2},
            {name: 'cny', icon: 'icon-cny', symbol: '¥',decimal : 2}
          ]
        }
      },
      computed: {
        selectedCurrency: function() {
          return this.currencyList.getObject('name', MONEY);
        },
        // 整理用户列表
        accountsList: function() {
          var accounts = [];
          if (this.usersInfo.length) {
            this.usersInfo.map(function(user){
              var label = user.nickName ? user.nickName : user.userName;
              var obj = {};
              obj.label = label;
              obj.value = user.userId;
              obj.id = user.userId;
              obj.userName = user.userName;
              obj.userId = user.userId;
              obj.nickName= user.nickName;
              obj.photo = user.photo;
              obj.userType = user.userType;
              obj.isVirtual = user.isVirtual;
              obj.lever = user.lever;
              obj.isChildLogin = user.isChildLogin;
              obj.assistCoin = user.assistCoin;
              obj.unwindPrice = user.unwindPrice;
              accounts.push(obj);
            });
          }
          return accounts;
        },
        //把当前市场置顶
        reorderMarketsData: function() {
          var data = this.allMarketsData;
          var currentMarket = data.getObject('market', this.currentMarket);
          var index = data.indexOf(currentMarket);
          if (data.length && index != -1) {
            data.splice(index, 1);
            data.unshift(currentMarket);
          }
          return data;
        },
        currentUserMarkets: function() {
          var marketsData = this.allMarketsData || [];
          var markets = [];
          marketsData.map(function(market){
            if (market.isVisible) {
              markets.push(market.market);
            }
          });
          return markets;
        },
        marketCoin: function() {
          var mainCoin = [];
          var markets = [];
          var obj = {};
          var marketsInfo = this.allMarketsData;
          marketsInfo.map(function(market){
            markets.push(market.market.split('_'));
          });
          markets.map(function(item){
            obj[item[1]] = obj[item[1]] || [];
            obj[item[1]].push(item[0])
          });
          return obj;
        },
        currentAccountInfo: function() {
          return this.accountsList.getObject('userId', this.currentAccountId);
        },
        //用户资产合计
        userAssets: function() {
          var userInfo = this.assets;
          userInfo.userBtcNetTotal = 0;
          var assets = userInfo.coinFundMap || {};
          var coins = Object.keys(assets);
          coins.map(function(coin){
            var coinObj = assets[coin];
            var btcPrice = this.moneyPrice('btc', coin);
            assets[coin].btcNetTotal = (coinObj.total - coinObj.loanIn) * btcPrice;
            userInfo.userBtcNetTotal += Number((coinObj.total - coinObj.loanIn) * btcPrice);
          }.bind(this));
          return userInfo;
        },
        canEntrust: function() {
          var res = false;
          if (this.loginUser && this.inputPrice != '' && this.inputNumber != '') {
            res = true;
          }
          return res;
        }
      },
      methods: {
        fixFloat : function (value,unit) {
            return Methods.fixFloat(value, unit);
        },
        fixNumber : function (value,unit) {
            return Methods.fixNumber(value, unit);
        },
        //截取数字
        getNumberSplit: function(num, length) {
          var maxLength = length || 8;
          var int = num ? num.toString().split('.')[0] : '0';
          var decimal = num ? num.toString().split('.')[1] : '0';
          var decLength = int.length > 8 ? 0 : 8 - int.length;
          //var newDecimal = decimal.slice(0, decLength);
          //统一显示三位小数
          var newDecimal = decimal ? decimal.slice(0, 3) : '';
          if (newDecimal != "" ) {
            newDecimal = '.' + newDecimal;
          }
          return [int, newDecimal];
        },
        //比较两个价格
        contrastPrice: function(num1, num2) {
          //console.log([num1, num2].join("/"));
          var diff, status;
          num1 = Number(num1);
          num2 = Number(num2);
          if (num1 > num2) {
            diff = num1 - num2;
            status = 'up'
          } else if (num1 > num2) {
            diff = 0;
            status = 'eq'
          } else {
            diff = num2 - num1;
            status = 'down'
          }
          //console.log([status, diff].join('/'));
          return [status, diff];
        },
        linkToMarket: function(market) {
          window.location.replace('/trade/' + market);
        },
        moneyPrice: function(money, coin){
          var money = money || 'usd';
          return Number(this.sharedState.allPriceRate[money][coin] ? this.sharedState.allPriceRate[money][coin] : 0)
        },
        // 根据市场名取得对应市场信息
        marketInfo: function(market) {
          var markets = this.allMarketsData;
          var fMarkets = markets.filter(function(m){
            return m.market == market
          });
          return fMarkets.length ? fMarkets[0] : {};
        },
        openModal: function(name){
          this.showModal = name;
        },
        openMarket: function() {
          this.selectedMainCoin = Object.keys(this.marketCoin)[0];
          this.showModal = 'addMarket';
        },
        openBill: function(coin) {
          this.billParams = {
            userId: this.currentAccountId,
            coin: coin
          };
          this.showModal = 'bill';
        },
        openEntrust: function(market) {
          this.entrustParams = {
            market: market,
            userId: this.currentAccountId
          };
          this.showModal = 'entrust';
        },
        editUser: function(user) {
          if (!this.isLogin) {
            return
          }
          this.userParams = {
            optType: 3,
            userId: user.userId,
            account: user
          };
          this.showModal = 'userAction';
        },
        userActionSuccess: function() {
          return function() {
            this.getUsersInfo();
            this.showModal = false;
          }.bind(this)
        },
        openManualTrans: function(market) {
          this.manualTransParams = {
            market: market,
            assets : this.assets,
            userId: this.currentAccountId
          };
          this.showModal = 'manualTrans';
        },
        changeMarketMain: function(coin) {
          this.marketMain = coin
        },
        toggleSimplify: function() {
          this.isSimplify = !this.isSimplify;
          Methods.setCookie(ENV+'_isSimplify', this.isSimplify)
        },
        toggleLever: function(userId) {
          if (this.currentAccountInfo.userType == 1) {
            JuaBox.info("<%= LANG('主账号不能开启杠杆，请切换到子账号再执行此操作') %>")
            return
          }
          this.userParams = {
            optType: 5,
            userId: userId,
            account: this.currentAccountInfo
          };
          if (this.currentUserMarkets.length == 0) {
            JuaBox.info("<%= LANG('开启杠杆需要添加一个交易市场') %>");
            this.openMarket();
          } else if (this.currentUserMarkets.length > 2) {
            JuaBox.info("<%= LANG('开启杠杆只能应用于一个市场，请把多余的市场删除') %>");
            this.openMarket();
          } else {
            this.showModal = 'toggleUserAction';
          }
        },
        closeModal: function(name) {
          this.showModal = false;
        },
        getMarketCookie: function(market) {
          var accountId = this.currentAccountId;
          var keyName = [accountId, market, 'lock'].join('_');
          var val = Methods.getCookie(keyName);
          if (val == '') {
            val = false;
          }
          return val;
        },
        marketFrom: function(market) {
          return market ? market.split('_')[0] : ''
        },
        marketTo: function(market) {
          return market ? market.split('_')[1] : ''
        },
        getUseable: function(coin) {
          var coinAsset;
          if (this.assets.coinFundMap) {
            coinAsset = this.assets.coinFundMap[coin];
          }
          var useable = coinAsset ? coinAsset.available: 0;
          var canLoan = coinAsset ? coinAsset.canLoan: 0;
          if (this.currentAccountInfo.lever) {
            useable = Number(useable) + Number(canLoan);
          }
          return useable;
        },
        getMoneyDisplay: function(num, coin) {
          var allPriceRate = this.sharedState.allPriceRate;
          var price = allPriceRate[MONEY][coin];
          return price && num ? Methods.numMultiply(num, price) : 0;
        },
        openCurrencyList: function(boolean) {
          this.showCurrencyList = boolean;
        },
        openAccountsList: function(boolean) {
          if (boolean) {
            $('body').addClass('modal-on');
          } else {
            $('body').removeClass('modal-on');
          }
          this.showAccountsList = boolean;
        },
        getTransChartSettings: function(index) {
          var colors = [
            ['#58A065', 'rgba(67,144,234,0.08)'],
            ['#4390EB', 'rgba(67,144,234,0.08)'],
            ['#F7931A', 'rgba(247, 147, 26, 0.08)'],
            ['#F5D525', 'rgba(244,213,37,0.08)'],
            ['#5B646F', 'rgba(91,100,111,0.09)'],
            ['#0ACC9F', 'rgba(10,204,159,0.08)'],
            ['#6CA4EF', 'rgba(88,160,101,0.08)']
          ];
          var obj = {
            height: 50,
            width: 220,
            strokeWidth: 2,
            fill: 'transparent',
            stroke: colors[index][0]
          };
          return obj;
        },
        // 获取指定用户资产
        getAssets: function(userId) {
          if(!ISLOGIN){
              return false;
          }
          var data = {
            targetUserId: userId
          };
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getTargetUserAsset',
            data: data,
            success: function (res) {
              this.assets = res.datas.userFund;
            }.bind(this)
          });
        },
        // 获取所有用户信息
        getUsersInfo: function() {
          var data = {
          };
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getUserAssets',
            data: data,
            success: function(res) {
              this.usersInfo= res.datas.userFunds;
            }.bind(this)
          });
        },
        getAllMarketsInfo: function() {
          // Methods.getJSONP({
          //   url: DOMAIN_TRADE + API_PREFIX + 'allMarket',
          //   success: function (res) {
          //     this.allMarketsInfo = res.datas
          //   }.bind(this)
          // });
        },
        // 获取所有市场动态信息
        getAllMarketsData: function() {
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getAllMarket',
            success: function (res) {
              var result = res.datas ;
              for(var key in result){
                if(result[key].length < 7){
                  result[key][6] = 0;
                  result[key][7] = [];
                  result[key][7][0] = [];
                  result[key][8] = '0.00';
                }
              }
              this.allMarketsPriceData = result
            }.bind(this)
          });
        },
        // 过滤指定币种的市场
        getMarketsForCoin: function(coin) {
          var marketsData = this.allMarketsPriceData;
          var allMarkets = Object.keys(marketsData);
          var filterMarkets = [];
          if (allMarkets.length) {
            allMarkets.forEach(function(market){
              if (market.split('_')[1] == coin) {
                var arr = [market, marketsData[market]];
                filterMarkets.push(arr);
              }
            });
          }
          return filterMarkets;
        },
        //编辑用户市场
        editUserMarket: function(type, market) {
          var data = {
            isType: type,
            market: market,
            childId: this.sharedState.currentAccountId
          };
          Methods.ajax({
            url: DOMAIN_MAIN + API_PREFIX + 'doEditMarket',
            data: data,
            success: function (res) {
              this.getAllMarket();
              if(typeof callback == 'function'){
                callback();
              }
              $.toast({
                heading: "<%= LANG('修改用户市场信息成功') %>",
                text: "<%= LANG('修改用户市场信息成功') %>",
                showHideTransition: 'plain',
                icon: 'success'
              });
            }.bind(this)
          });
        },
        // 获取所有可用市场
        getAllMarket: function(callback) {
          var data = {
            childId: ISLOGIN  ? this.sharedState.currentAccountId : ''
          };
          Methods.ajax({
            url: DOMAIN_MAIN + API_PREFIX + 'getAllMarket',
            data: data,
            success: function (res) {
                if(!res.datas.userMarket){
                    return console.log('getAllMarket failed.')
                }
              this.allMarketsData = res.datas.userMarket;
              if(typeof callback == 'function'){
                callback();
              }
            }.bind(this)
          });
        },
        getChartData: function(market) {
          var data = {
            market: market,
            size: 24,
            assist : MONEY,
            type: '15min',
            //暂时用于标识本例请求
            note:market + '_miniline'
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'charts',
            data: data,
            success: function (res) {
              var arr = [];
              //容错处理
              if(!res.datas.data){
                  res.datas.data = []
              }
              if (res.datas.data) {
                arr = res.datas.data.map(function(item){
                  return item[4];
                });
              }
              var min = arr[0];
              for(var i = 0;i < arr.length; i++){
                if (arr[i] < min) {
                  min = arr[i]
                }
              }
              var arr2 = arr.map(function(item){
                return item - min;
              });
              var obj = this.marketChartData;
              obj[market] = arr2.toString();
              this.marketChartData = obj;
              this.$forceUpdate();
            }.bind(this)
          });
        },
        getMarketChartData: function() {
          if (this.allMarketsData && this.allMarketsData.length > 0) {
            this.allMarketsData.map(function (market) {
              this.getChartData(market.market);
            }.bind(this));
          }
        },
        // 获取所有子账户
        getSubAccounts: function() {
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getSubAccounts',
            success: function (res) {
              this.allSubAccounts = res.datas.accounts;
            }.bind(this)
          });
        },
        // 获取币价汇率
        getPriceRate: function(callback) {
          Methods.getJSONP({
            url: DOMAIN_MAIN + API_PREFIX + 'getPricesAndRate',
            success: function (res) {
              var oriPrice = res.datas.prices[this.moneyType];
              if (res.datas.rate['USD_CNY']) {
                this.rate = res.datas.rate['USD_CNY'];
              }
              this.oriPiece = oriPrice;
              //this.moneyPrice = oriPrice/this.rate;
              if(typeof callback == 'function'){
                callback();
              }
            }.bind(this)
          });
        },
        // 设置辅助币种
        setCurrency: function(coin) {
          this.sharedState.currency = coin;
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'editAssistCoin',
            data: {
              assistCoin : coin.name
            },
            success: function (res) {
              Methods.setCookie(ENV+'mname', coin.name);
              top.location.reload();
            }.bind(this)
          });

        },
        // 切换子账号
        handleSelectSub: function(user) {
          Methods.setCookie(ENV + 'currentAccountId', user.id);
          this.sharedState.currentAccountId = user.id;
          this.currentAccountId = user.id;
          this.getAssets(user.id);
          this.getAllMarket(this.getMarketChartData);
          this.updateMarketLocalInfo();
          EXX.tradeMain.getEntrustRecord();
        },
        changeMarket: function(market) {
          if (this.currentMarket != market) {
            window.location.replace('/trade/' + market);
          }
        },
        priceInput: function(el) {
          var $btn = $('#' + this.currentMarket + ' .button');
          var $priceInput = $('#' + this.currentMarket + ' .priceInput');
          var $numberInput = $('#' + this.currentMarket + ' .numberInput');
          if ($priceInput.val() != '' && $numberInput.val() != '' ) {
            $btn.removeClass('disabled');
          } else {
            $btn.addClass('disabled');
          }
          var val  = el.target.value;
          var allPriceRate = this.sharedState.allPriceRate;
          var price = allPriceRate[MONEY][this.marketTo(this.currentMarket)];
          var fixed = el.target.dataset.fixed || 6;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (re.test(val)) {
            var test = val/price;
            el.target.dataset.ori = parseFloat(val)/parseFloat(price).toFixed(6);
            //this.inputPrice = Number(val)/Number(price).toFixed(6);
          } else if (!re.test(val) && val != '') {
            $.toast({
              heading: "<%= LANG('非法输入') %>",
              text: "<%= LANG('输入格式有误') %>",
              showHideTransition: 'plain',
              icon: 'warning'
            });
            el.target.value = val.replace(/.$/, '');
          }
        },
        stepPrice: function(mode, market) {
          var $priceInput = $('#' + this.currentMarket + ' .priceInput');
          var $percentInput = $('#' + this.currentMarket + ' .percentnum');
          var allPriceRate = this.sharedState.allPriceRate;
          var priceRate = allPriceRate[MONEY][this.marketTo(this.currentMarket)];
          var percentVal = $percentInput.val();
          var $btn = $('#' + this.currentMarket + ' .button');

          $btn.removeClass('disabled');
          $priceInput.addClass('active-ani');
          setTimeout(function(){
            $priceInput.removeClass('active-ani');
          }, 800);

          var oriVal = Number($priceInput.val());
          oriVal = oriVal ? oriVal : Number(this.getMoneyDisplay(market.buyOne, 'btc'));
          var percent = /\d*%$/.test(percentVal) ? parseFloat(percentVal)/100 : 0.01;
          var price = 0;
          if (mode == 'add') {
            price = Number(oriVal + oriVal * percent);
          } else if (mode == 'reduce') {
            price = Number(oriVal - oriVal * percent);
          }
          $priceInput.attr('data-ori', (price/priceRate).toFixed(8));
          $priceInput.val(price.toFixed(3));
          //var price = $priceInput.val();
          //var number = $numberInput.val();
        },
        numberInput: function(el) {
          var $btn = $('#' + this.currentMarket + ' .button');
          var $priceInput = $('#' + this.currentMarket + ' .priceInput');
          var $numberInput = $('#' + this.currentMarket + ' .numberInput');
          if ($priceInput.val() != '' && $numberInput.val() != '' ) {
            $btn.removeClass('disabled');
          } else {
            $btn.addClass('disabled');
          }
          var val = el.target.value;
          var fixed = el.target.dataset.fixed || 6;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (re.test(val)) {
            this.inputNumber = el.target.value;
          } else if (!re.test(val) && val != '') {
            $.toast({
              heading: 'Warning',
              text: "<%= LANG('输入格式有误') %>",
              showHideTransition: 'plain',
              icon: 'warning'
            });
            el.target.value = val.replace(/.$/, '');
          }
        },
        stepNumber: function(mode) {
          var $btn = $('#' + this.currentMarket + ' .button');

          $btn.removeClass('disabled');
          var $numberInput = $('#' + this.currentMarket + ' .numberInput');
          var $percentInput = $('#' + this.currentMarket + ' .percentnum');
          var percentVal = $percentInput.val();

          $numberInput.addClass('active-ani');
          setTimeout(function(){
            $numberInput.removeClass('active-ani');
          }, 800);

          var oriVal = $numberInput.val();
          var value = Number(oriVal ? oriVal : $('#asks .row:last-child .amount').text());
          var percent = /\d*%$/.test(percentVal) ? parseFloat(percentVal)/100 : 0.01;
          var number = 0;
          if (mode == 'add') {
            number = oriVal == '' ? value : Number(value + value * percent);
          } else if (mode == 'reduce') {
            number = oriVal == '' ? value : Number(oriVal - oriVal * percent);
          }
          $numberInput.val(number.toFixed(6));
        },
        percentInput: function(el) {
          var val = el.target.value;
          var regString = '^\\d+(\\.\\d{0,2})?%?$';
          var re = new RegExp(regString);
          if (!re.test(val)) {
            el.target.value = val.replace(/.$/, '');
          }
        },
        lockPercentInput: function(el) {
          var target = el.target;
        },
        //获取暂存在cookie里的市场信息
        updateMarketLocalInfo: function() {
          if (this.allMarketsData && this.allMarketsData.length) {
            this.allMarketsData.map(function(market){
              var name = [market.market, 'percentInput'].join('_');
              var val = this.getMarketCookie(market.market);
              var el = this.$refs[name];
              if (val && el) {
                el.value = val;
              }
            }.bind(this))
          }
        },
        handleQuickTrans: function(isBuy, market, price, useable, num) {
          if (!ISLOGIN) {
            $.toast({
              heading: "<%= LANG('请先登录') %>",
              text: "<%= LANG('请先登录再进行交易') %>。",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }
          if(this.lockTrade){
            $.toast({
              heading: "<%= LANG('订单提交错误') %>",
              text: "<%= LANG('您有未完成的订单请求，请稍候再提交。') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            var typeDom = isBuy == 0 ? ' .sell-col' : ' .buy-col';
            $('#' + market.market + typeDom + ' .t-animationload').removeClass('active');
            return
          }
//          if (isBuy == 0 && $('.button.sell').hasClass('disabled')) {
//            $('.button.sell .t-animationload').removeClass('active');
//            return
//          }
//          if (isBuy == 1 && $('.button.buy').hasClass('disabled')) {
//            $('.button.buy .t-animationload').removeClass('active');
//            return
//          }
          var refName = [market.market, 'percentInput'].join('_');
          var number = num || this.$refs[refName][0].value;

          var reg = /(\d+\.?\d?)%$/;
          if (reg.test(number)) {
            if (isBuy == 0) {
              number = parseFloat(useable)*(parseFloat(number)/100);
            } else if (isBuy ==1) {
              number = parseFloat(price) === 0 ? parseFloat(useable)*(parseFloat(number)/100) : parseFloat(useable)*(parseFloat(number)/100)/parseFloat(price);
            }
          }

          useable = Number(useable);
          if (useable <= 0 ) {
            $.toast({
              heading: "<%= LANG('没有足够的资金') %>",
              text: "<%= LANG('没有足够的') %><b>" + (isBuy == 0 ? this.marketFrom(market.market) : this.marketTo(market.market)).toUpperCase() + "</b>，<%= LANG('你可以先充值或划账到此账户') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          } else if (number == 0) {
            $.toast({
              heading: "<%= LANG('订单提交错误') %>",
              text: "<%= LANG('请输入') %>" + (isBuy == 0 ? "<%= LANG('卖出') %>" : "<%= LANG('买入') %>") + "<%= LANG('数量') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          } else {
            this.handleEntrustSubmit(isBuy, market.market, price, number)
          }
        },
        handleNormalTrans: function(isBuy, market) {
          if (!ISLOGIN) {
            $.toast({
              heading: "<%= LANG('请先登录') %>",
              text: "<%= LANG('请先登录再进行交易') %>。",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }
          if (isBuy == 0 && $('#' + market + ' .button.sell.disabled').length) {
            $('.button .t-animationload').removeClass('active');
            return
          }
          if (isBuy == 1 && $('#' + market + ' .button.buy.disabled').length) {
            $('.button .t-animationload').removeClass('active');
            return
          }
          var price = $('#' + market + ' .priceInput').attr('data-ori');
          var number = $('#' + market + ' .numberInput').val();
          var useable = 0;
          if (isBuy == 0) {
            useable = this.getUseable(market.split('_')[0]);
          } else if (isBuy == 1) {
            useable = this.getUseable(market.split('_')[1]) / price;
          }

          number = Number(number);
          useable = Number(useable);

          if (price == '' || !number ) {
            $.toast({
              heading: "<%= LANG('输入错误') %>",
              text: "<%= LANG('请输入交易金额和数量') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }

          if(number > useable || useable == 0){
            $.toast({
              heading: "<%= LANG('没有足够的资金') %>",
              text: "<%= LANG('没有足够的') %><b>" + (isBuy == 0 ? this.marketFrom(market.market) : this.marketTo(market.market)).toUpperCase() + "</b>，<%= LANG('你可以先充值或划账到此账户') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            this.clearEntrustInput();
            $('.t-animationload').removeClass('active');
            return
          }
          this.handleEntrustSubmit(isBuy, market, price, number);
        },
        clearEntrustInput: function() {
          var market = this.currentMarket;
          var $Input = $('#' + market + ' .entrust-form input');
          $Input.val('');
          $Input.attr('data-ori', '');
        },
        // 提交委托
        handleEntrustSubmit: function(isBuy, market, price, number) {
          var $buyBtn = $('#' + market + ' .button.buy');
          var $sellBtn = $('#' + market + ' .button.sell');
          var $priceInput = $('#' + market + ' .priceInput');
          var $numberInput = $('#' + market + ' .numberInput');

          if (!ISLOGIN) {
            $.toast({
              heading: "<%= LANG('订单提交错误') %>",
              text: "<%= LANG('请先登录再进行交易') %>。",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }
          //请求锁 防止重复提交
          if(this.lockTrade){
              $.toast({
                  heading: "<%= LANG('订单提交错误') %>",
                  text: "<%= LANG('您有未完成的订单请求，请稍候再提交。') %>",
                  showHideTransition: 'fade',
                  icon: 'error'
              });
            $('.t-animationload').removeClass('active');
              return
          }
          $buyBtn.addClass('disabled');
          $sellBtn.addClass('disabled');
          var text = '';
          if (isBuy == 0) {
            text = price + "<%= LANG('价格') %>" + "<%= LANG('卖出') %>" + market.toUpperCase().split('_')[0] + number;
          } else if (isBuy == 1) {
            text = price + "<%= LANG('价格') %>" + "<%= LANG('买入') %>" + market.toUpperCase().split('_')[0] + number;
          }

          this.lockTrade = true ;
          var data = {
            //safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
            safePwd: this.safePwd,
            userId: this.sharedState.currentAccountId,
            market: market,
            isBuy: isBuy,
            isReal: false,
            unitPrice: price,
            number: number,
            triggerPrice: ''
          };
          if (this.currentAccountInfo.lever) {
            data["isLoan"] = 'true';
          }
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'doEntrust',
            data: data,
            success: function (res) {
              EXX.tradeMain.getEntrustRecord();
              this.getAssets(this.currentAccountId);
              //清除输入框内容
              this.clearEntrustInput();
              //解除请求锁定
              this.lockTrade = false ;
              $(".t-animationload").removeClass('active');
              $.toast({
                heading: "<%= LANG('定单已执行') %>",
                text: text,
                icon: 'success',
                loader: true,        // Change it to false to disable loader
                loaderBg: '#9EC600'  // To change the background
              });
              this.inputPrice = '';
              this.inputNumber = '';
              this.showModal = false;
            }.bind(this),
            error: function (res) {
              this.clearEntrustInput();
              //解除请求锁定
              this.lockTrade = false ;
              $(".t-animationload").removeClass('active');
              $.toast({
                heading: "<%= LANG('订单提交失败') %>",
                text: EXX.L(res.resMsg.message),
                showHideTransition: 'fade',
                icon: 'error'
              })
            }.bind(this)
          });
        },
        handleClickInPage: function() {
          this.showCurrencyList = false;
          this.openAccountsList(false);
        },
        calculateHeight: function() {
          var wHeight = window.innerHeight;
          var scrollEl = this.$refs.marketsList.$el;
          var height = wHeight - scrollEl.offsetTop - 80;
          //移动端下取消固定高度
          if(Methods.isMobile()){
              $('.markets-list').height("auto");
          }else{
              $('.markets-list').height(height);
          }
          //scrollEl.height = wHeight - scrollEl.offsetHeight;
        },
        bindPencentEvent : function () {
            function setCookie(name,value,days){
                var expires = "";
                if (days) {
                    var date = new Date();
                    date.setTime(date.getTime() + (days*24*60*60*1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + value + expires + ";domain=.exx.com; path=/";
            }
            $(function () {
                $(".percentnum").on('focus',function(){
                    if (!$(this).prop('disabled')) {
                        $(this).parents(".percent-choose").addClass("up").children(".bd").slideDown();
                    }
                });


                $(".icon-expand_more").on('click',function(){
                    if ($(this).parents(".percent-choose").find(".a-locking").hasClass('on')) {
                        $(this).parents(".percent-choose").removeClass("up").children(".bd").slideUp();
                    }else{
                        $(this).parents(".percent-choose").toggleClass("up").children(".bd").slideToggle();
                    }
                });

                $(".a-locking").on('click',function(){
                    var market = $(this).data('market');
                    var id = $(this).data('id');
                    var keyName = [id, market, 'lock'].join('_');
                    var $input = $(this).parents(".percent-choose").find(".percentnum");
                    var val = $input.val();
                    if ($(this).hasClass('on')) {
                        $(this).removeClass('on');
                        $input.prop('disabled', false);
                        setCookie(keyName, '');
                    } else {
                        $(this).addClass('on');
                        $input.prop('disabled', true);
                        setCookie(keyName, val);
                    }
                });

                $(".percent-choose .bd li span").on('click',function(){
                    var $input = $(this).parents(".percent-choose").find(".percentnum");
                    if(!$input.prop('disabled')){
                        $(this).parents(".percent-choose").find(".percentnum").val($(this).html());
                    }
                })

            });
        }
      },
      created: function() {
        if (ISLOGIN) {
          var currentAccountId = Methods.getCookie(ENV + 'currentAccountId');
          this.currentAccountId = currentAccountId ? currentAccountId : this.loginUser.userId;
          this.sharedState.currentAccountId = this.currentAccountId;
          //this.getSubAccounts();
          this.getUsersInfo();
          this.getAssets(this.currentAccountId);
        }
        var cookieSimplify = Methods.getCookie(ENV + '_isSimplify');
        this.isSimplify = cookieSimplify == 'true' ? true : false;
        this.getAllMarket(function(){
            this.getMarketChartData();
            this.updateMarketLocalInfo();
            //延迟处理才能绑定到事件
            setTimeout(this.bindPencentEvent ,1000)
        }.bind(this));
        this.getPriceRate();
        this.getAllMarketsInfo();
        // 默认打开标签页
        var initGmarket = ['usdx', 'hsr', 'qtum'];
        var market = "<%= market %>";
        if (initGmarket.indexOf(market.split('_')[1]) != -1) {
          this.marketMain = market.split('_')[1]
        }
        this.getAllMarketsData();
      },
      mounted: function() {
        //刷新提示内容
        setInterval(function () {
            $("[data-toggle='tooltip']").tooltip();
        },1000);
        setInterval(this.getAllMarket, 5000);
        setInterval(function(){this.getAssets(this.currentAccountId)}.bind(this), 5000);
        setInterval(this.getMarketChartData, 60000);
        this.calculateHeight();
        window.addEventListener('resize', this.calculateHeight);
        document.addEventListener('click', this.handleClickInPage, true);
      },
      beforeDestroy: function() {
        window.removeEventListener('resize', this.calculateHeight);
        document.removeEventListener('click', this.handleClickInPage, true)
      }
    })
  })

</script>
<script type="text/javascript" src="<%= STATIC %>/scripts/slider.js"></script>
