
<div id="trade-sidebar" class="trade-sidebar" v-cloak="">


  <div v-cloak class="user-info box" :class="currentExchangeMode == 1 ? 'real' : 'demo'">
    <template v-if="isMobile">
    <div class="avatar" v-if="currentMarket != 'null'">
      <div class="gray-mask">
        <img class="market-coin" :src="'<%= STATIC %>/images/activity/million/icon/million-marketicon-' + getRealCoinName(currentMarket.split('_')[0]) + '-y.png'" />
      </div>
    </div>
    <div class="info">
      <div class="user-memo" v-if="isLogin">
        <span id="s-nickname" :title="currentAccountInfo.nickName" v-if="currentAccountInfo.nickName != ''">{{textStrim(currentAccountInfo.nickName,7)}}<span v-if="currentAccountInfo.nickName && currentAccountInfo.nickName.length > 7">...</span></span>
        <span :title="currentAccountInfo.userName" v-else>{{textStrim(currentAccountInfo.userName, 7)}}<span v-if="currentAccountInfo.userName && currentAccountInfo.userName.length > 7">...</span></span>
        <!--<div class="actions-group">
          <a class="button is-primary"><%= LANG('切换') %></a>
        </div>-->
      </div>
      <div v-if="!isLogin" class="user-memo" style="margin-bottom: 15px;">
        <a href="/login"><%= LANG('登录') %></a><%= LANG('或') %><a href="/register"><%= LANG('注册') %></a>
      </div>

      <div v-cloak v-on:mouseover="showAssetDropDown = true" v-on:mouseleave="showAssetDropDown = false"  class="total-asset" v-if="isLogin">
        <span class="int">{{selectedCurrency.symbol}}{{getNumberSplit(getMoneyDisplay(userAssets.userBtcNetTotal, 'btc'))[0]}}</span>
        <span class="decimal">{{getNumberSplit(getMoneyDisplay(userAssets.userBtcNetTotal, 'btc'))[1]}}</span><i class="caret"></i>
        <asset-drop :user-asset="userAssets.coinFundMap" :show-drop="showAssetDropDown"></asset-drop>
      </div>
      <div v-cloak class="coin-dropdown">
        <div @click="openCurrencyList(true)" class="currency">
          <span><%= LANG('价格显示') %></span>: <b v-cloak>{{selectedCurrency.name}}</b>
          <i class="iconfont icon-jiantou" ></i>
        </div>
        <transition v-cloak name="fadeInUp">
          <ul v-if="showCurrencyList" class="dropdown select-currency" v-cloak>
            <li v-for="coin in currencyList" @click="setCurrency(coin)"><i :class="'iconfont ' + coin.icon"></i>{{coin.name}}</li>
          </ul>
        </transition>
      </div>
    </div>
    </template>



    <template v-if="!isMobile">
      <div class="avatar" v-if="currentMarket != 'null'">
        <div class="gray-mask">
          <img class="market-coin" :src="'<%= STATIC %>/images/activity/million/icon/million-marketicon-' + getRealCoinName(currentMarket.split('_')[0]) + '-y.png'" />
        </div>
      </div>
      <div class="info">

        <div v-if="currentMarket != 'null'" class="chart-box" style="margin-bottom: 5px; font-size:20px;">
          <span class="main-coin">{{getRealCoinName(currentMarket.split('_')[0]).toUpperCase()}}</span> / {{getRealCoinName(currentMarket.split('_')[1]).toUpperCase()}}
        </div>
        <div v-if="currentMarket == 'null'" class="chart-box" style="margin-bottom: 5px; font-size:24px;">
          <span v-if="currentExchangeMode == 0" class="main-coin"><%= LANG('模拟市场')%></span>
          <span v-else="" class="main-coin"><%= LANG('实币市场')%></span>
        </div>

        <div v-cloak class="coin-dropdown">
          <div @click="openCurrencyList(true)" class="currency">
            <span><%= LANG('价格显示') %></span>: <b v-cloak>{{selectedCurrency.name}}</b>
            <i class="iconfont icon-jiantou" ></i>
          </div>
          <transition v-cloak name="fadeInUp">
            <ul v-if="showCurrencyList" class="dropdown select-currency" v-cloak>
              <li v-for="coin in currencyList" @click="setCurrency(coin)"><i :class="'iconfont ' + coin.icon"></i>{{coin.name}}</li>
            </ul>
          </transition>
        </div>
      </div>
    </template>

<div class="chart-box" v-if="currentMarket != 'null' && isMobile">
    <div class="market-down" v-cloak="">
      <div class="market-down-show">
        <div class="market-down-hd">
          <div class="vue-init" v-cloak=""><span class="main-coin">{{getRealCoinName(currentMarket.split('_')[0]).toUpperCase()}}</span> / {{getRealCoinName(currentMarket.split('_')[1]).toUpperCase()}}</div>
        </div>
        <div class="market-down-bd">
          <ul>
            <li v-if="market.demoMode == currentExchangeModeBoolean" v-for="(market,key) in marketConfig"><a :href="'/trade/' + key"><span class="main-coin">{{getRealCoinName(key.split('_')[0]).toUpperCase()}}</span> / {{getRealCoinName(key.split('_')[1]).toUpperCase()}}</a></li>
          </ul>
        </div>
      </div>
      <div class="market-search" onclick="EXX.tradeSidebar.openMarket()" style="display: none">
        <a ><i class="iconfont icon-sousuo1"></i> </a>
      </div>
    </div>
</div>

    <div class="marketlist-new" v-if="isLogin && currentMarket != 'null'" v-cloak="">
      <div class="market-info is-active box" :class="[!currentMarketArray[10] ? 'not-open' : '', currentMarketArray[9] ? 'is-virtual' : '', 'market-' + currentMarket.split('_')[0]] " :id="currentMarket">

        <div class="price-w" style="height: 80px;">
          <div class="price-info" style="width: 100%;">
            <div class="price-col sell-col on">

              <div class="inner">
                <div class="marketname" style="display: block;float: none;" data-toggle="tooltip" data-placement="left" title="" :data-original-title="showMarketTip(marketFrom(currentMarket), currentMarketArray[9], currentMarketArray[10])">
                  <span class="in-coin button is-small" style="display: none">
                    {{getRealCoinName(marketFrom(currentMarket)).toUpperCase()}}
                  </span>
                  <span v-if="isLogin" class="asset-able" style="text-align: right;display: block;font-size: 14px;">
                    <span class="text-gray" style="float: left;font-size: 12px;">{{getRealCoinName(marketFrom(currentMarket)).toUpperCase()}}<%= LANG('余额')%>:</span>{{fixFloat(getUseable(marketFrom(currentMarket)), this.marketConfig[currentMarket].coinDecimal)}}
                  </span>
                </div>
              </div>
            </div>
            <div class="price-col buy-col ">
              <div class="inner">

                <div class="marketname"  style="display: block;float: none;" data-toggle="tooltip" data-placement="left" title="" :data-original-title="showMarketTip(marketTo(currentMarket), currentMarketArray[9], currentMarketArray[10])">
                  <span class="out-coin button is-small" style="display: none">
                    {{getRealCoinName(marketTo(currentMarket)).toUpperCase()}}
                  </span>
                  <span v-if="isLogin" class="asset-able" style="text-align: right;display: block;font-size: 14px;">
                    <span class="text-gray" style="float: left;font-size: 12px;">{{getRealCoinName(marketTo(currentMarket)).toUpperCase()}}<%= LANG('余额')%>:</span>{{fixFloat(getUseable(marketTo(currentMarket)), this.marketConfig[currentMarket].moneyDecimal)}}
                  </span>
                </div>

              </div>
            </div>
            <div class="price-col buy-col ">
              <div class="inner">

                <div class="marketname"  style="display: block;float: none;">
                  <span v-if="isLogin" class="asset-able" style="text-align: right;display: block;font-size: 14px;">
                    <span class="text-gray" style="float: left;font-size: 12px;"><%= LANG('可买')%>:</span>{{canBuyCoin}} {{getRealCoinName(marketFrom(currentMarket)).toUpperCase()}}
                  </span>
                </div>

              </div>
            </div>
          </div>

          <div class="price-right" style="margin-right: 10px; width:auto; position: absolute; right:0px; top:0; display: none;">
            <div class="price-range" style="visibility: hidden;margin-bottom: 10px;">
              <span :class="currentMarketArray[8] >= 0 ? 'up' : 'down'">{{ getMoneyDisplay(currentMarketArray[0], marketTo(currentMarket)) }}</span>
            </div>
            <div class="trading-volume">
              <span class="text-gray"><%= LANG('可买')%>:</span>
              <span style="color:#c7c7c7">{{canBuyCoin}} {{getRealCoinName(marketFrom(currentMarket)).toUpperCase()}}</span>
            </div>
          </div>

        </div>
        <div class="entrust-form">
          <div class="inner">
            <div class="field">
              <label class="label"><%= LANG('价格')%>({{showCurrentPriceType}})</label>
              <div class="control">
                <input class="priceInput" v-model="currentInputPrice" @input="priceInput" data-ori="" value="" type="text" />
              </div>
              <div class="btn-edit">
                <a class="add" @click="stepPrice('add', currentMarketObj)"><i class="iconfont icon-expand_less"></i></a>
                <a class="reduce" @click="stepPrice('reduce', currentMarketObj)"><i class="iconfont icon-expand_more"></i></a>
              </div>
              <p style="margin:5px 0 0; font-size: 12px; color:#999; padding-left:10px;"><%= LANG('实际委托价格：') %>{{currentInputConvertPrice}}{{getRealCoinName(moneyType).toUpperCase()}}</p>
            </div>
            <div class="field">
              <label class="label"><%= LANG('数量') %>({{getRealCoinName(coinType).toUpperCase()}})</label>
              <div class="control">
                <input class="numberInput" v-model="currentInputNumber" @input="numberInput" value="" type="text" :data-useable="getUseable(marketFrom(currentMarket))" />
              </div>
              <div class="btn-edit">
                <a class="add" @click="stepNumber('add', currentMarketObj)"><i class="iconfont icon-expand_less"></i></a>
                <a class="reduce" @click="stepNumber('reduce', currentMarketObj)"><i class="iconfont icon-expand_more"></i></a>
              </div>
            </div>
            <div class="field button-field">
              <div data-toggle="tooltip" data-placement="top" title="<%= LANG('以输入的价格和数量买入') %>" @click="handleNormalTrans(1, currentMarket)" class="button buy">
                <div class="t-animationload" onclick="$(this).addClass('active')">
                  <div class="t-preloader"></div>
                </div>
                <%= LANG('买入') %>
              </div>
              <div data-toggle="tooltip" data-placement="top" title="<%= LANG('以输入的价格和数量卖出') %>" @click="handleNormalTrans(0, currentMarket)" class="button sell">
                <div class="t-animationload" onclick="$(this).addClass('active')">
                  <div class="t-preloader"></div>
                </div>
                <%= LANG('卖出') %>
              </div>
            </div>
          </div>
        </div>

        <div class="percent-choose">
          <div class="hd">

            <div v-if="isLogin" class="lever-onoff pull-left" :class="{'lever-on': currentAccountInfo.lever}">
              <span><%= LANG('杠杆') %></span>
              <div class="exx-slideselect">
                <input @click="toggleLever(currentAccountId)" :checked="currentAccountInfo.lever" type="checkbox"><label><i></i></label>
              </div>
            </div>


            <input data-toggle="tooltip" data-placement="top" title="<%= LANG('快速委托的比例或数量') %>" :ref="[currentMarket, 'percentInput'].join('_')" @input="percentInput" value="1%" class="percentnum">
            <a v-if="isLogin && currentMarketArray[10]" class="a-down"><i class="iconfont icon-expand_more"></i></a>
            <div class="actions-group">
              <a v-if="isLogin" @click="openEntrust(currentMarket)" data-toggle="tooltip" data-placement="left" title="<%= LANG('委托记录') %>"><i class="iconfont icon-icon-408004712"></i></a>
              <a v-if="isLogin" @click="openBill(marketFrom(currentMarket))" data-toggle="tooltip" data-placement="left" title="<%= LANG('账单') %>"><i class="iconfont icon-icon15-copy"></i></a>
              <!--<a id="calculatorBtn"  data-toggle="tooltip" data-placement="left" title="<%= LANG('计算器') %>"><i class="iconfont icon-jisuanqi"></i></a>
              --><a v-if="isLogin" @click="openManualTrans(currentMarketObj,$event)" class="btn" data-toggle="tooltip" data-placement="left" title="<%= LANG('手动编辑委托信息') %>"><%= LANG('委托') %></a>
            </div>

          </div>
          <div class="bd">
            <ul>
              <li>
                <a data-toggle="tooltip" data-placement="right" :title="'用25%可用资金以卖一价买入' + marketFrom(currentMarket)" @click="handleQuickTrans(1,currentMarketObj, currentMarketArray[2], getUseable(marketTo(currentMarket)), '25%')" class="a-buy">买</a>
                <span>25%</span>
                <a data-toggle="tooltip" data-placement="top" :title="'用25%可用资金以买一价卖出' + marketFrom(currentMarket)" @click="handleQuickTrans(0,currentMarketObj, currentMarketArray[1], getUseable(marketFrom(currentMarket)), '25%')" class="a-sell">卖</a>
              </li>
              <li>
                <a data-toggle="tooltip" data-placement="right" :title="'用50%可用资金以卖一价买入' + marketFrom(currentMarket)" @click="handleQuickTrans(1,currentMarketObj, currentMarketArray[2], getUseable(marketTo(currentMarket)), '50%')" class="a-buy">买</a>
                <span>50%</span>
                <a data-toggle="tooltip" data-placement="top" :title="'用50%可用资金以买一价卖出' + marketFrom(currentMarket)" @click="handleQuickTrans(0,currentMarketObj, currentMarketArray[1], getUseable(marketFrom(currentMarket)), '50%')" class="a-sell">卖</a>
              </li>
              <li>
                <a data-toggle="tooltip" data-placement="right" :title="'用75%可用资金以卖一价买入' + marketFrom(currentMarket)" @click="handleQuickTrans(1,currentMarketObj, currentMarketArray[2], getUseable(marketTo(currentMarket)), '75%')" class="a-buy">买</a>
                <span>75%</span>
                <a data-toggle="tooltip" data-placement="top" :title="'用75%可用资金以买一价卖出' + marketFrom(currentMarket)" @click="handleQuickTrans(0,currentMarketObj, currentMarketArray[1], getUseable(marketFrom(currentMarket)), '75%')" class="a-sell">卖</a>
              </li>
              <li>
                <a data-toggle="tooltip" data-placement="right" :title="'用100%可用资金以卖一价买入' + marketFrom(currentMarket)" @click="handleQuickTrans(1,currentMarketObj, currentMarketArray[2], getUseable(marketTo(currentMarket)), '100%')" class="a-buy">买</a>
                <span>100%</span>
                <a data-toggle="tooltip" data-placement="top" :title="'用100%可用资金以买一价卖出' + marketFrom(currentMarket)" @click="handleQuickTrans(0,currentMarketObj, currentMarketArray[1], getUseable(marketFrom(currentMarket)), '100%')" class="a-sell">卖</a>
              </li>
            </ul>

          </div>
        </div>
      </div>



    </div>



    <transition name="modal" v-cloak>
      <div v-if="isLogin && showAccountsList" class="modal-mask select-account ">
        <div class="group-user clearfix" v-on:mouseover="showAccountsList = true" v-on:mouseleave="showAccountsList = false" v-cloak>
          <dl v-if="!isMock">
            <dt><%= LANG('真实账户交易')%></dt>
            <dd v-if="account.userType != 3"  v-for="account in accountsList" @click="handleSelectSub(account)" :class="{current: account.id == currentAccountInfo.id}">
              <div class="avatar">
                <img v-if="account.photo" :src="'<%= STATIC %>/images/userhead/' + account.photo">
                <img v-else src="<%= STATIC %>/images/userhead/default.jpg">
              </div>
              <div class="memo">
                <template v-if="account.nickName && account.nickName != ''">{{account.nickName}}</template>
                <template v-else>{{account.userName}}</template>
              </div>
            </dd>
          </dl>
          <dl v-if="isMock">
            <dt><%= LANG('模拟账户交易')%></dt>
            <dd v-if="account.userType == 3" v-for="account in accountsList" @click="handleSelectSub(account)" :class="{current: account.id == currentAccountInfo.id}">
              <div class="avatar">
                <div class="gray-mask"><%= LANG('模拟') %></div>
                <img v-if="account.photo" :src="'<%= STATIC %>/images/userhead/' + account.photo">
                <img v-else src="<%= STATIC %>/images/userhead/default.jpg">
              </div>
              <div class="memo">
                <template v-if="account.nickName && account.nickName != ''">{{account.nickName}}</template>
                <template v-else>{{account.userName}}</template>
              </div>
            </dd>
          </dl>
        </div>

        <div v-if="false" class="button-group">
          <a href="/u"><i class="iconfont icon-home"></i> <%= LANG('管理账户') %></a>
        </div>
      </div>
    </transition>

    <div class="lever-info box">
      <template v-if="currentAccountInfo.lever && currentMarket != 'null'">
        <div class="remaining">
          <div class="r-hd">
            <span class="ld"><%= LANG('剩余额度') %></span>
            <span class="rd"><%= LANG('已使用') %></span>
          </div>
          <ul>
            <li v-for="(loan, coin) in userAssets.coinFundMap" v-if="loan.show">
              <span class="ld">{{coin.toUpperCase()}}<b>{{ fixFloat((Number(loan.canLoan)), 3)}}</b></span>
              <span class="rd">{{fixFloat(loan.loanIn, 3)}}</span>
            </li>
          </ul>
        </div>

        <div class="level-risk">
          <span class="ld"><%= LANG('杠杆风险') %></span>
          <span class="rd">
              <b v-if="userAssets.repayLevel < 40" class="level-1"><%= LANG('低') %></b>
              <b v-if="userAssets.repayLevel >= 40 && userAssets.repayLevel < 70" class="level-2"><%= LANG('中') %></b>
              <b v-if="userAssets.repayLevel >= 70 && userAssets.repayLevel < 100" class="level-3"><%= LANG('高') %></b>
              <b v-if="userAssets.repayLevel == 100" class="level-3"><%= LANG('已平仓') %></b>
            </span>
        </div>

        <div class="level-evening-up">
          <span class="ld"><%= LANG('平仓价格') %></span>
          <span class="rd">{{selectedCurrency.symbol}}{{Number(currentAccountInfo.unwindPrice).toFixed(3)}}</span>
        </div>

      </template>
    </div>

  </div>

  <div class="ex-tab-choose clearfix" v-if="currentMarket == 'null' || (currentMarket != 'null' && !isMobile)" v-on:click.stop>
    <div class="market-simple pull-right">
      <div class="exx-slideselect">
        <input @click="toggleSimplify" :checked="isSimplify" type="checkbox"><label><i></i></label>
      </div>
    </div>
    <a v-if="currentExchangeMode == 0 && (Gmarket == 'user' || Gmarket == 'demo')" v-for="Gmarket in initGmarket" @click="changeMarketMain(Gmarket)" :class="{on: marketMain == Gmarket}">{{showMarketTab(Gmarket)}}</a>
    <a v-if="currentExchangeMode == 1 && (Gmarket == 'user' || Gmarket != 'demo')" v-for="Gmarket in initGmarket" @click="changeMarketMain(Gmarket)" :class="{on: marketMain == Gmarket}">{{showMarketTab(Gmarket)}}</a>
  </div>

   <vue-scrollbar classes='markets-list' ref='marketsList' v-cloak="" v-if="currentMarket == 'null' || (currentMarket != 'null' && !isMobile)">
    <!--page 1-->
    <div class="scroll-able marketlist-new">

      <div class="trade-tab" v-if="marketMain == gmarket" v-for="gmarket in initGmarket">

        <div :class="'market-info box ' + (currentMarket == market[0] ? 'active' : '') +''+ (market[1][9] ? ' is-virtual' : '') +''+ (!market[1][10] ? ' not-open' : '')" v-for="(market,index) in getMarketsForCoin(gmarket)">
          <div class="price-w" @click="linkToMarket(market[0])">
            <div class="price-info">
              <div class="price-col sell-col on">
                <div class="inner">
                  <div class="marketname" data-toggle="tooltip" data-placement="right" title="" :data-original-title="showMarketTip(market[0].split('_')[0], market[1][9], market[1][10])">
                    <span class="in-coin button is-small">{{getRealCoinName(market[0].split('_')[0]).toUpperCase() }}</span>
                  </div>
                </div>
              </div>
              <div class="price-col buy-col ">
                <div class="inner">
                  <div class="marketname" data-toggle="tooltip" data-placement="right" title="" :data-original-title="showMarketTip(market[0].split('_')[1], market[1][9], market[1][10])">
                    <span class="out-coin button is-small">{{getRealCoinName(market[0].split('_')[1]).toUpperCase() }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="price-now">
              <div data-toggle="tooltip" data-placement="top" title="<%= LANG('当前价格折合') %>" class="in-price">
                <span class="unit" v-if="MONEY != 'none'">{{selectedCurrency.symbol}}</span>
                <span class="int">{{getNumberSplit(getMoneyDisplay(market[1][0], market[0].split('_')[1]))[0]}}</span>
                <span class="decimal">{{getNumberSplit(getMoneyDisplay(market[1][0], market[0].split('_')[1]))[1]}}</span></span>
                <span class="unit" v-if="MONEY == 'none'">{{getRealCoinName(market[0].split('_')[1]).toUpperCase() }}</span>
              </div>
            </div>
            <div class="price-right-btnicon">
              <a><i class="iconfont icon-chevron_right"></i></a>
            </div>
            <div class="price-right">
              <div class="price-range">
                <span :class="market[1][8] >= 0 ? ' up' : ' down'">{{ market[1][8] >= 0 ? '+' + market[1][8] : '' + market[1][8] }}%</span>
              </div>
              <div class="trading-volume">
                <span>{{ parseInt(market[1][5]) }}</span>
              </div>
            </div>
          </div>
          <div @click="linkToMarket(market[0])" v-if="!isSimplify" data-toggle="tooltip" data-placement="top" title="" class="line-chart-wrap" data-original-title="<%= LANG('最近6小时行情走势')%>">
            <inline-chart type="line" :settings="getLineChartColor(index, market[1][10])" :data="getLineData(market[1][7])"></inline-chart>
          </div>
          <div v-if="!isSimplify" class="percent-choose">
            <div class="hd">
              <a class="market-icon"><i :class="'market-icon-' + market[0].split('_')[0]"></i></a>
              <a v-if="!market[1][10]" data-toggle="tooltip" data-placement="right" title="" class="a-locking" data-original-title="<%= LANG('该市场暂未开放')%>"><i class="iconfont icon-suo"></i></a>

              <div class="actions-group">
                <a v-if="isLogin" @click="openEntrust(market[0],$event)" data-toggle="tooltip" data-placement="left" title="<%= LANG('委托记录') %>"><i class="iconfont icon-icon-408004712"></i></a>
                <a v-if="isLogin" @click="openBill(marketFrom(market[0]),$event)" data-toggle="tooltip" data-placement="left" title="<%= LANG('账单') %>"><i class="iconfont icon-icon15-copy"></i></a>
                <a v-if="isLogin" @click="openManualTrans(convertArrayMarketToObj(market[0], market[1]),$event)" class="btn" data-toggle="tooltip" data-placement="left" title="<%= LANG('手动编辑委托信息') %>"><%= LANG('委托') %></a>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div @click="openMarket" v-if="isLogin && !currentAccountInfo.lever && marketMain == 'user'" class="add-market box">
        <a role="button" class=""><i class="iconfont" style="vertical-align: middle;">&#xe638;</i><%= LANG('管理我的市场')%></a>
      </div>

    </div>

</vue-scrollbar>

  <!--添加市场-->
  <modal v-cloak class="modal-add-market" :open="showModal == 'addMarket'"  @close="showModal = false" >
    <%-include("_addMarket.html")%>
  </modal>
  <!-- 账单 -->
  <modal v-cloak class="modal-bill" :open="showModal == 'bill'"  @close="showModal = false" >
    <bill :params="billParams" theme="dark" />
  </modal>
  <!-- 委托记录 -->
  <modal v-cloak class="modal-entrust" :open="showModal == 'entrust'"  @close="showModal = false" >
    <modal-entrust :params="entrustParams" />
  </modal>
  <!-- 手动委托 -->
  <modal v-cloak class="modal-trans" :open="showModal == 'manualTrans'"  @close="showModal = false" >
    <modal-trans :params="manualTransParams" />
  </modal>
  <!-- 修改账户信息 -->
  <modal v-cloak class="modal-user" :open="showModal == 'userAction'"  @close="showModal = false" >
    <user-action :params="userParams" :done="userActionSuccess()" theme="dark" />
  </modal>
  <!-- 开启关闭杠杆 -->
  <modal v-cloak :open= "showModal == 'toggleUserAction'" @close="showModal = false">
    <toggle-user-action :params="userParams" :done="userActionSuccess()" theme="dark"/>
  </modal>

</div>
<%-include("../component/inline_chart.html")%>
<%-include("../component/json_table.html")%>
<%-include("../component/vue_scrollbar.html")%>
<%-include("../component/modal.html")%>

<%-include("../u/model/bill.html")%>
<%-include("../u/model/toggleUserAction.html")%>
<%-include("../u/model/userAction.html")%>
<%-include("_manualTrans.html")%>
<%-include("_entrust.html")%>
<%-include("assetDropdown.html")%>

<script>

    var store = {
        state: {
            allPriceRate : {}
        }
    };
  require(['vue', 'common/methods'], function(Vue, Methods) {
    EXX.tradeSidebar = new Vue({
      el: "#trade-sidebar",
      data: function () {
        return {
          allPriceRate:'',
          sharedState: store.state,
          lockTrade: false,
          lang: LAN,
          currentExchangeMode : Methods.getCookie(ENV + 'ExchangeMode') ,
          currentExchangeModeBoolean : !Boolean(parseInt(Methods.getCookie(ENV + 'ExchangeMode'))),
          MONEY : MONEY,
          currentPriceType : MONEY == 'none' ? '<%= market.split("_")[1] %>' : MONEY,
          currentMarket: '<%= market %>',
          coinType: '<%= market.split("_")[0] %>',
          moneyType: '<%= market.split("_")[1] %>',
          currentInputPrice : '',
          currentInputConvertPrice : '',
          currentInputNumber : '',
          isLogin: ISLOGIN ,
          isMobile : Methods.isMobile(),
          isSimplify: true,
          isMock: false,
          loginUser: Methods.getLocalUserInfo(),
          initGmarket : ['user', 'btc', 'eth', 'hsr', 'qtum','demo'],
          //initGmarket : ['btc', 'usdx', 'hsr', 'qtum'],
          marketMain: this.isLogin ? 'user' : 'btc',
          currentAccountId: '',
          allSubAccounts: [],
          usersInfo: [],
          assets: {},
          selectedMainCoin: '',
          showModal: false,
          showCurrencyList: false,
          showAccountsList: false,
          showAssetDropDown : false,
          lastAssetTime : 0,
          userMarketsData: [],
          allMarketsData: {},
          marketChartData: [],
          allMarketsInfo: [],
          billParams: {},
          userParams: {},
          entrustParams: {},
          manualTransParams: {},
          leverInfo: {

          },
          safePwd: '',
          inputPrice: '',
          inputNumber: '',
          currencyList: [
            {key:'none', name: "<%= LANG('默认')%>", icon: '', symbol: '฿',decimal : 6},
            {key: 'usd', name: 'USD', icon: 'icon-meiyuan', symbol: '$',decimal : 3},
            {key: '<%= UNIT %>', name: '<%= LEGAL[UNIT].unit %>', icon: '', symbol: '<%= LEGAL[UNIT].note %>',decimal : '<%= LEGAL[UNIT].decimal %>'}
          ],
          currentMarketArray : [],
          currentMarketObj : {}
        }
      },
      watch : {
          currentInputPrice : function (newVal) {
              if(newVal == ''){
                  $('#' + this.currentMarket + ' .priceInput').attr('data-ori', '');
              }
              var price = $('#' + this.currentMarket + ' .priceInput').attr('data-ori');
              this.currentInputConvertPrice = price ? this.fixFloat(price, this.marketConfig[this.currentMarket].moneyDecimal) : "--" ;
          }
      },
      computed: {
        marketConfig : function(){
            return   EXX.tradeMain.marketConfig ;
        },
        selectedCurrency: function() {
          return this.currencyList.getObject('key', MONEY);
        },
        canBuyCoin : function () {
            if(!this.isLogin || !this.currentMarketObj || !this.currentMarketObj.sellOne){
                return '--';
            }else{
                var canbuy = Methods.numDivide(this.getUseable(this.marketTo(this.currentMarket)), this.currentMarketObj.sellOne);
                return Methods.fixFloat(canbuy,  this.marketConfig[this.currentMarket].moneyDecimal);
            }

        },
        canSellMoney : function () {
            if(!this.isLogin || !this.currentMarketObj || !this.currentMarketObj.buyOne){
                return '--';
            }else{
                var cansell = Methods.numMultiply(this.getUseable(this.marketFrom(this.currentMarket)), this.currentMarketObj.sellOne);
                return Methods.fixFloat(cansell, 3);
            }
        },
        showCurrentPriceType : function () {
            if(this.currentPriceType){
                return this.getRealCoinName(this.currentPriceType).toUpperCase();
            }
        },
        // 整理用户列表
        accountsList: function(type) {
            var userType = type || 'all';
          var accounts = [];
          if (this.usersInfo.length) {
            this.usersInfo.map(function(user){
              var label = user.nickName ? user.nickName : user.userName;
              var obj = {};
              obj.label = label;
              obj.value = user.userId;
              obj.id = user.userId;
              obj.userName = user.userName;
              obj.userId = user.userId;
              obj.nickName= user.nickName;
              obj.photo = user.photo;
              obj.userType = user.userType;
              obj.isVirtual = user.isVirtual;
              obj.lever = user.lever;
              obj.isChildLogin = user.isChildLogin;
              obj.assistCoin = user.assistCoin;
              obj.unwindPrice = user.unwindPrice;
              accounts.push(obj);
            });
          }
          return accounts;
        },
          // 模拟账户
          mockAccountsList: function() {
            var accounts = this.accountsList.filter(function(account){
                return account.userType == 3;
            })
              return accounts;
          },
          // 真实账户
          realAccountsList: function() {
              var accounts = this.accountsList.filter(function(account){
                  return account.userType != 3;
              })
              return accounts;
          },
        //把当前市场置顶
        reorderMarketsData: function() {
          var data = this.userMarketsData;
          var currentMarket = data.getObject('market', this.currentMarket);
          var index = data.indexOf(currentMarket);
          if (data.length && index != -1) {
            data.splice(index, 1);
            data.unshift(currentMarket);
          }
          return data;
        },
        currentUserMarkets: function() {
          var marketsData = this.userMarketsData || [];
          var markets = [];
          marketsData.map(function(market){
            if (market.isVisible) {
              markets.push(market.market);
            }
          });
          return markets;
        },
        marketCoin: function() {
          var mainCoin = [];
          var markets = Object.keys(this.allMarketsData);
          var obj = {};
//          var marketsInfo = this.allMarketsData;
//          marketsInfo.map(function(market){
//            markets.push(market.market.split('_'));
//          });
            var marketsArr = markets.map(function(market){
                return market.split('_');
            })
          marketsArr.map(function(item){
            obj[item[1]] = obj[item[1]] || [];
            obj[item[1]].push(item[0])
          });
          return obj;
        },
        currentAccountInfo: function() {
          return this.accountsList.getObject('userId', this.currentAccountId);
        },
        //用户资产合计
        userAssets: function() {
          var userInfo = this.assets;
          userInfo.userBtcNetTotal = 0;
          var assets = userInfo.coinFundMap || {};
          var coins = Object.keys(assets);
          coins.map(function(coin){
            var coinObj = assets[coin];
            var btcPrice = this.moneyPrice('btc', coin);
            assets[coin].btcNetTotal = (coinObj.total - coinObj.loanIn) * btcPrice;
            userInfo.userBtcNetTotal += Number((coinObj.total - coinObj.loanIn) * btcPrice);
          }.bind(this));
          return userInfo;
        },
        canEntrust: function() {
          var res = false;
          if (this.loginUser && this.inputPrice != '' && this.inputNumber != '') {
            res = true;
          }
          return res;
        }
      },
      methods: {
        fixFloat : function (value,unit) {
            return Methods.fixFloat(value, unit);
        },
        fixNumber : function (value,unit) {
            return Methods.fixNumber(value, unit);
        },
        textStrim: function(text, length) {
          if (text && length) {
              return text.substring(-1, length);
          } else {
              return text;
          }
        },
        showMarketTab : function (name) {
            if(name == 'user' && this.isLogin){
                return "<%= LANG('我的市场')%>";
            }else if(name == 'user' && !this.isLogin){
                return "";
            }else if(name == 'demo'){
                return "<%= LANG('模拟市场')%>";
            }else if(name == 'hot'){
                return "<%= LANG('热门')%>";
            }else {
                return name.toUpperCase();
            }
        },
        showMarketTip : function (coin, isReal, isOpen) {
          if(!isOpen){
              return "<%= LANG('该市场暂未开放')%>"
          }else{
              return this.getRealCoinName(coin).toUpperCase() + (isReal ? "<%= LANG('模拟交易币')%>" : "<%= LANG('真实交易币')%>");
          }
        },
        getLineData : function (array) {
            if(array.length > 0){
                var arr = [];
                //容错处理
                if(!array){
                    array = []
                }
                arr = array.map(function(item){
                    return item[1];
                });
                var min = arr[0];
                for(var i = 0;i < arr.length; i++){
                    if (arr[i] < min) {
                        min = arr[i]
                    }
                }
                var arr2 = arr.map(function(item){
                    return item - min;
                });
                return arr2.join(",");
            }else{
                return '';
            }
        },
        //去掉虚拟市场货币的D字符
        getRealCoinName : function (coin) {
            if(coin && coin.length > 3 && coin.substring(0,1) == 'd'){
                return coin.substring(1);
            }else{
                return coin;
            }
        },
        //截取数字
        getNumberSplit: function(num, length) {
          var maxLength = length || 8;
          var int = num ? num.toString().split('.')[0] : '0';
          var decimal = num ? num.toString().split('.')[1] : '0';
          //var decLength = decimal.length > 8 ? 8 : decimal.length;
          //var newDecimal = decimal.slice(0, decLength);
          var newDecimal = decimal ? decimal.slice(0, 8) : '';
          if (newDecimal != "" ) {
            newDecimal = '.' + newDecimal;
          }
          return [int, newDecimal];
        },
        //比较两个价格
        contrastPrice: function(num1, num2) {
          //console.log([num1, num2].join("/"));
          var diff, status;
          num1 = Number(num1);
          num2 = Number(num2);
          if (num1 > num2) {
            diff = num1 - num2;
            status = 'up'
          } else if (num1 > num2) {
            diff = 0;
            status = 'eq'
          } else {
            diff = num2 - num1;
            status = 'down'
          }
          //console.log([status, diff].join('/'));
          return [status, diff];
        },
        linkToMarket: function(market, tabName) {
            if(tabName){
                this.marketMain = tabName;
            }
            if(market == this.currentMarket){
                return false;
            }
            if(this.marketMain == 'user'){
                top.location.href = "/trade/" + market + '?self=1';
            }else{
                top.location.href = "/trade/" + market;
            }
        },
        moneyPrice: function(money, coin){
            if(money == 'btc' || money == 'usd' || money == '<%= UNIT %>'){
                return Number(this.sharedState.allPriceRate && this.sharedState.allPriceRate[money] && this.sharedState.allPriceRate[money][coin] ? this.sharedState.allPriceRate[money][coin] : 1)
            }else{
                return 1;
            }
        },
        // 根据市场名取得对应用户市场里的信息
        userMarketInfo: function(market) {
          var markets = this.userMarketsData;
          var fMarkets = markets.filter(function(m){
            return m.market == market
          });
          return fMarkets.length ? fMarkets[0] : {};
        },
          // 根据市场名取得对应所有市场里的信息
          marketInfo: function(market) {
              return this.allMarketsData['market']
          },
        openModal: function(name){
          this.showModal = name;
        },
        openMarket: function() {
          this.selectedMainCoin = Object.keys(this.marketCoin)[0];
          this.showModal = 'addMarket';
        },
        openBill: function(coin, event) {
          //若带入event参数
          if(event){
              //阻止事件
              event.cancelBubble = true;
          }
          this.billParams = {
            userId: this.currentAccountId,
            coin: coin
          };
          this.showModal = 'bill';
        },
        openEntrust: function(market, event) {
          //若带入event参数
          if(event){
              //阻止事件
              event.cancelBubble = true;
          }
          this.entrustParams = {
            market: market,
            userId: this.currentAccountId
          };
          this.showModal = 'entrust';
        },
        editUser: function(user) {
          if (!this.isLogin) {
            return
          }
          this.userParams = {
            optType: 3,
            userId: user.userId,
            account: user
          };
          this.showModal = 'userAction';
        },
        userActionSuccess: function() {
          return function() {
            this.getUsersInfo();
            this.showModal = false;
          }.bind(this)
        },
        openManualTrans: function(market, event) {
            //若带入event参数
            if(event){
                //阻止事件
                event.cancelBubble = true;
            }
            if(!market.isOpen) {
                return;
            }
          this.manualTransParams = {
            market: market,
            assets : this.assets,
            userId: this.currentAccountId
          };
          this.showModal = 'manualTrans';
        },
        gotoMarketMain: function(coin) {
            if(this.marketMain == 'user'){
                top.location.href = "/trade/" + this.currentUserMarkets[0] + '?self=1';
            }else{
                var market = this.getMarketsForCoin(coin);
                if(market.length == 0){
                    return false;
                }
                top.location.href = "/trade/" + market[0][0];
            }
        },
        changeMarketMain: function(coin) {
          this.marketMain = coin ;
          //重置滚动条到默认位置
          this.$refs.marketsList.top = 0;
          this.$nextTick(function(){
                this.bindPencentEvent();
            });
          try{
              EXX.tradeMain.$data.marketMain = coin ;
          }catch(err){}
        },
        toggleSimplify: function() {
          this.isSimplify = !this.isSimplify;
          //重置滚动条到默认位置
          this.$refs.marketsList.top = 0;
          Methods.setCookie(ENV+'_isSimplify', this.isSimplify)
        },
        toggleLever: function(userId) {
          if (this.currentAccountInfo.userType == 1) {
            JuaBox.info("<%= LANG('主账号不能开启杠杆，请切换到子账号再执行此操作') %>")
            return
          }
          this.userParams = {
            optType: 5,
            userId: userId,
              market: this.currentMarket,
            account: this.currentAccountInfo
          };
          if (this.currentUserMarkets.length == 0) {
            JuaBox.info("<%= LANG('开启杠杆需要添加一个交易市场') %>");
            this.openMarket();
          } else if (this.currentUserMarkets.length > 2) {
            JuaBox.info("<%= LANG('开启杠杆只能应用于一个市场，请把多余的市场删除') %>");
            this.openMarket();
          } else {
            this.showModal = 'toggleUserAction';
          }
        },
        closeModal: function(name) {
          this.showModal = false;
        },
        getMarketCookie: function(market) {
          var accountId = this.currentAccountId;
          var keyName = [accountId, market, 'lock'].join('_');
          var val = Methods.getCookie(keyName);
          if (val == '') {
            val = false;
          }
          return val;
        },
        marketFrom: function(market) {
          return market ? market.split('_')[0] : ''
        },
        marketTo: function(market) {
          return market ? market.split('_')[1] : ''
        },
        getUseable: function(coin) {
          if(!this.assets.coinFundMap || !this.assets.coinFundMap[coin]) {
              return 0 ;
          }else{
              var coinAsset = this.assets.coinFundMap[coin];
              var useable =  coinAsset.available || 0;
              var canLoan =  coinAsset.canLoan || 0;
              if (this.currentAccountInfo.lever) {
                  useable = Number(useable) + Number(canLoan);
              }
              return useable;
          }
        },
        getMoneyDisplay: function(num, coin) {
            if(this.MONEY == 'none'){
                return num;
            }else{
                var price = this.moneyPrice(this.currentPriceType, coin);
                return price && num ? Methods.fixFloat(Methods.numMultiply(num, price), this.selectedCurrency.decimal) : 0;
            }
        },
        openCurrencyList: function(boolean) {
          this.showCurrencyList = boolean;
        },
        openAccountsList: function(boolean) {
          if (boolean) {
            $('body').addClass('modal-on');
          } else {
            $('body').removeClass('modal-on');
          }
          this.showAccountsList = boolean;
        },
        getTransChartSettings: function(index, isClose) {
          var colors = [
            ['#58A065', 'rgba(67,144,234,0.08)'],
            ['#4390EB', 'rgba(67,144,234,0.08)'],
            ['#F7931A', 'rgba(247, 147, 26, 0.08)'],
            ['#F5D525', 'rgba(244,213,37,0.08)'],
            ['#5B646F', 'rgba(91,100,111,0.09)'],
            ['#0ACC9F', 'rgba(10,204,159,0.08)'],
            ['#6CA4EF', 'rgba(88,160,101,0.08)']
          ];
            var colorsClosed = [
                ['#666', 'rgba(88,160,101,0.08)']
            ];
          if(index >= colors.length){
              index = index % colors.length;
          }
          var obj = {
            height: 50,
            width: 220,
            strokeWidth: 2,
            fill: 'transparent',
            stroke: isClose ? colorsClosed[0][0] : colors[index][0]
          };
          return obj;
        },
        getLineChartColor: function(index, isClose) {
            var colors = [
                ['#58A065', 'rgba(67,144,234,0.08)'],
                ['#4390EB', 'rgba(67,144,234,0.08)'],
                ['#F7931A', 'rgba(247, 147, 26, 0.08)'],
                ['#F5D525', 'rgba(244,213,37,0.08)'],
                ['#5B646F', 'rgba(91,100,111,0.09)'],
                ['#0ACC9F', 'rgba(10,204,159,0.08)'],
                ['#6CA4EF', 'rgba(88,160,101,0.08)']
            ];

            var colorsClosed = [
                ['#666', 'rgba(67,144,234,0.08)']
            ];

            if(index >= colors.length){
                index = index % colors.length;
            }
            var obj = {
                fill: "",
                height: 50,
                stroke: isClose ? colors[index][0] : colorsClosed[0][0],
                strokeWidth: 2,
                width: 220
            }
            return obj;
        },
        // 获取指定用户资产
        getAssets: function(userId) {
          if(!ISLOGIN){
              return false;
          }
          var data = {
            targetUserId: userId,
            lastTime : this.lastAssetTime
          };
          // Methods.ajax({
          //   type: 'GET',
          //   url: DOMAIN_MAIN + API_PREFIX + 'getTargetUserAssetNew' + '-' + userId + '-' + this.lastAssetTime,
          //   data: data,
          //   success: function (res) {
          //       if(res.datas.userFund){
          //           this.assets = res.datas.userFund;
          //           this.lastAssetTime = res.datas.userFund.lastTime;
          //       }else{
          //           this.lastAssetTime = res.datas.lastTime;
          //       }
          //   }.bind(this)
          // });
        },
        // 获取所有用户信息
        getUsersInfo: function(callback) {
          var data = {
          };
          // Methods.ajax({
          //   type: 'GET',
          //   url: DOMAIN_MAIN + API_PREFIX + 'getMainUserAssetNew',
          //   data: data,
          //   success: function(res) {
          //     this.usersInfo= res.datas.userFunds;
          //     callback && callback();
          //   }.bind(this)
          // });
        },
        // 获取所有市场动态信息
        getAllMarketsData: function(callback) {
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getAllMarket',
            success: function (res) {
              var result = res.datas ;
              for(var key in result){
                if(result[key].length < 7){
                  result[key][6] = 0;
                  result[key][7] = [];
                  result[key][7][0] = [];
                  result[key][8] = '0.00';
                }
              }
              this.allMarketsData = result;
              //列表页不处理当前市场
              if(this.currentMarket != 'null'){
                  this.currentMarketArray = result[this.currentMarket];
                  this.currentMarketObj = this.convertArrayMarketToObj(this.currentMarket,this.currentMarketArray)
              }

              callback && callback();

            }.bind(this)
          });
        },
        //转换数组市场为对象格式
        convertArrayMarketToObj: function (market,array) {
          var obj = {};
            obj.lastPrice = array[0];
            obj.buyOne = array[1];
            obj.sellOne = array[2];
            obj.isVirtual = array[9];
            obj.openTime = array[10];
            obj.isOpen = array[10];
            obj.market = market;
            obj.customstep = 0;
            obj.isVisible = true;
            obj.marketId = "";
            obj.sortId = 0;
            obj.userId = this.currentAccountId;
            return obj;
        },
          // 获取用户所有可用市场
          getUserMarket: function(callback) {
              var data = {
                  childId: ISLOGIN  ? this.sharedState.currentAccountId : ''
              };
              Methods.ajax({
                  url: DOMAIN_MAIN + API_PREFIX + 'getUserMarket',
                  data: data,
                  success: function (res) {
                      if(!res.datas.userMarket){
                          return console.log('getUserMarket failed.')
                      }
                      this.userMarketsData = res.datas.userMarket;
                      if(typeof callback == 'function'){
                          callback();
                      }
                  }.bind(this)
              });
          },
        // 过滤指定币种的市场
        getMarketsForCoin: function(coin) {
            var _this = this;
          var marketsData = this.allMarketsData;
          var allMarkets = Object.keys(marketsData);
          var filterMarkets = [];
          if (allMarkets.length) {
            allMarkets.forEach(function(market){
                var money = market.split('_')[1];
                var arr = [market, marketsData[market]];
                if(coin == 'demo'){
                    //模拟市场
                    if(money.length > 3 && money.substring(0,1) == 'd'){
                        filterMarkets.push(arr);
                    }
                }else if(coin == 'user'){
                    //用户市场
                    for(var i = 0, ilength = _this.userMarketsData.length; i < ilength; i++){
                        if(_this.userMarketsData[i].market == market){
                            filterMarkets.push(arr);
                        }
                    }
                }else if(coin == 'hot'){
                    //热门市场(区分实盘和模拟盘)
                    if(arr[1][11] && (Boolean(parseInt(_this.currentExchangeMode)) == !Boolean(arr[1][9]))){
                        filterMarkets.push(arr);
                    }
                }else if(coin == 'none'){
                    //不显示

                }else{
                    if (money == coin) {
                        filterMarkets.push(arr);
                    }
                }
            });
          }
          return filterMarkets;
        },
        //编辑用户市场
        editUserMarket: function(type, market, event) {
           //若带入event参数则说明是快捷添加市场
           if(event){
               //阻止事件
               event.cancelBubble = true;
           }
          var data = {
            isType: type,
            market: market,
            childId: this.sharedState.currentAccountId
          };
          Methods.ajax({
            url: DOMAIN_MAIN + API_PREFIX + 'doEditMarket',
            data: data,
            success: function (res) {
                var successAddTo = function(redirect){
                    swal({
                        title: "<%= LANG('添加成功') %>",
                        text: "<%= LANG('即将跳转到自选交易') %>",
                        icon: "success",
                        buttons: ["<%= LANG('立即跳转') %>!", false],
                        dangerMode: false,
                    }).then((willDelete) => {
                        window.location.href = redirect;
                });
                    window.setTimeout(function(){ window.location.href = redirect ;},3000);
                }

                var successDelTo = function(redirect){
                    swal({
                        title: "<%= LANG('删除成功') %>",
                        text: "<%= LANG('即将跳转到默认市场') %>",
                        icon: "success",
                        buttons: ["<%= LANG('立即跳转') %>!", false],
                        dangerMode: false,
                    }).then((willDelete) => {
                        window.location.href = redirect;
                });
                    window.setTimeout(function(){ window.location.href = redirect ;},3000);
                }


                if(event){
                    if(type == 1){
                        successAddTo('/trade/' + market + '?self=1');
                    }else{
                        successDelTo(DOMAIN_MAIN + '/trade/');
                    }
                }else{
                    this.getUserMarket();
                    $.toast({
                        heading: "<%= LANG('修改用户市场信息成功') %>",
                        text: "<%= LANG('修改用户市场信息成功') %>",
                        showHideTransition: 'plain',
                        icon: 'success'
                    });
                }
            }.bind(this)
          });
        },
        getChartData: function(market) {
          var data = {
            market: market,
            size: 24,
            assist : MONEY,
            type: '15min',
            //暂时用于标识本例请求
            note:market + '_miniline'
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'charts',
            data: data,
            success: function (res) {
              var arr = [];
              //容错处理
              if(!res.datas.data){
                  res.datas.data = []
              }
              if (res.datas.data) {
                arr = res.datas.data.map(function(item){
                  return item[4];
                });
              }
              var min = arr[0];
              for(var i = 0;i < arr.length; i++){
                if (arr[i] < min) {
                  min = arr[i]
                }
              }
              var arr2 = arr.map(function(item){
                return item - min;
              });
              var obj = this.marketChartData;
              obj[market] = arr2.toString();
              this.marketChartData = obj;
              this.$forceUpdate();
            }.bind(this)
          });
        },
        getMarketChartData: function() {
          if (this.userMarketsData && this.userMarketsData.length > 0) {
            this.userMarketsData.map(function (market) {
              this.getChartData(market.market);
            }.bind(this));
          }
        },
        // 获取所有子账户
        getSubAccounts: function() {
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getSubAccounts',
            success: function (res) {
              this.allSubAccounts = res.datas.accounts;
            }.bind(this)
          });
        },
          // 获取币价汇率
          getPriceRate: function(callback) {
            /*if(this.currentMarket != 'null'){
                return false;
            }*/
              Methods.ajax({
                  url: DOMAIN_DEV + "/exchange/config/controller/website/pricecontroller/" + 'getassistprice',
                  success: function (res) {
                      this.allPriceRate = res.datas;
                      //store.state.allPriceRate = res.datas;
                      this.sharedState.allPriceRate = res.datas;
                      //var oriPrice = res.datas.prices[this.moneyType];
                      /*if (res.datas.rate['USD_CNY']) {
                        this.rate = res.datas.rate['USD_CNY'];
                      }*/
                      //this.oriPiece = oriPrice;
                      //this.moneyPrice = oriPrice/this.rate;
                      if(typeof callback == 'function'){
                          callback();
                      }
                  }.bind(this),
                  error : function(){
                  }
              });
          },
        // 获取币价汇率(作废了)
        getPriceRate2: function(callback) {
          Methods.getJSONP({
            url: DOMAIN_MAIN + API_PREFIX + 'getPricesAndRate',
            success: function (res) {
              var oriPrice = res.datas.prices[this.moneyType];
              if (res.datas.rate['USD_CNY']) {
                this.rate = res.datas.rate['USD_CNY'];
              }
              this.oriPiece = oriPrice;
              //this.moneyPrice = oriPrice/this.rate;
              if(typeof callback == 'function'){
                callback();
              }
            }.bind(this)
          });
        },
        // 设置辅助币种
        setCurrency: function(coin) {
          this.sharedState.currency = coin;
          if (!this.isLogin) {
              Methods.setCookie(ENV+'mname', coin.key);
              window.location.reload();
              return
          }
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'editAssistCoin',
            data: {
              assistCoin : coin.key
            },
            success: function (res) {
              Methods.setCookie(ENV+'mname', coin.key);
              top.location.reload();
            }.bind(this)
          });

        },
        // 切换子账号
        handleSelectSub: function(user) {
          Methods.setCookie(ENV + 'currentAccountId', user.id);
          //切换完帐号直接刷页面，解决不切换市场的bug
            top.location.reload();
          //window.location.href = DOMAIN_MAIN + '/trade';
          /*this.sharedState.currentAccountId = user.id;
          this.currentAccountId = user.id;
          this.getAssets(user.id);
          this.getUserMarket(this.getMarketChartData);
          this.updateMarketLocalInfo();
          EXX.tradeMain.getEntrustRecord();
          this.showAccountsList = false;*/
        },
        changeMarket: function(market) {
          if (this.currentMarket != market) {
              if(this.marketMain == 'user'){
                  window.location.replace('/trade/' + market + '?self=1');
              }else{
                  window.location.replace('/trade/' + market);
              }
          }
        },
        priceInput: function(el) {
          var $btn = $('#' + this.currentMarket + ' .button');
          var $priceInput = $('#' + this.currentMarket + ' .priceInput');
          var $numberInput = $('#' + this.currentMarket + ' .numberInput');
          if ($priceInput.val() != '' && $numberInput.val() != '' ) {
            $btn.removeClass('disabled');
          } else {
            $btn.addClass('disabled');
          }
          var val  = el.target.value;
          var allPriceRate = this.sharedState.allPriceRate;
          var price = this.moneyPrice(this.currentPriceType, this.marketTo(this.currentMarket));
          var fixed = el.target.dataset.fixed || 6;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (re.test(val)) {
            var test = val/price;
            el.target.dataset.ori = parseFloat(val)/parseFloat(price).toFixed(6);
            //this.inputPrice = Number(val)/Number(price).toFixed(6);
          } else if (!re.test(val) && val != '') {
            $.toast({
              heading: "<%= LANG('非法输入') %>",
              text: "<%= LANG('输入格式有误') %>",
              showHideTransition: 'plain',
              icon: 'warning'
            });
            el.target.value = val.replace(/.$/, '');
          }
        },
        stepPrice: function(mode, market) {
            var _this = this;
          var $priceInput = $('#' + this.currentMarket + ' .priceInput');
          var $percentInput = $('#' + this.currentMarket + ' .percentnum');
          var allPriceRate = this.sharedState.allPriceRate;
          var priceRate = this.moneyPrice(this.currentPriceType, this.marketTo(this.currentMarket));
          var percentVal = $percentInput.val();
          var $btn = $('#' + this.currentMarket + ' .button');

          $btn.removeClass('disabled');
          $priceInput.addClass('active-ani');
          setTimeout(function(){
            $priceInput.removeClass('active-ani');
          }, 800);

          var oriVal = Number($priceInput.val());
          oriVal = oriVal ? oriVal : Number(this.getMoneyDisplay(market.lastPrice, this.marketTo(this.currentMarket)));
          var percent = /\d*%$/.test(percentVal) ? parseFloat(percentVal)/100 : 0.01;
          var price = 0;
          if (mode == 'add') {
            price = Number(oriVal + oriVal * percent);
          } else if (mode == 'reduce') {
            price = Number(oriVal - oriVal * percent);
          }
          $priceInput.attr('data-ori', (price/priceRate).toFixed(8));

          _this.currentInputPrice = price.toFixed(3);

          //$priceInput.val(price.toFixed(3));
          //var price = $priceInput.val();
          //var number = $numberInput.val();
        },
        numberInput: function(el) {
          var $btn = $('#' + this.currentMarket + ' .button');
          var $priceInput = $('#' + this.currentMarket + ' .priceInput');
          var $numberInput = $('#' + this.currentMarket + ' .numberInput');
          if ($priceInput.val() != '' && $numberInput.val() != '' ) {
            $btn.removeClass('disabled');
          } else {
            $btn.addClass('disabled');
          }
          var val = el.target.value;
          var fixed = el.target.dataset.fixed || 6;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (re.test(val)) {
            this.inputNumber = el.target.value;
          } else if (!re.test(val) && val != '') {
            $.toast({
              heading: 'Warning',
              text: "<%= LANG('输入格式有误') %>",
              showHideTransition: 'plain',
              icon: 'warning'
            });
            el.target.value = val.replace(/.$/, '');
          }
        },
        stepNumber: function(mode) {
            var _this = this;
          var $btn = $('#' + this.currentMarket + ' .button');

          $btn.removeClass('disabled');
          var $numberInput = $('#' + this.currentMarket + ' .numberInput');
          var $percentInput = $('#' + this.currentMarket + ' .percentnum');
          var percentVal = $percentInput.val();

          $numberInput.addClass('active-ani');
          setTimeout(function(){
            $numberInput.removeClass('active-ani');
          }, 800);

          var oriVal = $numberInput.val();
          var value = Number(oriVal ? oriVal : $('#asks .row:last-child .amount').text());
          var percent = /\d*%$/.test(percentVal) ? parseFloat(percentVal)/100 : 0.01;
          var number = 0;
          if (mode == 'add') {
            number = oriVal == '' ? value : Number(value + value * percent);
          } else if (mode == 'reduce') {
            number = oriVal == '' ? value : Number(oriVal - oriVal * percent);
          }
          //$numberInput.val(number.toFixed(6));
          _this.currentInputNumber = _this.fixNumber(number, _this.marketConfig[_this.currentMarket].coinDecimal);
        },
        percentInput: function(el) {
          var val = el.target.value;
          var regString = '^\\d+(\\.\\d{0,2})?%?$';
          var re = new RegExp(regString);
          if (!re.test(val)) {
            el.target.value = val.replace(/.$/, '');
          }
        },
        lockPercentInput: function(el) {
          var target = el.target;
        },
        //获取暂存在cookie里的市场信息
        updateMarketLocalInfo: function() {
          if (this.userMarketsData && this.userMarketsData.length) {
            this.userMarketsData.map(function(market){
              var name = [market.market, 'percentInput'].join('_');
              var val = this.getMarketCookie(market.market);
              var el = this.$refs[name];
              if (val && el) {
                el.value = val;
              }
            }.bind(this))
          }
        },
        handleQuickTrans: function(isBuy, market, price, useable, num) {
          if (!ISLOGIN) {
            $.toast({
              heading: "<%= LANG('请先登录') %>",
              text: "<%= LANG('请先登录再进行交易') %>。",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }
          if(this.lockTrade){
            $.toast({
              heading: "<%= LANG('订单提交错误') %>",
              text: "<%= LANG('您有未完成的订单请求，请稍候再提交。') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            var typeDom = isBuy == 0 ? ' .sell-col' : ' .buy-col';
            $('#' + market.market + typeDom + ' .t-animationload').removeClass('active');
            return
          }
//          if (isBuy == 0 && $('.button.sell').hasClass('disabled')) {
//            $('.button.sell .t-animationload').removeClass('active');
//            return
//          }
//          if (isBuy == 1 && $('.button.buy').hasClass('disabled')) {
//            $('.button.buy .t-animationload').removeClass('active');
//            return
//          }
          var refName = [market.market, 'percentInput'].join('_');
          var number = num || this.$refs[refName][0].value;

          var reg = /(\d+\.?\d?)%$/;
          if (reg.test(number)) {
            if (isBuy == 0) {
              number = parseFloat(useable)*(parseFloat(number)/100);
            } else if (isBuy ==1) {
              number = parseFloat(price) === 0 ? parseFloat(useable)*(parseFloat(number)/100) : parseFloat(useable)*(parseFloat(number)/100)/parseFloat(price);
            }
          }

          useable = Number(useable);
          if (useable <= 0 ) {
            $.toast({
              heading: "<%= LANG('没有足够的资金') %>",
              text: "<%= LANG('没有足够的') %><b>" + (isBuy == 0 ? this.marketFrom(market.market) : this.marketTo(market.market)).toUpperCase() + "</b>，<%= LANG('你可以先充值或划账到此账户') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          } else if (number == 0) {
            $.toast({
              heading: "<%= LANG('订单提交错误') %>",
              text: "<%= LANG('请输入') %>" + (isBuy == 0 ? "<%= LANG('卖出') %>" : "<%= LANG('买入') %>") + "<%= LANG('数量') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          } else {
            this.handleEntrustSubmit(isBuy, market.market, price, number)
          }
        },
        handleNormalTrans: function(isBuy, market) {
          if (!ISLOGIN) {
            $.toast({
              heading: "<%= LANG('请先登录') %>",
              text: "<%= LANG('请先登录再进行交易') %>。",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }
          if (isBuy == 0 && $('#' + market + ' .button.sell.disabled').length) {
            $('.button .t-animationload').removeClass('active');
            return
          }
          if (isBuy == 1 && $('#' + market + ' .button.buy.disabled').length) {
            $('.button .t-animationload').removeClass('active');
            return
          }
          //var price = $('#' + market + ' .priceInput').attr('data-ori');
          var price = this.currentInputConvertPrice;
          var number = this.currentInputNumber;
          //var number = $('#' + market + ' .numberInput').val();
          var useable = 0;
          if (isBuy == 0) {
            useable = this.getUseable(market.split('_')[0]);
          } else if (isBuy == 1) {
            useable = this.getUseable(market.split('_')[1]) / price;
          }

          number = Number(number);
          useable = Number(useable);

          if (price == '' || !number ) {
            $.toast({
              heading: "<%= LANG('输入错误') %>",
              text: "<%= LANG('请输入交易金额和数量') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }

          if(number > useable || useable == 0){
            $.toast({
              heading: "<%= LANG('没有足够的资金') %>",
              text: "<%= LANG('没有足够的') %><b>" + (isBuy == 0 ? this.marketFrom(market.market) : this.marketTo(market.market)).toUpperCase() + "</b>，<%= LANG('你可以先充值或划账到此账户') %>",
              showHideTransition: 'fade',
              icon: 'error'
            });
            this.clearEntrustInput();
            $('.t-animationload').removeClass('active');
            return
          }
          this.handleEntrustSubmit(isBuy, market, price, number);
        },
        clearEntrustInput: function() {
          var market = this.currentMarket;
          var $Input = $('#' + market + ' .entrust-form input');
          $Input.val('');
          $Input.attr('data-ori', '');
        },
        // 提交委托
        handleEntrustSubmit: function(isBuy, market, price, number) {
          var $buyBtn = $('#' + market + ' .button.buy');
          var $sellBtn = $('#' + market + ' .button.sell');
          var $priceInput = $('#' + market + ' .priceInput');
          var $numberInput = $('#' + market + ' .numberInput');

          if (!ISLOGIN) {
            $.toast({
              heading: "<%= LANG('订单提交错误') %>",
              text: "<%= LANG('请先登录再进行交易') %>。",
              showHideTransition: 'fade',
              icon: 'error'
            });
            $('.t-animationload').removeClass('active');
            return
          }
          //请求锁 防止重复提交
          if(this.lockTrade){
              $.toast({
                  heading: "<%= LANG('订单提交错误') %>",
                  text: "<%= LANG('您有未完成的订单请求，请稍候再提交。') %>",
                  showHideTransition: 'fade',
                  icon: 'error'
              });
            $('.t-animationload').removeClass('active');
              return
          }
          $buyBtn.addClass('disabled');
          $sellBtn.addClass('disabled');
          var text = '';
          if (isBuy == 0) {
            text = price + "<%= LANG('价格') %>" + "<%= LANG('卖出') %>" + market.toUpperCase().split('_')[0] + number;
          } else if (isBuy == 1) {
            text = price + "<%= LANG('价格') %>" + "<%= LANG('买入') %>" + market.toUpperCase().split('_')[0] + number;
          }

          this.lockTrade = true ;
          var data = {
            //safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
            safePwd: this.safePwd,
            userId: this.sharedState.currentAccountId,
            market: market,
            isBuy: isBuy,
            isReal: false,
            unitPrice: price,
            number: number,
            triggerPrice: ''
          };
          if (this.currentAccountInfo.lever) {
            data["isLoan"] = 'true';
          }
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'doEntrust',
            data: data,
            success: function (res) {
              EXX.tradeMain.getEntrustRecord();
              //清除输入框内容
              this.clearEntrustInput();
              //解除请求锁定
              this.lockTrade = false ;
              $(".t-animationload").removeClass('active');
              $.toast({
                heading: "<%= LANG('定单已执行') %>",
                text: text,
                icon: 'success',
                loader: true,        // Change it to false to disable loader
                loaderBg: '#9EC600'  // To change the background
              });
                //马上刷新资金
                var int = 0;
                var call = setInterval(function () {
                    int ++ ;
                    if(int <= 3){
                        this.lastAssetTime = 0;
                        this.getAssets(this.currentAccountId);
                    }else {
                        window.clearInterval(call);
                    }
                }.bind(this),1000)
              this.inputPrice = '';
              this.inputNumber = '';
              this.currentInputPrice = '';
              this.currentInputNumber = '';
              this.showModal = false;
            }.bind(this),
            error: function (res) {
              this.clearEntrustInput();
              //解除请求锁定
              this.lockTrade = false ;
              $(".t-animationload").removeClass('active');
              $.toast({
                heading: "<%= LANG('订单提交失败') %>",
                text: EXX.L(res.resMsg.message),
                showHideTransition: 'fade',
                icon: 'error'
              })
            }.bind(this)
          });
        },
        handleClickInPage: function() {
          this.showCurrencyList = false;
          this.openAccountsList(false);
        },
        calculateHeight: function() {
          var wHeight = window.innerHeight;
          var scrollEl = this.$refs.marketsList ? this.$refs.marketsList.$el : '';
          var height = wHeight - scrollEl.offsetTop - 80;
          //移动端下取消固定高度
          if(Methods.isMobile()){
              $('.markets-list').height("auto");
          }else{
              $('.markets-list').height(height);
          }
          //scrollEl.height = wHeight - scrollEl.offsetHeight;
        },
        bindPencentEvent : function () {
            $(function () {
                $(".percentnum").on('focus',function(){
                    if (!$(this).prop('disabled')) {
                        $(this).parents(".percent-choose").addClass("up").children(".bd").slideDown();
                    }
                });


                $(".icon-expand_more").on('click',function(){
                    if ($(this).parents(".percent-choose").find(".a-locking").hasClass('on')) {
                        $(this).parents(".percent-choose").removeClass("up").children(".bd").slideUp();
                    }else{
                        $(this).parents(".percent-choose").toggleClass("up").children(".bd").slideToggle();
                    }
                });

                $(".percent-choose .bd li span").on('click',function(){
                    var $input = $(this).parents(".percent-choose").find(".percentnum");
                    if(!$input.prop('disabled')){
                        $(this).parents(".percent-choose").find(".percentnum").val($(this).html());
                    }
                })

            });
        },
        setDefaultTab : function () {
          //列表页
          if(this.currentMarket == 'null'){
              if(this.isLogin){
                  this.marketMain = 'user';
              }else{
                  if(this.currentExchangeMode == '0'){
                      this.marketMain = 'demo';
                  }else{
                      //this.marketMain = 'hot';
                      this.marketMain = 'btc';
                  }
              }
          }else{
              // 交易页
              for(var i = 0; i < this.initGmarket.length; i ++){
                  if (this.currentMarket.split('_')[1].indexOf(this.initGmarket[i]) != -1 && Methods.getUrlparm('self') != 1) {
                      this.marketMain = this.initGmarket[i];
                  }
              }
              if(this.currentMarket.split('_')[1].length > 3 && this.currentMarket.split('_')[1].substring(0,1) == 'd'){
                  this.marketMain = 'demo';
              }
              if(this.isLogin){
                  if(Methods.getUrlparm('self') == 1) {
                      this.marketMain = 'user'
                  }
              }
          }
        }
      },
      created: function() {
          var _this = this;

          var cookieSimplify = Methods.getCookie(ENV + '_isSimplify');
          _this.isSimplify = cookieSimplify == 'true' ? true : false;

          var cookieExchangeMode = Methods.getCookie(ENV + 'ExchangeMode') || '1';
          _this.isMock = cookieExchangeMode == '0' ? true : false;

          if(_this.isLogin) {
              var currentAccountId = Methods.getCookie(ENV + 'currentAccountId');
              _this.currentAccountId = currentAccountId ? currentAccountId : _this.loginUser.userId;
              _this.sharedState.currentAccountId = _this.currentAccountId;
          }

          //获取价格表与所有市场后才初始化
          _this.getAllMarketsData(function () {
              _this.getPriceRate(function(){
                  //开始定时器任务
                  setInterval(_this.getAllMarketsData, 2000);
                  //列表页单独开启一个定时器
                  if(this.currentMarket == 'null'){
                      setInterval(_this.getPriceRate, 10000);
                  }
              });
          });

          if(_this.isLogin){
              _this.getUsersInfo(function () {});
              _this.getAssets(_this.currentAccountId);
              _this.getUserMarket(function(){
                  _this.updateMarketLocalInfo();
                  //初始化后绑定快捷比例买卖
                  setTimeout(_this.bindPencentEvent ,1000)
              });
              //开始用户的定时器
              setInterval(_this.getUserMarket, 15000);
              setInterval(function () {
                  _this.getAssets(_this.currentAccountId);
              }, 3000);
          }
      },
      mounted: function() {
        this.setDefaultTab();
        this.calculateHeight();
        //this.bindPencentEvent();
        $('[data-toggle="tooltip"]').tooltip()
        window.addEventListener('resize', this.calculateHeight);
        document.addEventListener('click', this.handleClickInPage, true);
      },
      updated: function() {
        this.calculateHeight();
        $('[data-toggle="tooltip"]').tooltip()
      },
      beforeDestroy: function() {
        window.removeEventListener('resize', this.calculateHeight);
        document.removeEventListener('click', this.handleClickInPage, true)
      }
    })
  })

</script>
<script type="text/javascript" src="<%= STATIC %>/scripts/slider.js"></script>
