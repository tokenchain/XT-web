<div id="trade-index">
  <div id="trade-main" class="main">
    <div class="chart-wrap">
      <div class="chart-box chart-kline">
          <div class="hd">


              <div class="market-down">
                  <div class="market-down-show">
                     <div class="market-down-hd">
                       <div class="vue-init" v-cloak=""><span class="main-coin">{{market.toUpperCase().split('_')[0]}}</span>/{{market.toUpperCase().split('_')[1]}}</div>
                     </div>
                     <div class="market-down-bd">
                         <ul>
                           <li v-for="market in userMarkets"><a :href="'/trade/' + market"><span>{{market.toUpperCase().split('_')[0]}}</span>/{{market.toUpperCase().split('_')[1]}}</a></li>
                         </ul>
                     </div>
                  </div>
                  <div class="market-search" onclick="EXX.tradeSidebar.openMarket()">
                      <a ><i class="iconfont icon-sousuo1"></i> </a>
                  </div>
              </div>


              <div class="tab">
                  <a role="button" :class="{'on': chartType == 'kline'}" @click="setChartType('kline')"><%= LANG('K线图') %></a>
                  <a role="button" :class="{'on': chartType == 'depth'}" @click="setChartType('depth')"><%= LANG('深度') %></a></div>
              <div class="tab" v-cloak="">
                  <a role="button" :class="{'on': currentPriceType != klineMoney }" @click="setChartMoney(moneyType)" data-toggle="tooltip" data-placement="top" title="<%= LANG('以x作为K线价格单位', market.split('_')[1].toUpperCase())%>">{{moneyType.toUpperCase()}}</a>
                  <a role="button" :class="{'on': currentPriceType == klineMoney }" @click="setChartMoney('<%= MONEY %>')" data-toggle="tooltip" data-placement="top" title="<%= LANG('以x作为K线价格单位',MONEY.toUpperCase())%>"><%= MONEY.toUpperCase() %></a>
              </div>
              <div class="tab timelist">
            <div class="crosswise">

              <a role="button" @click="switchPeriod('1w')" :class="[period == '1w' ? 'on' : '']"><%= LANG('周') %></a>
              <a role="button" @click="switchPeriod('1d')" :class="[period == '1d' ? 'on' : '']"><%= LANG('日') %></a>
              <a role="button" @click="switchPeriod('1h')" :class="[period == '1h' ? 'on' : '']"><%= LANG('时') %></a>
              <a role="button" @click="switchPeriod('30m')" :class="[period == '30m' ? 'on' : '']">30<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('15m')" :class="[period == '15m' ? 'on' : '']">15<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('1m')" :class="[period == '1m' ? 'on' : '']">1<%= LANG('分') %></a>

            </div>
            <div class="vertical">
               <span v-if="period == '1w'"><%= LANG('周') %><i class="caret"></i></span>
              <span v-if="period == '1d'"><%= LANG('日') %><i class="caret"></i></span>
              <span v-if="period == '1h'"><%= LANG('时') %><i class="caret"></i></span>
              <span v-if="period == '30m'">30<%= LANG('分') %><i class="caret"></i></span>
               <span v-if="period == '15m'">15<%= LANG('分') %><i class="caret"></i></span>
               <span v-if="period == '1m'">1<%= LANG('分') %><i class="caret"></i></span>
              <div>
              <a role="button" @click="switchPeriod('1w')" :class="[period == '1w' ? 'on' : '']"><%= LANG('周') %></a>
              <a role="button" @click="switchPeriod('1d')" :class="[period == '1d' ? 'on' : '']"><%= LANG('日') %></a>
              <a role="button" @click="switchPeriod('1h')" :class="[period == '1h' ? 'on' : '']"><%= LANG('时') %></a>
              <a role="button" @click="switchPeriod('30m')" :class="[period == '30m' ? 'on' : '']">30<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('15m')" :class="[period == '15m' ? 'on' : '']">15<%= LANG('分') %></a>
              <a role="button" @click="switchPeriod('1m')" :class="[period == '1m' ? 'on' : '']">1<%= LANG('分') %></a>
              </div>
            </div>


              </div>
              <!--<a title="<%= LANG('全屏') %>" href="/kline/<%= market %>" class="qp"><i class="iconfont icon-quanping"></i></a>-->

              <div class="notice-list t_news vue-init" style="display: none">
                  <ul class="news_li">
                      <li><a href="#">什么是XBTC  </a></li>
                      <li><a href="#">ETC涨跌对投资收益有影响么？ </a></li>
                      <li><a href="#">XBTC基于以太坊ETC发布和定价 </a></li>
                      <li><a href="#">XBTC发行认购进度 </a></li>
                  </ul>
                  <ul class="swap"></ul>
              </div>
          </div>

          <div class="bd">
              <div v-show="chartType === 'kline'" class="chart-box">
                  <iframe src="/kline/lite/<%= market %>?money=<%= MONEY%>" id="marketFrame" class="marketFrame" name="marketFrame" onload="" frameborder="0" width="100%" style="height:750px" hspace="0" scrolling="no"></iframe>
              </div>
              <div v-show="chartType === 'depth'" class="chart-box" style="height: 100%;">
                  <vue-highcharts class="depth-chart" :options="depthChartOptions" ref="depth"></vue-highcharts>
              </div>
          </div>
      </div>
      <div class="entrust">
        <div v-if="isLogin" class="more-btn"><a @click="openEntrust(market)"><%= LANG('更多记录') %></a></div>
        <json-grid :settings="entrustTableSettings" :columns="entrustCols" :rows="entrustRows" :no-data-message="entrustNoDataText" ></json-grid>
      </div>
    </div>

    <div class="stock-data" ref="right">

      <div id="orderbook" class="price disk-box" :class="{'show-depth': showDepth}">
        <div class="orderTitle clearfix">
          <span style="width:30%; padding-left: 10px;"><%= LANG('价格') %>(<%= market.split("_")[1].toUpperCase() %>)</span>
          <span style="width:20%"><%= LANG('折价') %>(<%= MONEY.toUpperCase() %>)</span>
          <span style="width:30%; text-align: right;"><%= LANG('数量') %>(<%= market.split("_")[0].toUpperCase() %>)</span>
          <span style="width:20%; text-align: left; padding-left:10px;"><input v-model="showDepth" type="checkbox" /></span>
        </div>
          <div style="height: 100%; position: relative; overflow: hidden">
        <div id="asks">
          <div class="table">
          </div>
        </div>
        <div @click="setPrice(currentPrice)" class="current-price vue-init" :class="priceTrend">
          <span>
            <b v-show="currentPriceType == 'btc'" v-cloak="">฿</b>
            <b v-show="currentPriceType == 'usd'" v-cloak="">$</b>
            <b v-show="currentPriceType == 'cny'" v-cloak="">￥</b>
            <animated-number :number="currentPriceCovert"></animated-number>
          </span>
          <i></i>
        </div>
        <div id="bids" class="disk-box">
          <div class="table">
          </div>
        </div>
        </div>
      </div>

      <div class="deal-time disk-box">
          <div class="orderTitle clearfix">
              <span style="width:30%; text-align: left; padding-left:10px;"><%= LANG('成交时间') %></span>
              <span style="width:35%; padding-left: 10px;"><%= LANG('折价') %>(<%= MONEY.toUpperCase() %>)</span>
              <span style="width:35%; text-align: right; padding-right: 20px;"><%= LANG('数量') %>(<%= market.split("_")[0] %>)</span>
          </div>
          <div id="trades" class="trades">
              <div class="trades_list"></div>
          </div>
      </div>
    </div>

  </div>

  <%-include("_index_right.html")%>
  <%-include("calculator.html")%>
</div>


<%-include("../component/animated_number.html")%>
<%-include("../component/json_grid.html")%>
<%-include("../component/vue_highcharts.html")%>
<%-include("../component/page_lite.html")%>



<script>
  var store = {
    state: {
      allPriceRate : {
        btc : {
          btc : 1,
          ltc : 0.01589464,
          eth : 0.07079936,
          etc : 0.00371563
        },
        cny : {
          btc : 24500.55,
          ltc : 385.65,
          eth : 1705.26,
          etc : 91.36
        },
        usd : {
          btc : 3741.91,
          ltc : 58.89,
          eth : 260.44,
          etc : 13.95
        }
      }
    }
  };
  require(['vue', 'common/methods', 'common/juabox'], function(Vue, Methods, JuaBox) {
    EXX.tradeMain = new Vue({
      el: "#trade-main",
      data: function () {
        return {
          sharedState: store.state,
          loginUser: Methods.getLocalUserInfo(),
          isLogin: ISLOGIN,
          klineMoney : MONEY,
          currentPriceType : MONEY,
          currentPriceCovert : '',
          pubKey: '',
          period : '15m',
          theme: 'dark',
          chartType: 'kline',
          showSafePwd: false,
          showSellTip: false,
          showBuyTip: false,
          showDepth: false,
          loaded: true,
          market: '<%= market %>',
          currentPrice: '',
          priceTrend: 'up',
          buyPrice: '',
          buyQuantity: '',
          sellPrice: '',
          sellQuantity: '',
          safePwd: '',
          isBuy: -1,
          isReal: false,
          ask: [],  //卖单盘口数据
          bid: [],  //买单盘口数据
          rate : 6.4997,
          coinType: '<%= market.split("_")[0] %>',
          moneyType: '<%= market.split("_")[1] %>',
          allPriceRate :store.state.allPriceRate,
          oriPrice:'',
          maxAsksNum : 0,
          maxBidsNum : 0,
          chartAsks: [],
          chartBids: [],
          tradeDate:new Date(),
          tradesLimit : 50,
          dealRecordCols: [
            {label: "<%= LANG('成交时间') %>", key: 'date', cell: function(item){
              return Methods.getDateTime(parseInt(item.date * 1000), 'HH:MM:SS');
            }},
            {label: "<%= LANG('价格') %>", key: 'price', cell: function(item){
              return "<span class='" + item.type + "'>" + item.price + "</span>"
            }},
            {label: "<%= LANG('数量') %>", key: 'amount'}
          ],
          lastDepth :'',
          last_trade_tid: 0,
          depthShowSize: 30,
          dealRecord: [],
          entrustRecord: [],
          entrustCols: [
            {
              label: ' ',
              key: 'type',
              cell: function(item) {
                var text = '';
                if (item.type === 1) {
                  text = "<span><%= LANG('买') %></span>";
                } else if (item.type === 0) {
                  text = "<span><%= LANG('卖') %></span>";
                }
                return text;
              }
            },
            {label: "<%= LANG('时间/序列号') %>", key: 'date', cell: function(item){
              return Methods.getDateTime(item.date);
            }},
            {label: "<%= LANG('委托量/价格') %>", key: 'num_price', cell: function(item){
              var price = Methods.numSqxsw((Number(item.num_price[1]) * this.moneyPrice), 3);
              return "<span>" + Methods.numSqxsw(item.num_price[0], 3) + "</span>&nbsp;/&nbsp;<span data-toggle='tooltip' data-placement='top' title='当前价" + Methods.numSqxsw(item.num_price[1], 6) + "折合" + price +" " +this.currentPriceType.toUpperCase()+ "'>" + Methods.numSqxsw(item.num_price[1], 6) + "</span>"
            }.bind(this)},
            {label: "<%= LANG('成交量/均价') %>", key: 'deal_price', cell: function(item){
              var avgPrice = Methods.numSqxsw((Number(item.deal_price[1]) * this.moneyPrice), 3);
              return "<span>" + Methods.numSqxsw(item.deal_price[0], 3) + "</span>&nbsp;/&nbsp;<span data-toggle='tooltip' data-placement='top' title='当前价"  + Methods.numSqxsw(item.deal_price[1], 6) +  "折合" + avgPrice +" " +this.currentPriceType.toUpperCase()+ "'>" + Methods.numSqxsw(item.deal_price[1], 6) + "</span>"
            }.bind(this)},
            {label: "<%= LANG('成交额/费用') %>", key: 'totalMoney', cell: function(item){
              var sum = Methods.numSqxsw((Number(item.totalMoney[0]) * this.moneyPrice), 3);
              var cost = Methods.numSqxsw((Number(item.totalMoney[1]) * this.moneyPrice), 3);
              return "<span data-toggle='tooltip' data-placement='top' title='当前价折合" + sum + " " +this.currentPriceType.toUpperCase()+ "'>" + item.deal_price[0] + "</span>&nbsp;/&nbsp;<span data-toggle='tooltip' data-placement='top' title='折合" + cost +" " +this.currentPriceType.toUpperCase()+ "'>" + Methods.numSqxsw(item.totalMoney[1], 6) + "</span>"
              //return "<span>" + item.totalMoney[0] + "</span>&nbsp;/&nbsp;<span>" + item.totalMoney[1] + "</span>"
            }.bind(this)},
            {label: "<%= LANG('状态/操作') %>", key: 'actions', cell: function(item){
              //var el = createElement('span', 'test');
              if (item.status === 0) {
                return '<a onclick="EXX.tradeMain.handleEntrustCancel(' + item.id + ',' + item.isReal + ')">' + "<%= LANG('取消') %>" + '</a>';
              } else if (item.status === 1) {
                return "<span class='canceled'><%= LANG('已取消') %></span>";
              } else if (item.status === 2) {
                return "<span class='success'><%= LANG('已成交') %></span>";
              } else if (item.status === 3) {
                return "<span class='in-action'><%= LANG('交易中') %></span> | <a onclick='EXX.tradeMain.handleEntrustCancel(" + item.id + ',' + item.isReal + ")'" + "><%= LANG('取消') %></a>";
              }
            }.bind(this)}
          ],
          entrustTableSettings: {
            rowClass: function(item) {
              var status = item.status == 3 ? 'in-deal' : '';
              if (item.type === 1) {
                return 'buy ' + status;
              } else if (item.type === 0) {
                return 'sell ' + status;
              }
              return current;
            }
          }
        }
      },
      computed: {
        entrustNoDataText: function() {
          var text = '';
          if (!ISLOGIN) {
            text = "<%- LANG('请注册或登录后再进行交易') %>"
          } else {
            text = "<%= LANG('暂无记录') %>"
          }
          return text;
        },
        currencyList: function () {
            try{
                return EXX.userLeft.$data.currencyList || [];
            }catch(err){
                console.log('Miss leftMenu component')
            }
        },
        userMarkets: function() {
          return EXX.tradeSidebar.currentUserMarkets
        },
        moneyPrice: function(){
            return this.sharedState.allPriceRate[MONEY][this.moneyType]
        },
        marketInfo: function() {
          var markets = this.sharedState.markets;
          var marketInfo = {};
          if (markets.length) {
            marketInfo = markets.getObject('type', this.market);
          }
          return marketInfo;
        },
        buyPriceMoney: function() {
          return parseFloat(this.buyPrice * this.moneyPrice).toFixed(3);
        },
        sellPriceMoney: function() {
          return parseFloat(this.sellPrice * this.moneyPrice).toFixed(3);
        },
        askRows: function() {
          var rows = [];
          var ask = this.ask || [];
          ask.forEach(function(a) {
            var item = {};
            item.price = a[0];
            item.amount = a[1];
            item.depth = a[2];
            rows.push(item);
          });
          return rows;
        },
        bidRows: function() {
          var rows = [];
          var bid = this.bid || [];
          bid.forEach(function(b) {
            var item = {};
            item.price = b[0];
            item.amount = b[1];
            item.depth = b[2];
            rows.push(item);
          });
          return rows.reverse();
        },
        entrustRows: function() {
          var rows = [];
          var entrust = this.entrustRecord || [];
          entrust.forEach(function(b) {
            var item = {};
            item.isReal = b.length >= 16 ? true : false;
            item.id = b[0];
            item.num_price = [b[2], b[1]];
            item.deal_price = [b[3], (Number(b[3] == 0 ? 0 : b[4]/b[3]))];
            item.totalMoney = [b[4], b[8]];
            item.type = b[5];
            item.date = b[6];
            item.status = b[7];
            rows.push(item);
          }.bind(this));
          return rows;
        },
        depthChartOptions: function() {
          //var asks = this.chartAsks.reverse() || [];
          //var bids = this.chartBids || [];
          var asks = this.ask.reverse() || [];
          var bids = this.bid || [];
          var currentPrice = [[Number(this.currentPrice), 0]];
          var sumAsks = 0;
          var sumBids= 0;
          var fasks = asks.map(function(ask, index){
            if (index > 0) {
              sumAsks = (Number(ask[1])+Number(sumAsks)).toFixed(4);
              //console.log(Number(ask[1])+Number(sumAsks));

            } else {
              sumAsks = ask[1]
            }
            return [Number(ask[0]), Number(sumAsks)];
          });
          //for(var i=0;i<asks.length;i++){
          //  if(i>0){
          //    asks[i][1]=Number(Number(asks[i][1]+asks[i-1][1]).toFixed(4));
          //  }
          //}
//          for(var i=0;i<bids.length;i++){
//            if(i>0){
//              bids[i][1]=Number(Number(bids[i][1]+bids[i-1][1]).toFixed(4));
//            }
//          }
          var fbids = bids.map(function(bid, index){
            if (index > 0) {
              sumBids = (Number(bid[1])+Number(sumBids)).toFixed(4);
            } else {
              sumBids = bid[1]
            }
            return [Number(bid[0]), Number(sumBids)];
          });
          fbids.reverse();
          var opts = {
            title:null,
            rangeSelector : {selected : 1},
            rangeSelector: {enabled:false},
            exporting:{enabled:false},
            credits: {
              enabled: false
            },
            chart:{
              alignTicks:true,
              plotBorderColor: '#3C3F46',
              plotBorderWidth: 1,
              backgroundColor:"#292d37",
              marginBottom:50
			},
            legend: {
              enabled:false,
              backgroundColor: "transparent",
              y:20,
              shadow:false,
              itemHoverStyle: { color: '#EBEBEB' },
              itemStyle: { cursor: 'pointer', color: '#333' }
            },
            xAxis: {
              title: null,
              labels: {
                formatter: function() {
                  return this.value;
                }
              },
              minPadding:0.001,
              maxPadding:0.001,
              tickWidth:1,
              tickLength:5,
              tickColor:"#3C3F46",
              lineColor:"#3C3F46"
            },
            yAxis: [
              {
            	type: 'datetime',
	            title: null,
	            reversed:true
	          },
              {
	            title:null,
	            labels: {
	                format: "{value}"
	            },
	            opposite: true,
	            min:0,
                gridLineDashStyle: 'solid',
                gridLineColor:"#3C3F46",
                gridLineWidth:1
	          }
	        ],
            plotOptions: {
              areaspline: {
                marker: {
                  symbol: 'circle',
                  radius: 0,
                  states: {
                    hover: {
                      enabled: true
                    }
                  }
                }
              },
              scatter: {
                radius:5,
                marker: {
                  radius: 5,
                  symbol:"triangle-down"
                },
                states: {
                  hover: {
                    enabled: false
                  },
                  select:{
                    enabled: false
                  }
                },
                tooltip: {
                  headerFormat: ' <b>{series.name}</b><br>',
                  pointFormat: ' <b>{point.x}'
                },
                cursor:"pointer"
              }
            },
            series : [
              {
                name : "<%= LANG('卖单') %>",
                data : fasks,
                type : 'areaspline',
                color:"#31c871",
                yAxis: 1,
                zIndex:1
              },
              {
                name: "<%= LANG('最新价') %>",
                data : currentPrice,
                type : 'scatter',
                color:"#6baffb",
                yAxis: 1,
                zIndex:2
              },
              /*{
                  name: "价格",
                  data : [],
                  type : 'spline',
                  color:"#40bb28",
                  yAxis: 0
              },*/
              {
                name: '<%= LANG("买单") %>',
                data: fbids,
                type: 'areaspline',
                color:"#de211d",
                yAxis: 1,
                zIndex:1
              }
            ]
          };
          return opts;
        },
        marketDisplay: function() {
          return this.market.toUpperCase().replace('_', '/');
        },
        useable: function() {
          var coinName = this.marketDisplay.split('/')[0];
          var asset = this.sharedState.coinAccets[coinName];
          return asset ? asset.usable : 0;
        },
        useableBTC: function() {
          var asset = this.sharedState.coinAccets['BTC'];
          return asset ? asset.usable : 0;
        },
        canBuy: function() {
          if (this.bid.length) {
            return Methods.numDivider(this.useableBTC, this.bid[0][0]).toFixed(3);
          } else {
            return 0;
          }
        },
        buyTotal: function() {
          return Methods.numMultiply(this.buyPrice, this.buyQuantity);
        },
        sellTotal: function() {
          return Methods.numMultiply(this.sellPrice, this.sellQuantity);
        }
      },
      methods: {
        switchPeriod: function(period){
          this.setChartType('kline');
          this.period = period  ;
          window.frames['marketFrame'].switch_period(period);
        },
        switchTheme: function(theme){
          this.theme = theme ;
          window.frames['marketFrame'].switch_theme(theme);
        },
        setChartMoney: function(type) {
            this.setChartType('kline');
            this.klineMoney = type;
            window.frames['marketFrame'].chart_set_money(type);
            document.getElementById("marketFrame").src = '/kline/lite/<%= market %>?money=' + type;
        },
        setChartType: function(type) {
          this.chartType = type;
            this.bindAutoHeight();
            this.$refs.depth.resize();
        },
        setShowTip: function(name) {
          if (name == 'sell') {
            this.showSellTip = true;
            var val = this.$refs.sellPrice.value;
            if (val) {
              this.$refs.sellMoney.value = (val * this.moneyPrice).toFixed(2);
            }
          } else if (name == 'buy') {
            this.showBuyTip = true;
            var val = this.$refs.buyPrice.value;
            if (val) {
              this.$refs.buyMoney.value = (val * this.moneyPrice).toFixed(2);
            }
          } else {
            this.showBuyTip = false;
            this.showSellTip = false;
          }
        },
        bindAutoHeight : function () {
          $(function () {
              var leftHeight = $(".chart-kline").height() - $(".chart-kline .hd").outerHeight();
              $("#marketFrame").height(leftHeight);
              $(".chart-kline .bd").height(leftHeight);
              $(".chart-box .depth-chart").height(leftHeight);
          })
        },
        getCookie : function (name) {
          var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
          if(arr=document.cookie.match(reg)){
              return unescape(arr[2]);
          }else {
              return false;
          }
        },
        openEntrust: function(market) {
          EXX.tradeSidebar.openEntrust(market);
        },
        getPubKey: function () {
            Methods.ajax({
                type: 'GET',
                url: DOMAIN_DEV + "/exchange/controller/website/common/baseapicontroller/" + 'getpubkey',
                success: function (res) {
                    this.pubKey = res.datas.pubKey;
                }.bind(this)
            });
        },
        // 限制输入指定位小数
        priceInput: function(el) {
          var vm = this;
          var val = el.target.value;
          var model = el.target.dataset.model;
          var money = el.target.dataset.money;
          var fixed = el.target.dataset.fixed;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (!val) {
            if (money) {
              vm.$refs[money].value = '';
            }
            vm[model] = val;
            return
          } else if (!val.match(re)) {
            el.target.value = val.replace(/.$/, '');
          } else {
            // 如果需要关联法币输入
            if (money) {
              vm.$refs[money].value = (Number(val) * this.moneyPrice).toFixed(2);
            }
            vm[model] = val;
          }
        },
        //输入法币自动转换成虚拟币价格
        moneyInput: function(el) {
          var vm = this;
          var val = el.target.value;
          var model = el.target.dataset.model;
          var fixed = el.target.dataset.fixed;
          var regString = '^\\d+(\\.\\d{0,' + fixed + '})?$';
          var re = new RegExp(regString);
          if (!val) {
            vm.$refs[model].value = '';
            vm[model] = '';
            return
          } else if (!val.match(re)) {
            el.target.value = val.replace(/.$/, '');
          } else {
            el.target.value = val;
            var modelFixed = vm.$refs[model].dataset.fixed;
            vm.$refs[model].value = (parseFloat(val)/this.moneyPrice).toFixed(modelFixed);
            vm[model] = Number(val)/this.moneyPrice;
          }
        },
        //获取图表的默认设置
        getChartSettings : function () {
            var chartSettings = this.getCookie('chartSettings');
            if(chartSettings){
                chartSettings = JSON.parse(chartSettings);
                this.period = chartSettings.charts.period;
                this.theme = chartSettings.theme.toLowerCase();
            }
        },
        // 无缝处理获取交易记录的方法
        getDealRecord: function() {
            var _this = this;
            var doDealRecord = function (res) {
                var datas = res.datas || res.data;
                if(datas.length > 0){
                    _this.dealRecord = datas.slice(0, _this.tradesLimit);
                    if(_this.last_trade_tid != 0){
                        _this.pushTrades(_this.dealRecord);
                    }else{
                        _this.setFirstRecord(_this.dealRecord);
                    }
                    _this.last_trade_tid = _this.dealRecord[_this.dealRecord.length - 1].tid;
                }
            };
            //ajax获取成交记录
            var getDealRecordByAjax = function () {
                var data = {
                    market: _this.market,
                    last_trade_tid : _this.last_trade_tid
                };
                Methods.getJSONP({
                    url: DOMAIN_TRADE + API_PREFIX + 'records',
                    data: data,
                    success: function (res) {
                        doDealRecord(res);
                    }
                });
            };
            //第一次强制请求，不用推送的数据
            if(_this.last_trade_tid == 0){
                //getDealRecordByAjax();
            }
            //webSocket方法获取成交记录
            var getDealRecordByWebsocket = function () {
                var channel = {
                    event : "addChannel",
                    channel : _this.coinType + _this.moneyType + "_cny_lasttrades",
                    last_trade_tid : _this.last_trade_tid
                }
                //如果没有则初始化
                if(typeof ExxWebSocket.channelManage.dealRecord == 'undefined'){
                    ExxWebSocket.channelManage.dealRecord = {
                        message : channel,
                        sended :false,
                        method : function (json) {
                            //第一次推送的时候顺序反了 前端处理下
                            //if(_this.last_trade_tid == 0 || json.data.length == 50){
                                //json.data.reverse();
                            //}
                            //console.log(json.data);
                            doDealRecord(json);
                        }
                    };
                }
            }
            if(ExxWebSocket && ExxWebSocket.openWebSocket){
                getDealRecordByWebsocket();
            }else{
                getDealRecordByAjax();
            }
        },
        // 获取盘口数据
        getDishData: function() {
            var _this = this;

            var doDishData = function (res) {
                //封装为统一的结构
                var result = {
                    datas : {}
                } ;
                //正常请求的数据处理
                if(res.datas){
                    _this.currentPrice = res.datas.currentPrice;
                    result.currentPrice = res.datas.currentPrice;
                    //兼容写法
                    if(res.datas.listUp){
                        //数组的深拷贝Array.slice(0)，不影响赋值的引用
                        result.datas.asks = res.datas.listUp.slice(0);
                        result.datas.bids  = res.datas.listDown.slice(0);
                        //_this.ask = res.datas.listUp.slice(0);
                        //_this.bid  = res.datas.listDown.slice(0);
                    }else{
                        result.datas.asks = res.datas.asks.slice(0);
                        result.datas.bids  = res.datas.bids.slice(0);
                        //_this.ask = res.datas.asks.slice(0);
                        //_this.bid  = res.datas.bids.slice(0);
                    }
                }else{
                    //推送的数据处理
                    _this.currentPrice = res.currentPrice;
                    result.datas.asks = res.asks.slice(0);
                    result.datas.bids = res.bids.slice(0);
                }
                //倒序
                //res.datas.asks.reverse();
                //处理盘口的方法
                _this.updateDepth(result.datas);
            }
            var getDishDataByAjax = function(){
                var data = {
                    market: _this.market,
                    length: _this.depthShowSize
                };
                Methods.getJSONP({
                    url: DOMAIN_TRADE + API_PREFIX + 'dish',
                    data: data,
                    success: function (res) {
                        doDishData(res);
                    }
                });
            }
            var getDishDataByWebsocket = function () {
                var channel = {
                    event : "addChannel",
                    channel : _this.coinType + _this.moneyType + "_cny_depth"
                }
                //如果没有则初始化
                if(typeof ExxWebSocket.channelManage.dishData == 'undefined'){
                    ExxWebSocket.channelManage.dishData = {
                        message : channel,
                        sended :false,
                        method : function (json) {
                            doDishData(json);
                        }
                    };
                }
            }
            if(ExxWebSocket && ExxWebSocket.openWebSocket){
                getDishDataByWebsocket();
                //getDishDataByAjax();
            }else{

                getDishDataByAjax();
            }
        },
        // 获取图表的盘口数据
        getKlineDish: function() {
          var data = {
            market: this.market,
            length: 5
          };
          if (this.chartType === 'depth') {
            Methods.getJSONP({
              url: DOMAIN_TRADE + API_PREFIX + 'getKlineDish',
              data: data,
              success: function (res) {
                this.chartAsks = res.datas.asks;
                this.chartBids = res.datas.bids;
              }.bind(this)
            });
          }
        },
        // 获取币价汇率
        getPriceRate: function(callback) {
          Methods.ajax({
            url: DOMAIN_DEV + "/exchange/controller/website/user/pricecontroller/" + 'getassistprice',
            success: function (res) {
              this.allPriceRate = res.datas;
              store.state.allPriceRate = res.datas;
              this.sharedState.allPriceRate = res.datas;
              //var oriPrice = res.datas.prices[this.moneyType];
              /*if (res.datas.rate['USD_CNY']) {
                this.rate = res.datas.rate['USD_CNY'];
              }*/
              //this.oriPiece = oriPrice;
              //this.moneyPrice = oriPrice/this.rate;
              if(typeof callback == 'function'){
                callback();
              }
            }.bind(this)
          });
        },
        //获取用户委托记录
        getEntrustRecord: function() {
          if (!ISLOGIN) {
            return
          }
          var data = {
            market: this.market,
            userId: this.sharedState.currentAccountId,
            pageSize: 5
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'getEntrustRecord',
            data: data,
            success: function (res) {
              this.entrustRecord = res.datas.record;
            }.bind(this)
          });
        },
        cancelSafePwd: function() {
          this.showSafePwd = false;
          this.safePwd = '';
        },
        bindSetPrice: function () {
            var _this = this;
            var $priceInput = $('#' + this.market + ' .priceInput');
            var $numInput = $('#' + this.market + ' .numberInput');
            var $buyBtn = $('#' + this.market + ' .button.buy');
            var $sellBtn = $('#' + this.market + ' .button.sell');
            //console.log($('#' + this.market).offsetTop());
            $("#asks").on('click', '.row', function () {
              var depthNumber = 0 ;
              var price = $(this).find(".prices").text();
              var displayPrice = $(this).find(".usd").text();
              if($(this).parents("#asks").length > 0){
                for(i = $(this).index() ; i < $("#asks .row").length; i ++){
                  depthNumber = parseFloat(depthNumber) + parseFloat($("#asks .row").eq(i).find(".amount").text());
                }
              }
              $priceInput.val(displayPrice);
              $priceInput.attr('data-ori', price);
              $('#' + _this.market).addClass('active-buy');
              // 点击后高亮提示取到的价格和数量和购买按钮
              $buyBtn.removeClass('disabled');
              $sellBtn.addClass('disabled');
              setTimeout(function(){
                $('#' + _this.market).removeClass('active-buy');
                // 闪烁后购买按钮和卖出按钮同时可用
                $buyBtn.removeClass('disabled');
                $sellBtn.removeClass('disabled');
              }, 800);

              $numInput.val(depthNumber.toFixed(3));
            });
            $("#bids").on('click', '.row', function () {
              var depthNumber = 0 ;
              var price = $(this).find(".prices").text();
              var displayPrice = $(this).find(".usd").text();
              for(i = 0; i <= $(this).index(); i ++){
                depthNumber = parseFloat(depthNumber) + parseFloat($("#bids .row").eq(i).find(".amount").text());
              }
              $priceInput.val(displayPrice);
              $('#' + _this.market).addClass('active-sell');
              $buyBtn.addClass('disabled');
              $sellBtn.removeClass('disabled');
              setTimeout(function(){
                $('#' + _this.market).removeClass('active-sell');
                $buyBtn.removeClass('disabled');
                $sellBtn.removeClass('disabled');
              }, 800);
              $priceInput.attr('data-ori', price);
              $numInput.val(depthNumber.toFixed(3));
            });
        },
        setPrice: function(price) {
        },
        setBuyPrice: function(price) {
          this.buyPrice = price;
        },
        setSellPrice: function(price) {
          this.sellPrice = price;
        },
        handleBuy: function() {
          if (this.buyPrice.toString().length && this.buyQuantity.toString().length) {
            //this.showSafePwd = true;
            this.isBuy = 1;
            this.handleEntrustSubmit();
          } else {
            JuaBox.showWrong("<%= LANG('请输入价格和数量') %>")
          }
        },
        handleSell: function() {
          if (this.sellPrice.toString().length && this.sellQuantity.toString().length) {
            //this.showSafePwd = true;
            this.isBuy = 0;
            this.handleEntrustSubmit();
          } else {
            JuaBox.showWrong("<%= LANG('请输入价格和数量') %>")
          }
        },
        // 提交委托
        handleEntrustSubmit: function() {
          var unitPrice = '';
          var triggerPrice = '';
          var number = '';
          if (this.isBuy === 1 && !this.isReal) {
            unitPrice = this.buyPrice;
            number = this.buyQuantity;
          } else if (this.isBuy === 1 && this.isReal) {
            triggerPrice = this.buyPrice;
            number = this.buyQuantity;
          } else if (this.isBuy === 0 && !this.isReal) {
            unitPrice = this.sellPrice;
            number = this.sellQuantity;
          } else if (this.isBuy === 0 && !this.isReal) {
            triggerPrice = this.sellPrice;
            number = this.sellQuantity;
          }
          var data = {
            //safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
            safePwd: this.safePwd,
            userId: this.sharedState.currentAccountId,
            market: this.market,
            isBuy: this.isBuy,
            isReal: this.isReal,
            unitPrice: unitPrice,
            number: number,
            triggerPrice: triggerPrice
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'doEntrust',
            data: data,
            success: function (res) {
              this.showSafePwd = false;
              this.buyPrice = '';
              this.$refs.buyPrice.value = '';
              this.$refs.sellPrice.value = '';
              this.$refs.sellQuantity.value = '';
              this.$refs.buyQuantity.value = '';
              this.sellPrice = '';
              this.safePwd = '';
              this.sellQuantity = '';
              this.buyQuantity = '';
              this.getEntrustRecord();
              JuaBox.showRight("<%= LANG('提交委托成功') %>");
            }.bind(this)
          });
        },
        handleEntrustCancel: function(id, isReal, market) {
          var market = market || this.market;
          var userId = Methods.getCookie(ENV+'currentAccountId') || '';
          var data = {
            isReal: isReal,
            market: market,
            userId: userId,
            entrustId: id
          };
          Methods.getJSONP({
            url: DOMAIN_TRADE + API_PREFIX + 'doCancelEntrust',
            data: data,
            success: function (res) {
              $.toast({
                heading: '<%= LANG("取消委托成功") %>',
                text: '<%= LANG("取消委托成功") %>',
                icon: 'success',
                loader: true,        // Change it to false to disable loader
                loaderBg: '#9EC600'  // To change the background
              });
              this.getEntrustRecord();
            }.bind(this)
          });
        },
        equalHeight: function() {
          var centerHeight = this.$refs.center.offsetHeight;
          this.$refs.deal.style.height = (centerHeight - 483) + 'px'
        },
        //盘口处理方法
        updateDepth:function(data){
          if(!data)return;

            //增量更新的合并盘口方法
            var mixArray = function(oldArray, newArray, type){
                var m = new top.hashMap();
                var n = new top.hashMap();
                var resultArray = [];

                for (var i = 0, ilength = oldArray.length; i < ilength; i++) {
                    m.put(parseFloat(oldArray[i][0]), oldArray[i][1]);
                }
                for (var i = 0, ilength = newArray.length; i < ilength; i++) {
                    n.put(parseFloat(newArray[i][0]), newArray[i][1]);
                }

                m.each(function(key, value, index) {
                    var na = n.get(key);
                    if (na) {
                        m.put(key, na);
                    }
                });
                n.each(function(key, value, index) {
                    if (value == 0) {
                        m.remove(key);
                    } else {
                        m.put(key, value);
                    }
                });
                m.each(function(key, value, index) {
                    resultArray[index] = []
                    resultArray[index][0] = key;
                    resultArray[index][1] = value;
                });
                //console.log(resultArray);
                return resultArray.reverse();
            }
            //计算最大深度值
            var getMaxDepth = function (depth) {
                var maxNum = 0 ;
                //求卖单最大深度值
                for(var i = 0;i < depth.length; i++){
                    if(parseFloat(depth[i][1]) > maxNum){
                        maxNum = parseFloat(depth[i][1]);
                    }
                }
                return maxNum;
            }

          if(this.lastDepth == ''){
            this.lastDepth={};
            this.lastDepth.asks=data.asks;
            this.lastDepth.bids=data.bids;

            this.depthInit(this.lastDepth.asks, $("#asks .table"));
            this.depthInit(this.lastDepth.bids, $("#bids .table"));
            //初始化之后获取一次盘口深度数据
            this.ask = data.asks.slice(0);
            this.bid  = data.bids.slice(0);
          }else{
            //处理增量推送
            var resultAsksArray ,resultBidsArray;
            if(ExxWebSocket.openDishUpdata){
              //console.log( data);
              resultAsksArray = mixArray(this.lastDepth.asks, data.asks);
              resultBidsArray = mixArray(this.lastDepth.bids, data.bids);
            }else{
              resultAsksArray = data.asks;
              resultBidsArray = data.bids;
            }
            //深度的盘口数据在合并之后获取
            this.ask = resultAsksArray.slice(0);
            this.bid  = resultBidsArray.slice(0);

            var parentAsks=$("#asks .table");
            parentAsks.find("div.remove").remove();
            parentAsks.find("div.add").removeClass("add");
            var newasks=resultAsksArray;
            var oldasks=this.lastDepth.asks;
            this.asksAndBids(newasks.slice(0),oldasks.slice(0),parentAsks, getMaxDepth(resultAsksArray.slice(0)));
            this.lastDepth.asks=newasks;
            //console.log(newasks.slice(0),oldasks);

            var parentBids=$("#bids .table");
            parentBids.find("div.remove").remove();
            parentBids.find("div.add").removeClass("add");
            var newbids=resultBidsArray;
            var oldbids=this.lastDepth.bids;
            this.asksAndBids(newbids.slice(0),oldbids.slice(0),parentBids, getMaxDepth(resultBidsArray.slice(0)));
            this.lastDepth.bids=newbids;
            //console.log(newbids.slice(0),oldbids);
          }
        },
        //初始化盘口
        depthInit:function(data,$obj){
          $obj.empty();
          //console.log(data);
          if(data && data.length>0){
            var lastInt,view="",maxDepthNum = 0;
            //求最大深度值
            for(var i = 0;i < data.length; i++){
              if(parseFloat(data[i][1]) > maxDepthNum){
                maxDepthNum = parseFloat(data[i][1]);
              }
            }
            for(var i = 0;i < data.length; i++){
              var arr = (data[i][0]+"").split(".");
              var prices = this.getPrice(arr,lastInt);
              lastInt=arr[0];
              arr=(data[i][1]+"").split(".");
              var amounts=this.getAmount(arr);
              var usd = parseFloat(data[i][0]) * this.moneyPrice;
              var depth = parseFloat(data[i][1]) / maxDepthNum * 100;
              view+="<div class='row'>";
              view+="<span class='prices'>"+prices[0]+"<g>."+prices[1]+"</g></span>";
              view+="<span class='usd'>"+usd.toFixed(3)+"</span>";
              view+="<span class='amount'>"+amounts[0]+"<g>."+amounts[1]+"</g></span>";
              view+="<span class='depth'><i style='width:"+depth+"%'></i></span>";
              view+="</div>";
            }
            $obj.append(view);
            view=null;
            //绑定盘口点击事件
            this.bindSetPrice();
          }
        },
        //盘口动画效果
        asksAndBids:function(addasks,oldasks,tbDiv,maxDepth){
          for(var i=0;i<oldasks.length;i++){
            var isExist=false;
            for(var j=0;j<addasks.length;j++){
              if(oldasks[i][0]==addasks[j][0]){
                isExist=true;
                if(oldasks[i][1] != addasks[j][1]){
                    //console.log(oldasks , addasks);
                  var $amount=tbDiv.find("div:eq("+i+") .amount");
                  var $depth=tbDiv.find("div:eq("+i+") .depth i");
                  var $usd=tbDiv.find("div:eq("+i+") .usd");
                  var amounts=this.getAmount((addasks[j][1]+"").split("."));
                  var depth = (parseFloat(addasks[j][1]) / maxDepth * 100) + '%';
                  var usd = parseFloat(addasks[j][0]) * this.moneyPrice;
                  $amount.addClass(oldasks[i][1]>addasks[j][1]?"red":"green");
                  $depth.css("width", depth);
                  setTimeout((function($amount,amounts,$usd,usd){
                    return function(){
                      $amount.html(amounts[0]+"<g>."+amounts[1]+"</g>");
                      $usd.html(usd.toFixed(3));
                      $amount.removeClass("red").removeClass("green");
                      $amount=null;
                      amounts=null;
                      $usd=null;
                      usd=null;
                    };
                  })($amount,amounts,$usd,usd), 500);
                }
                addasks.splice(j,1);
                break;
              }
            }
            if(!isExist){
              tbDiv.find("div:eq("+i+")").addClass("remove");
              oldasks[i][2]=-1;//标识该数据对应div被移除
            }
          }
          for(var j=0;j<oldasks.length;j++){
            for(var i=0;i<addasks.length;i++){
              if(addasks[i][0]>oldasks[j][0]){
                var arr=(addasks[i][1]+"").split(".");
                var prices = addasks[i][0];
                var amounts=this.getAmount(arr);
                var usd = parseFloat(addasks[i][0]) * this.moneyPrice;
                var depth = parseFloat(addasks[i][1]) / maxDepth * 100;
                tbDiv.find("div:eq("+j+")").before("<div class='row add'>" +
                    "<span class='prices'></span> " +
                    "<span class='usd'>"+usd.toFixed(3)+"</span> " +
                    "<span class='amount'>"+amounts[0]+"<g>."+amounts[1]+"</g></span>" +
                    "<span class='depth'><i style='width:"+depth+"%'></i></span>" +
                    "</div>");
                oldasks.splice(j,0,addasks[i]);
                addasks.splice(i,1);
                break;
              }
            }
          }
          var totalDiv="";
          for(var i=0;i<addasks.length;i++){
            oldasks.push(addasks[i]);
            var arr=(addasks[i][1]+"").split(".");
            var amounts=this.getAmount(arr);
            var prices = addasks[i][0];
            var usd = parseFloat(addasks[i][0]) * this.moneyPrice;
            var depth = parseFloat(addasks[i][1]) / maxDepth * 100;
            totalDiv+="<div class='row add'>" +
                "<span class='prices'></span>" +
                "<span class='usd'>"+usd.toFixed(3)+"</span> " +
                "<span class='amount'>"+amounts[0]+"<g>."+amounts[1]+"</g></span>" +
                "<span class='depth'><i style='width:"+depth+"%'></i></span>" +
                "</div>";
          }
          if(totalDiv.length>0){
            tbDiv.append(totalDiv);
          }
          totalDiv=null;

          var lastInt;
          for(var i=0;i<oldasks.length;i++){
            var $div=tbDiv.find("div:eq("+i+")");
            if(!(oldasks[i].length>=3 && oldasks[i][2]==-1)){
              var arr=(oldasks[i][0]+"").split(".");
              var prices=this.getPrice(arr,lastInt);
              var usd = parseFloat(oldasks[i][0]) * this.moneyPrice;
              //var depth = parseFloat(oldasks[i][1]) / maxDepth * 100;
              lastInt=arr[0];
              $div.find(".prices").html(prices[0]+"<g>."+prices[1]+"</g>");
              $div.find(".usd").html(usd.toFixed(3));
              //$div.find(".depth").find('i').css("width", depth);
            }
          }
          addasks=null;
          oldasks=null;
          tbDiv.find("div.add").slideDown(800);
          setTimeout((function($remove,$add){
            return function(){
              $remove.slideUp(500,function(){
                $(this).remove();
              });
              $add.removeClass("add");
            };
          })(tbDiv.find("div.remove"),tbDiv.find("div.add")), 1000);
        },
        getAsks:function(array,len){
          if(array && array.length>len){
            array.splice(0,array.length-len);
          }
          return array;
        },
        getBids:function(array,len){
          if(array && array.length>len){
            array.splice(len,array.length-1);
          }
          return array;
        },
        getPrice:function(arr,lastInt){
          if(arr[1] == undefined){
            arr[1] = 0;
          }
          var arrStr = arr[0] + "." + arr[1];
          arrStr = Methods.fixNumber(parseFloat(arrStr),6);
          arrStr = arrStr.split(".");

          return [arrStr[0],arrStr[1]];
        },
        getAmount:function(arr){
          if(arr[1] == undefined){
            arr[1] = 0;
          }
          var arrStr = arr[0] + "." + arr[1];
          arrStr = Methods.fixNumber(parseFloat(arrStr),3);
          var	arrStr = arrStr.split(".");

          return [arrStr[0],arrStr[1]];
        },
          dateFormatTf:function(i){
              return (i < 10 ? '0' : '') + i;
          },
          dateFormat:function(currentDate){
              return currentDate.getFullYear()
                  +"-"+this.dateFormatTf(currentDate.getMonth() + 1)
                  +"-"+this.dateFormatTf(currentDate.getDate())
                  +" "+this.dateFormatTf(currentDate.getHours())
                  +":"+this.dateFormatTf(currentDate.getMinutes())
                  +":"+this.dateFormatTf(currentDate.getSeconds());
          },
        //处理成交记录
          setFirstRecord:function(item){
              var $this = this ;
              if(item!=null && item.length > 0){
                  //初始化50条交易记录
                  var totalUls = "";
                  for(var i = item.length-1; i >=0; i--){
                      $this.tradeDate.setTime(item[i].date*1000);
                      var dateStr=$this.dateFormatTf($this.tradeDate.getHours())
                          +":"+$this.dateFormatTf($this.tradeDate.getMinutes())
                          +":"+$this.dateFormatTf($this.tradeDate.getSeconds());

                      var formatPrice = Methods.fixNumber(item[i].price, 6);
                      //折价计算
                      formatPrice = Methods.fixNumber(item[i].price * $this.moneyPrice, 3);
                      var formatAmount = Methods.fixNumber(item[i].amount, 3);
                      var arr = formatAmount.split(".");
                      totalUls += "<ul><li class='tm'>"+dateStr+"</li><li class='pr-"+(item[i].type=='buy' ? 'green':'red')+"'>"+formatPrice+"</li><li class='vl'>"+arr[0]+"<g>."+arr[1]+"</g></li></ul>";
                  };
                  $("#trades .trades_list").html(totalUls);
              }
          },
          pushTrades:function(array){
              var $this = this;
              var $trades=$("#trades .trades_list");
              var totalUls="";
              if(array == '' && array.length == 0){
                  return false;
              }
              for(var i=0;i<array.length;i++){
                  var item=array[i];
                  if(i>=array.length-this.tradesLimit){
                      if(item.tid<=$this.last_trade_tid) continue;
                      this.tradeDate.setTime(item.date*1000);
                      var dateStr=this.dateFormatTf(this.tradeDate.getHours())
                          +":"+this.dateFormatTf(this.tradeDate.getMinutes())
                          +":"+this.dateFormatTf(this.tradeDate.getSeconds());

                      var formatPrice = Methods.fixNumber(item.price, 6);
                      //折价计算
                      formatPrice = Methods.fixNumber(item.price * $this.moneyPrice, 3);
                      var formatAmount = Methods.fixNumber(item.amount, 3);
                      var arr = formatAmount.split(".");

                      if(this.last_trade_tid != 0){
                          totalUls="<ul class='newul'><li class='tm'>"+dateStr+"</li><li class='pr-"+(item.type=='buy'?'green':'red')+"'>"+formatPrice+"</li><li class='vl'>"+arr[0]+"<g>."+arr[1]+"</g></li></ul>"+totalUls;
                      }else{
                          totalUls="<ul><li class='tm'>"+dateStr+"</li><li class='pr-"+(item.type=='buy'?'green':'red')+"'>"+formatPrice+"</li><li class='vl'>"+arr[0]+"<g>."+arr[1]+"</g></li></ul>"+totalUls;
                      }
                  }
              }
              if(this.last_trade_tid != 0){
                  $trades.prepend(totalUls);
              }else{
                  $trades.append(totalUls);
              }
              totalUls=null;
              $trades.find("ul.newul").slideDown(1000,function(){
                  $(this).removeClass("newul");
              });
              //删除大于100条的数据
              $trades.find("ul:gt("+(this.tradesLimit-1)+")").remove();
          },
        handleClickOutsideTip: function (e) {
          var sell = this.$refs.sell;
          var buy = this.$refs.buy;
          if (!sell.contains(e.target)) {
            this.showSellTip = false;
          }
          if (!buy.contains(e.target)) {
            this.showBuyTip = false;
          }
        }
      },
      created: function() {
        this.getPriceRate(this.getDishData);
        this.getChartSettings();
        //this.getPubKey();
        this.getEntrustRecord();
      },
      mounted: function () {
        var _this = this;
        //第一次就执行，不等定时器
        this.getDishData();
        this.getEntrustRecord();
        this.getDealRecord();
        this.getPriceRate();
        //this.equalHeight();
        //setInterval(this.getKlineDish, 2000);
        //开始定时器任务
        setInterval(this.getDishData, 2000);
        setInterval(this.getEntrustRecord, 3000);
        setInterval(this.getDealRecord, 2000);
        setInterval(this.getPriceRate, 10000);
        this.bindAutoHeight();
        $(window).resize(function(){
           _this.bindAutoHeight();
        });
        $('[data-toggle="tooltip"]').tooltip()
      },
      updated: function() {
        $('[data-toggle="tooltip"]').tooltip();
      },
      watch: {
        currentPrice: function(newVal, oldVal) {
          this.priceTrend = (newVal > oldVal) ? 'up' : 'down';
          this.currentPriceCovert = Methods.fixNumber(newVal * this.moneyPrice, 3)
        },
        moneyPrice: function (newVal) {
          this.currentPriceCovert = Methods.fixNumber(this.currentPrice * this.moneyPrice, 3);
        }
      },
      beforeDestroy: function() {
      }
    });

      function b(){
          t = parseInt(x.css('top'));
          y.css('top','32px');
          x.animate({top: t - 32 + 'px'},'slow');	//19为每个li的高度
          if(Math.abs(t) == h-32){ //19为每个li的高度
              y.animate({top:'0px'},'slow');
              z=x;
              x=y;
              y=z;
          }
          setTimeout(b,3000);//滚动间隔时间 现在是3秒
      }

      $(function() {
        $('#ask .row').on('click', function(){
        });

          function textroll(){
              objtop = parseInt(theobj.css('top'));
              copyobj.css('top','32px');
              theobj.animate({top: objtop - 32 + 'px'},'slow');	//32为每个li的高度
              if(Math.abs(objtop) == objheight-32){ //32为每个li的高度
                  copyobj.animate({top:'0px'},'slow');
                  zobj=theobj;
                  theobj=copyobj;
                  copyobj=zobj;
              }
          }
          $('.swap').html($('.news_li').html());
          theobj = $('.news_li');
          copyobj = $('.swap');
          theParent = theobj.parent();
          objheight = $('.news_li li').length * 32; //32为每个li的高度
          var theTime = setInterval(textroll,3000);//滚动间隔时间 现在是3秒
          theParent.mouseenter(function(){
              clearInterval(theTime);
              return;
          });
          theParent.mouseout(function(){
              theTime = setInterval(textroll,3000);
              return;
          })

      });


  });

</script>
