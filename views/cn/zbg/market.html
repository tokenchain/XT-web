<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="zxx">
<!--<![endif]-->

<head>
    <script type="text/javascript">
        var GLOBAL             = {},
            EXX = {},
            ENV               = GLOBAL['ENV']       = '<%= ENV %>',
            LAN               = GLOBAL['LAN']       = '<%= LAN %>',
            MONEY               = GLOBAL['MONEY']       = '<%= MONEY || "usd" %>',
            ISLOGIN               = GLOBAL['ISLOGIN']       = <%= Boolean(isLogin) %>,
            VERSION            = GLOBAL['VERSION']           = '<%= VERSION %>',
            DOMAIN_BASE        = GLOBAL['DOMAIN_BASE']       = '<%= DOMAIN_BASE %>',
            DOMAIN_DEV        = GLOBAL['DOMAIN_DEV']       = '<%= DOMAIN_DEV %>',
            WEBSOCKET        = GLOBAL['WEBSOCKET']       = '<%= WEBSOCKET %>';

        document.domain = DOMAIN_BASE;
    </script>
    <meta charset="utf-8">
    <meta name="author" content="Axilweb">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>市场</title>
    <link rel="icon" href="<%= STATIC %>/images/favicon/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="<%= STATIC %>/styles/xuleipro.css?<%= VERSION %>">
    <link rel="stylesheet" type="text/css" href="<%= STATIC %>/styles/cssdna.css?<%= VERSION %>">
    <script src="<%= STATIC %>/scripts/zbg/js/vendor/jquery-3.2.1.min.js"></script>
    <script src="/lib/requirejs/require.js"></script>
    <script type="text/javascript" src="<%= STATIC %>/scripts/main.js?<%= VERSION %>"></script>
</head>
<body>
<%-include("../include/head.html")%>
    <section class="home-market" id="markets">
        <div class="cd-nav">
            <ul>
                <li class="active"><a href="/market">  ZBG<%= LANG('市场')%> </a></li>
                <li><a href="/marketglobal"> <%= LANG('全球市场')%> </a></li>
                <li><a href="/newmarket"><%= LANG('上币排行')%></a></li>
            </ul>
        </div>
        <div class="cd-nav-aux">
            <ul>
                <li class="active" @click="changeMarketsTab('hot')"><a role="button"><%= LANG('全部')%></a></li>
                <!--<li @click="changeMarketsTab('qc')"><a role="button">QC <%= LANG('区')%></a></li>-->
                <li @click="changeMarketsTab('usdt')"><a role="button">USDT <%= LANG('区')%></a></li>
                <li @click="changeMarketsTab('zt')"><a role="button">ZT <%= LANG('区')%></a></li>
                <!--<li @click="changeMarketsTab('btc')"><a role="button">BTC <%= LANG('区')%></a></li>-->
                <!--<li @click="changeMarketsTab('eth')"><a role="button">ETH区</a></li>-->
            </ul>
        </div>
        <div class="market-search"><input placeholder="<%= LANG('搜索')%>" type="text" autocomplete="off" name="search_1530688781509"> <i class="exx exx-search"></i></div>
            <div class="container-fluid">
                <div class="cd-table">
                    <div class="head">
                        <ul>
                            <li class="coin-name"><%= LANG('币种')%> </li>
                            <li class="new-price"><%= LANG('最新价')%></li>
                            <li role="button" class="sort">24H <%= LANG('涨幅')%><em></em></li>
                            <li>24H <%= LANG('高')%>  /<%= LANG('低')%></li>
                            <li role="button" class="sort down">24H <%= LANG('成交量')%><em></em></li>
                            <li><%= LANG('操作')%> </li>
                        </ul>
                    </div>
                    <div class="body">
                            <ul @click="goExchange(1, data.market.replace('/','_'))" v-for="(data, index) in displayMarkets" v-if="marketConfig && assistPrice" v-cloak  role="button">
                                <li class="coin-name"><img class="icon-coin" :src="'<%= STATIC %>/images/icon/coin/' + data.market.split('_')[0] + '.svg?<%= VERSION%>'" /><b>{{data.market.split('_')[0].toUpperCase()}} <span>/ {{data.market.split('_')[1].toUpperCase()}}</span></b></li>
                                <li class="new-price" :class="data.rate >= 0 ? 'red-color' : 'green-color'" >{{showMoney(data.lastPrice, data.market)}}</li>
                                <li class="increase"><span :class="data.rate >= 0 ? 'green-color' : 'red-color'">{{ data.rate >= 0 ? '+' + showRate(data.rate) : '' + showRate(data.rate) }}%</span></li>
                                <li>{{data.highPrice |capitalize}} / {{data.lowPrice |capitalize}}</li>
                                <li>{{showCoin(data.volume, data.market)}}</li>
                                <li><a> <%= LANG('去交易')%></a></li>
                            </ul>
                    </div>
                    <div v-if="!marketAreaListSwitch && !webIdSwitch && !assistPriceSwitch && !websocketSwitch" class="cd-loading">
                        <div class="vertical-bars">
                            <p class="layer-1"></p>
                            <p class="layer-2"></p>
                            <p class="layer-3"></p>
                            <p class="layer-4"></p>
                            <p class="layer-5"></p>
                            <p class="layer-6"></p>
                            <p class="layer-7"></p>
                            <p class="layer-8"></p>
                            <p class="layer-9"></p>
                        </div>
                    </div>
                </div>
            </div>
    </section>
    <!--<script src="/src/js/ribbons.js"></script>-->

</body>
</html>
<script>
    require(['vue', 'common/methods'], function(Vue, Methods) {
        var homeMarket = new Vue({
            el: "#markets",
            data: function() {
                return {
                    isFirst : false,
                    marketInit : false,
                    keyWord : '',
                    mLength : 0,
                    //rateUp,rateDown,volumeUp,volumeDown
                    sortBy : 'volumeDown',
                    assistPrice : null,
                    dWidth : window.document.body.offsetWidth,
                    markets: [],
                    isMobile : Methods.isMobile(),
                    currentExchangeMode : 1,
                    marketsTab: 'hot',
                    marketConfig: {},
                    lineChartSettings: {
                        fill: "",
                        height: 18,
                        stroke: "#cccccc",
                        strokeWidth: 1.5,
                        width: 61
                    },
                    assistList : {
                        'none': {key:'none', name: "<%= LANG('默认')%>", icon: '', symbol: '฿',decimal : 6},
                        /*'btc': {key: 'btc', name: 'BTC', icon: 'icon-btc', symbol: '฿',decimal : 6},*/
                        'usd': {key: 'usd', name: 'USD', icon: 'icon-meiyuan', symbol: '$',decimal : 3},
                        '<%= UNIT %>': {key: '<%= UNIT %>', name: '<%= LEGAL[UNIT].unit %>', icon: '', symbol: '<%= LEGAL[UNIT].note %>',decimal : '<%= LEGAL[UNIT].decimal %>'}
                    },
                    websocket: '', //websocket服务,
                    marketAreaList: [],
                    marketAreaListSwitch: false,
                    webIdSwitch:false,
                    assistPriceSwitch: false,
                    websocketSwitch: false
                }
            },
            computed: {
                // 将市场id转为 市场名字符串 返回对象
                marketsIdSwitch: function () {
                    var marketId = {};
                    if (this.marketConfig) {
                        for (var a = 0; a < this.markets.length; a++) {
                            for (var b = 0; b < this.marketConfig.length; b++) {
                                if (this.markets[a][0] == this.marketConfig[b].marketId){
                                    // if ((this.markets[a][0] + 2) == this.marketConfig[b].marketId){
                                    marketId[this.marketConfig[b].marketId] = this.marketConfig[b].name;  //格式: '1': btc/qtum
                                }
                            }
                        }
                    }
                    return marketId;
                },
                //推荐市场,目前显示全部 (旧逻辑根据某个字段布尔值过滤) -ok
                hotMarkets: function() {
                    var _this = this;
                    var markets = [];
                    var oriMarkets = this.markets;

                    oriMarkets.forEach(function (item, index) {
                        var currMarketName = _this.marketsIdSwitch[item[0]];
                        if (currMarketName) {
                            //过滤后的数组
                            markets.push(item);
                        }
                    });

                    return this.doSortMarket(this.convertMarket(markets));
                },
                //暂弃用
                mockMarkets: function() {
                    var markets = {};
                    var oriMarkets = this.markets;
                    Object.keys(this.markets).map(function(market){
                        if (oriMarkets[market]) {
                            markets[market] = oriMarkets[market];
                        }
                    });
                    return this.doSortMarket(this.convertMarket(markets));
                },
                //过滤要显示的市场
                displayMarkets: function() {
                    var type = this.marketsTab;
                    var keyWord = this.keyWord;
                    //优先搜索
                    if(keyWord != ''){
                        return this.marketsForKeyWord(keyWord.toLowerCase());
                    }else{
                        if (type === 'hot') {
                            return this.hotMarkets
                        } else if (type === 'mock') {
                            // return this.mockMarkets
                            return [];
                        } else {
                            return this.marketsForCoin(type);
                        }
                    }
                }
            },
            methods: {
                isLeverMarket: function(market) {
                    var marketInfo = this.marketConfig[market];
                    //console.log(this.marketConfig);
                    return marketInfo ? marketInfo.leverType : '0'
                },
                moneyPrice: function(money, coin){
                    if(money == 'btc' || money == 'usd' || money == '<%= UNIT %>'){
                        return Number(this.assistPrice[money][coin] ? this.assistPrice[money][coin] : 1)
                    }else{
                        return 1;
                    }
                },
                //获取指定辅助货币的价格
                getPriceByAssist: function (price, market, assist) {
                    if(!price || price == '' || !market || market == '' || this.assistPrice == null){
                        return '--'
                    }
                    var money = market.split('_')[1];
                    //优先取指定的assist
                    var assistCoin = assist || MONEY;
                    if (assistCoin == 'none' || assistCoin == '') {
                        return Methods.fixNumber(price, 4);
                    } else {
                        return Methods.fixNumber(parseFloat(price) * parseFloat(this.assistPrice[assistCoin][money]), this.assistList[assistCoin].decimal) || '--';
                    }
                },
                getPriceByAssistNew: function (price, market, assist) {
                    var price = price;
                    var market = market.split('/')[1];
                    var assist = assist;
                    var assistPrice = this.assistPrice[assist]
                    return assistPrice[market] * price
                },
                //去掉虚拟市场货币的D字符
                getRealCoinName : function (coin) {
                    if(coin && coin.length > 3 && coin.substring(0,1) == 'd'){
                        return coin.substring(1);
                    }else{
                        return coin;
                    }
                },
                goExchange: function(type, market) {
                    Methods.setCookie(ENV + 'ExchangeMode' , type, 7);
                    window.location.href = '/trade/' + market;
                },
                changeMarketsTab: function(type) {
                    // $('html, body').animate({scrollTop: window.innerHeight - 150}, 400);
                    this.keyWord = '';
                    this.marketsTab = type;
                },
                // 获取市场配置
                getMarketConfig: function (callback) {
                    var _this = this;
                    Methods.ajax({
                        // url: DOMAIN_TRADE + API_PREFIX + 'getMarketConfig',
                        url: DOMAIN_DEV + "/exchange/config/controller/website/marketcontroller/" + 'getByWebId',
                        success: function (res) {
                            _this.webIdSwitch = true;
                            _this.marketConfig = res.datas;
                            callback && callback(res.datas);
                        }
                    });
                },
                //按货币分类 -ok
                marketsForCoin: function(coin) {
                    var _this = this;
                    var markets = [];
                    var oriMarkets = this.markets;

                    oriMarkets.forEach(function (item, index) {
                        if (_this.marketsIdSwitch[item[0]]) {
                            var coinName = _this.marketsIdSwitch[item[0]].split('_')[1];
                            if (coinName == coin) {
                                //过滤后的数组
                                markets.push(item);
                            }
                        }
                    });

                    // Object.keys(this.marketsIdSwitch).map(function(market,index){
                    //     console.log(market)
                    //     if (market.split('/')[1] == coin) {
                    //         markets[market] = oriMarkets[market];
                    //     }
                    // });

                    return this.doSortMarket(this.convertMarket(markets));
                },
                // 搜索过滤-ok
                marketsForKeyWord: function(keyword) {
                    var _this = this;
                    var markets = [];
                    var oriMarkets = this.markets;
                    /*Object.keys(this.markets).map(function(market){
                        if (market.indexOf(keyword) != -1 && _this.markets[market][9] == false) {
                            markets[market] = oriMarkets[market];
                        }
                    });*/

                    oriMarkets.forEach(function (item, index) {
                        var currMarketName = _this.marketsIdSwitch[item[0]];
                        if (currMarketName.indexOf(keyword) != -1) {
                            //过滤后的数组
                            markets.push(item);
                        }
                    });

                    return this.doSortMarket(this.convertMarket(markets));
                },
                //转换对象市场为数组市场(为了排序) -ok
                convertMarket : function (result) {
                    var _this = this;
                    var resultArray = [];
                    // console.log(result)
                    result.forEach(function (item, index) {
                        var lineData;
                        try {
                            lineData =  JSON.parse(item[6]);
                        } catch (e) {
                            lineData = '';
                        }

                        var obj = {
                            market : _this.marketsIdSwitch[item[0]], //市场名
                            // 价格
                            lastPrice : item[1], //最新价

                            // buyOne : item[4],
                            // sellOne : item[2],
                            highPrice : item[2], //最高价
                            lowPrice : item[3], //最低价

                            // 成交量
                            volume : item[4],
                            //折算交易量为USD排序
                            convertVolume : _this.getVolumeByAssist(item[4], _this.marketsIdSwitch[item[0]], 'usd'),
                            // 走势图
                            lineData : lineData,
                            //涨跌幅
                            rate : item[5]
                        }
                        resultArray.push(obj);
                    });

                    return resultArray;
                },
                //排序的方法-ok
                doSortMarket : function (markets) {
                    var sortBy = this.sortBy;
                    if(sortBy == '' || markets.length == 0){
                        return markets;
                    }
                    // console.log('markets: ' + markets)
                    markets.sort(function(x, y){
                        if(sortBy == 'rateUp'){
                            // return x.rate - y.rate;
                            return x.rate - y.rate;
                        }else if(sortBy == 'rateDown'){
                            // return y.rate - x.rate;
                            return y.rate - x.rate;
                        }else if(sortBy == 'volumeUp'){
                            // return x.convertVolume - y.convertVolume;
                            return x.convertVolume - y.convertVolume;
                        }else if(sortBy == 'volumeDown'){
                            // return y.convertVolume - x.convertVolume;
                            return y.convertVolume - x.convertVolume;
                        }
                    });
                    return markets;
                },
                changeSort : function (name) {
                    var sortBy = this.sortBy;
                    var swift = function (name, sort) {
                        if(sort == ''){
                            return name + 'Down';
                        }
                        if(sort.indexOf(name) != -1){
                            if(sort.indexOf('Down') != -1){
                                return name + 'Up';
                            }
                            if(sort.indexOf('Up') != -1){
                                return '';
                            }
                        }else{
                            //递归
                            return arguments.callee(name, '');
                        }
                    }
                    this.sortBy = swift(name, sortBy);
                },
                //获取指定辅助货币的价格 -ok
                getVolumeByAssist: function (price, market, assist) {
                    if(!price || price == '' || !market || market == '' || this.assistPrice == null){
                        return ''
                    }
                    var coin = market.split('_')[0];
                    //优先取指定的assist 默认保留4位小数
                    var assistCoin = assist || this.assistCoin;
                    if (assistCoin == 'none' || assistCoin == '') {
                        return Methods.fixNumber(price, 4);
                    } else {
                        return Methods.fixNumber(parseFloat(price) * parseFloat(this.assistPrice[assistCoin][coin]), 4) || '--';
                    }
                },
                // 获取币价汇率 -ok
                getPriceRate: function(callback) {
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/config/controller/website/pricecontroller/" + 'getassistprice',
                        success: function (res) {
                            this.assistPrice = res.datas;
                            this.assistPriceSwitch= true
                            if(typeof callback == 'function'){
                                callback();
                            }
                        }.bind(this),
                        error : function(){
                        }
                    });
                },
                getHomeMarket : function () {
                    var _this = this;
                    /*Methods.getJSONP({
                        url: DOMAIN_TRADE + API_PREFIX + 'getAllMarket',
                        success: function (res) {
                            //处理数据返回格式不统一的问题
                            var result = res.datas ;
                            for(var key in result){
                                _this.mLength += 1;
                                if(result[key].length < 7){
                                    result[key][6] = 0;
                                    result[key][7] = [];
                                    result[key][7][0] = [];
                                    result[key][8] = '0.00';
                                }
                            }
                            _this.markets = result;
                            _this.marketInit = true;
                        }
                    });*/
                    var wsUrl = WEBSOCKET + '/websocket';
                    // var wsUrl = 'ws://192.168.4.95:28080' + '/websocket';

                    //建立握手
                    if ('WebSocket' in window) {
                        _this.websocket = new WebSocket(wsUrl);
                    } else if ('MozWebSocket' in window) {
                        _this.websocket = new MozWebSocket(wsUrl);
                    } else {
                        console.log('Your browser does not support websocket.')
                        return false;
                    }

                    _this.websocket.onopen = function (event) {
                        var marketParam = {
                            dataType: "ALL_TRADE_STATISTIC_24H",
                            dataSize: 1,
                            action: "ADD"
                        }
                        _this.websocket.send(JSON.stringify(marketParam));
                        // console.log('init websocket');

                        //离开或者刷新当前页面时
                        window.onbeforeunload =function() {
                            _this.websocket && _this.websocket.close();
                        }
                    };
                    _this.websocket.onmessage = function (event) {
                        //修改状态
                        if(!_this.marketInit){
                            _this.marketInit = true;
                        }
                        // console.log('数据变化了：')
                        // [ 市场ID, 当前成交价, 最高价，最低价, 24小时成交量，24小时涨跌幅, 分时量（按小时统计）]
                        var res = JSON.parse(event.data);
                        if (typeof res.trade_statistic == 'object') {
                            _this.markets = res.trade_statistic;
                        } else {
                            _this.markets = [];
                        }
                        if (!_this.websocketSwitch) {
                            _this.websocketSwitch = true;
                        }
                    };
                    _this.websocket.onerror = function (event) {
                        //
                    };
                },
                getLineChartColor: function(index, isClose) {
                    var colors = [
                        ['#58A065', 'rgba(67,144,234,0.08)'],
                        ['#4390EB', 'rgba(67,144,234,0.08)'],
                        ['#F7931A', 'rgba(247, 147, 26, 0.08)'],
                        ['#F5D525', 'rgba(244,213,37,0.08)'],
                        ['#5B646F', 'rgba(91,100,111,0.09)'],
                        ['#0ACC9F', 'rgba(10,204,159,0.08)'],
                        ['#6CA4EF', 'rgba(88,160,101,0.08)']
                    ];

                    var colorsClosed = [
                        ['#666', 'rgba(67,144,234,0.08)']
                    ];

                    if(index >= colors.length){
                        index = index % colors.length;
                    }
                    var obj = {
                        fill: "",
                        height: 30,
                        stroke: isClose ? colors[index][0] : colorsClosed[0][0],
                        strokeWidth: 2,
                        width: 100
                    };
                    return obj;
                },
                getLineData : function (array) {
                    if(array.length > 0){
                        var arr = [];
                        //容错处理

                        if(!array){
                            array = []
                        }
                        arr = array.map(function(item){
                            return item[1];
                        });
                        var min = arr[0];
                        for(var i = 0;i < arr.length; i++){
                            if (arr[i] < min) {
                                min = arr[i]
                            }
                        }
                        var arr2 = arr.map(function(item){
                            return item - min;
                        });
                        return arr2.join(",");
                    }else{
                        return '';
                    }
                },
                showRate : function (rate) {
                    return Methods.fixNumber(rate, 2)
                },
                //交易量折合的提示内容
                showVolumeHint : function (volume) {
                    if(parseFloat(volume) > 10000 && parseFloat(volume) < 100000000 ){
                        volume = Methods.fixNumber((parseFloat(volume) / 10000), 2) + "<%= LANG('万')%>";
                    }
                    if(parseFloat(volume) > 100000000 ){
                        volume = Methods.fixNumber((parseFloat(volume) / 100000000), 4) + "<%= LANG('亿')%>";
                    }
                    return "<%= LANG('折合')%>:$ " + volume ;
                },
                showCoin : function (val,market) {
                    if(isNaN(val)){
                        return '--'
                    }else{
                        return Methods.fixDecimal(val, 4)
                    }
                },
                showMoney : function (val,market) {
                    if(isNaN(val)){
                        return '--'
                    }else{
                        return Methods.fixDecimal(val, 6)
                    }
                },
                getMarketAreaListByWebId: function() {
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/config/controller/website/MarketController/" + 'getMarketAreaListByWebId',
                        success: function (res) {
                            this.marketAreaList=res.datas
                            this.marketAreaListSwitch= true
                        }.bind(this)
                    });
                },
            },
            updated : function () {

            },
            created: function(){
                this.getPriceRate();
                this.getMarketAreaListByWebId();
                this.getMarketConfig(function () {
                    this.getHomeMarket();
                    setInterval(this.getPriceRate, 90000);
                    // setInterval(this.getHomeMarket, 5000);
                }.bind(this));
            },
            mounted : function () {
                $('.cd-nav-aux').on('click','li',function () {
                    $(this).addClass('active').siblings().removeClass('active')
                })
            },
            filters: {
                capitalize: function (value) {
                    if (!value) return '0'
                    return (Math.ceil(value*100000))/100000
                },
                thousand:function (value) {
                    if (!value) return '0'
                    return Math.ceil(value)/10000
                }
            }
        });
    });

</script>




