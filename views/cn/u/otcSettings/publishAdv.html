<div id="publishAdv" class="publishAdv">
    <div class="title">
        <div class="tab-box">
            <span :class="advType == 1 ? 'active' : ''" @click="changeAdvType(1)"><%=LANG('买币')%></span><span
                :class="advType == 2 ? 'active' : ''" @click="changeAdvType(2)"><%=LANG('卖币')%></span>
        </div>
    </div>
    <div class="publishAdv-box">
        <form>
            <div class="form-item">
                <label for=""><%=LANG('法币币种')%>：</label>
                <select name="" v-cloak="" @change="changeCurrency" v-model="formModel.legalCurrencyId">
                    <option :value="item.id" v-cloak="" v-for="item in currencyList">{{item.name}}</option>
                </select>
            </div>
            <div class="form-item">
                <label for=""><%=LANG('交易币种')%>：</label>
                <select name="" v-cloak="" @change="changeCoin" v-model="formModel.orderCoin">
                    <option :value="item.shortName" v-cloak="" v-for="item in coinList">{{item.name}}</option>
                </select>
            </div>
            <div class="form-item">
                <label for=""><%=LANG('单价')%>：</label>
                <input type="text" name="orderPrice" v-model="formModel.orderPrice" required number="true"
                       NumThanZero="0">
            </div>
            <div class="form-item" v-if="advType == 2">
                <label for=""><%=LANG('可用数量')%>：</label>
                <span class="describe" v-cloak="">{{amount}} {{ formModel.orderCoin.toUpperCase()}}</span>
            </div>
            <div class="form-item">
                <label for=""><%=LANG('交易数量')%>：</label>
                <input type="text" name="orderAmount" v-model="formModel.orderAmount"
                       required number="true" class="change-valite"
                       NumThanZero="0">
            </div>
            <div class="form-item">
                <label for=""><%=LANG('单笔最小成交额')%>：</label>
                <input type="text" name="orderLimitMin" v-model="formModel.orderLimitMin" required number="true"
                       NumThanZero="0">
            </div>
            <div class="form-item">
                <label for=""><%=LANG('单笔最大成交额')%>：</label>
                <input type="text" name="orderLimitMax" autocomplete="off" v-model="formModel.orderLimitMax" required
                       number="true" NumThanZero="0">
            </div>
            <div class="form-item">
                <label for=""><%=LANG('备注(MEMO)')%>：</label>
                <textarea style="height: unset" name="" cols="30" rows="5" v-model="formModel.memo"></textarea>
            </div>
            <div class="form-item">
                <label for=""><%=LANG('支持支付方式')%>：</label>
                <div class="pay">
                    <label for="" v-for="item in formModel.payId">
                        <input name="payId" type="checkbox" :value="item" v-model="payId" required/>
                        <img :src="imgSrc(item)" alt="">
                    </label>
                </div>
            </div>
            <div class="form-item">
                <label for=""><%=LANG('交易密码')%>：</label>
                <input type="text" name="securityPassword" v-model="formModel.securityPassword"
                       required maxlength="6" onfocus="this.type='password'" autocomplete = 'new-password'>
            </div>
            <div class="bnt">
                <button @click="publishAdvs" type="button"><%=LANG('发布')%></button>
            </div>
            <div class="notice" v-if="advType == 1">
                <p><%=LANG('注意事项：')%></p>
                <p><%=LANG(' 1、请务必转账时确认对方账户信息；')%></p>
                <p><%=LANG('2、请仔细核实款项来源及转账备注，以免银行卡被冻结')%></p>
            </div>
        </form>
    </div>
</div>

<script>
    require(['vue', 'common/methods', 'common/juabox', 'validate'], function (Vue, Methods, JuaBox) {
        var publishAdv = new Vue({
            el: "#publishAdv",
            data: function () {
                return {
                    advType: 1,
                    currencyList: [],
                    coinList: [],
                    amount: "",
                    formModel: {
                        legalCurrencyId: '1',  //法币默认 cny
                        orderCoin: 'xt',  //虚拟币 默认 xt
                        orderPrice: '',   //单价
                        orderAmount: '',  //交易数量
                        orderLimitMax: '',  //单笔最大成交额
                        orderLimitMin: '',   //单笔最小成交额
                        memo: '',  //备注
                        payId: [], //支付方式
                        securityPassword: '',  //交易密码
                    },
                    payId: [],
                    pubKey: '',
                    rsaKeyId: '',
                    reameNameStatus: null,
                    loginUser: Methods.getLocalUserInfo(ENV + 'userInfo'),
                }
            },
            created() {
                this.queryStatus()
                this.getCoinList()
                this.getCurrencyList()
                this.queryMyPayType()
                this.getPubKey()
                if (this.advType == 2) {
                    this.queryAmount()
                }
                if (this.loginUser.safePwdAuth == '0') {
                    JuaBox.confirm("<%=LANG('您还未设置交易密码！')%>", {
                        buttons: {confirm: "去设置"}, callback: function () {
                            window.location.href = 'account'
                        }
                    })
                }
            },
            mounted: function () {
                this.initValte()
            },
            computed: {},
            methods: {
               initValte: function() {
                    //jquery.validator验证配置
                    if (getCookie('wlan') == 'cn') {
                        $.validator.addMethod("NumThanZero", function (value, element) {
                            return this.optional(element) || /^([1-9]\d*(\.\d*[1-9])?)|(0\.\d*[1-9])$/.test(value);
                        }, "请输入大于0的数字")
                        $.validator.addMethod("than", function (value, element, param) {
                            return this.optional(element) || parseFloat(value) >= parseFloat(param);
                        }, $.validator.format("请输入大于或等于 {0} 的数字"))
                        $.validator.addMethod("lessThan", function (value, element, param) {
                            return this.optional(element) || parseFloat(value) <= parseFloat(param);
                        }, $.validator.format("请输入小于或等于 {0} 的数字"))
                        $.extend($.validator.messages, {
                            required: "这是必填项",
                            remote: "请修正此项",
                            email: "请输入有效的电子邮件地址",
                            url: "请输入有效的网址",
                            date: "请输入有效的日期",
                            dateISO: "请输入有效的日期 (YYYY-MM-DD)",
                            number: "请输入有效的数字",
                            digits: "只能输入数字",
                            creditcard: "请输入有效的信用卡号码",
                            equalTo: "你的输入不相同",
                            extension: "请输入有效的后缀",
                            maxlength: $.validator.format("最多可以输入 {0} 个字符"),
                            minlength: $.validator.format("最少要输入 {0} 个字符"),
                            rangelength: $.validator.format("请输入长度在 {0} 到 {1} 之间的字符串"),
                            range: $.validator.format("请输入范围在 {0} 到 {1} 之间的数值"),
                            step: $.validator.format("请输入 {0} 的整数倍值"),
                            max: $.validator.format("请输入不大于 {0} 的数值"),
                            min: $.validator.format("请输入不小于 {0} 的数值")
                        });
                    }
                },
                imgSrc: function (payId) {
                    return `<%= IMG_STATIC %>/images/${['', '', 'UnionPay', 'aliPay', 'tencentPay', 'paypal', 'usdPay'][payId]}.png`
                },
                changeCurrency: function (e) {
                    this.formModel.legalCurrencyId = e.target.value
                    var tode = this.currencyList.find(function (item) {
                        return item.id == e.target.value
                    })
                    this.getCoinList(tode.shortName.toLowerCase())
                    this.queryAmount()
                },
                changeCoin: function (e) {
                    this.formModel.orderCoin = e.target.value
                    this.queryAmount()
                },
                changeAdvType: function (type) {
                    this.advType = type
                    if (type == 2) {
                        this.queryAmount()
                    }
                    this.queryStatus()
                },
                getCoinList: function (name) {   //查询 币种列表
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectCoinLists',
                        data: {
                            legalCurrencyName: name ? name : 'cny'
                        },
                        success: function (res) {
                            this.coinList = res.datas
                            this.formModel.orderCoin = this.coinList[0].shortName
                        }.bind(this)
                    })
                },
                getCurrencyList: function () {  //查询法币接口
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectCurrency',
                        data: {},
                        success: function (res) {
                            this.currencyList = res.datas
                        }.bind(this)
                    })
                },
                queryAmount: function () { //查询余额
                    var data = {
                        currencyTypeName: this.formModel.orderCoin
                    }
                    Methods.ajax({
                        type: 'POST',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectUserExchangeCoinAmount',
                        data: data,
                        success: function (res) {
                            this.amount = res.datas.amount
                        }.bind(this)
                    })
                },
                queryStatus: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/queryOtherMerchant',
                        data: {
                            userId: this.loginUser.userId
                        },
                        success: function (res) {
                            this.reameNameStatus = res.datas
                            if (res.datas == null) {
                                JuaBox.confirm("<%=LANG('您还未高级实名认证！')%>", {
                                    buttons: {confirm: "去认证"}, callback: function () {
                                        window.location.href = 'account'
                                    }
                                })
                            }
                        }.bind(this)
                    })
                },
                checkRule: function () {
                    if (this.advType == 2 && (Number(this.amount) < Number(this.formModel.orderAmount))) {
                        JuaBox.wrong("<%=LANG('交易数量超过可用数量！')%>")
                        return false
                    }
                    if (Number(this.formModel.orderAmount * this.formModel.orderPrice) < Number(this.formModel.orderLimitMax)) {
                        JuaBox.wrong("<%=LANG('单笔最大数量超过交易数量！')%>")
                        return false
                    }
                    if (Number(this.formModel.orderAmount * this.formModel.orderPrice) < Number(this.formModel.orderLimitMin)) {
                        JuaBox.wrong("<%=LANG('单笔最小数量超过交易数量！')%>")
                        return false
                    }
                    if (Number(this.formModel.orderLimitMax) < Number(this.formModel.orderLimitMin)) {
                        JuaBox.wrong("<%=LANG('单笔最小额度超过单笔最大额度！')%>")
                        return false
                    }
                    return true
                },
                publishAdvs: function () {  //发布广告
                    if (this.loginUser.safePwdAuth == '0') {
                        JuaBox.confirm("<%=LANG('您还未设置交易密码！')%>", {
                            buttons: {confirm: "去设置"}, callback: function () {
                                window.location.href = 'account'
                            }
                        })
                        return false
                    }
                    if (this.reameNameStatus == null) {
                        JuaBox.confirm("<%=LANG('您还未高级实名认证！')%>", {
                            buttons: {confirm: "去认证"}, callback: function () {
                                window.location.href = 'account'
                            }
                        })
                        return false
                    }
                    if ($('#publishAdv form').valid()) {
                        if (this.checkRule()) {
                            console.log(this.checkRule())
                            JuaBox.info("<%=LANG('您如果已经发布了该币种的广告，如果继续发布会自动下架已经发布此币种的广告！')%>", function () {
                                var data = {}
                                Object.assign(data, this.formModel, {
                                    securityPassword: Methods.encryptPwd(this.formModel.securityPassword, this.pubKey),
                                    rsaKeyId: this.rsaKeyId,
                                    payId: this.payId.join(','),
                                    currencyTypeName: this.formModel.orderCoin,
                                    advType: this.advType,
                                    advStatus: 1
                                })

                                Methods.ajax({
                                    type: 'POST',
                                    url: DOMAIN_DEV +
                                        '/exchange/XtOtcController/publishCurrencyAdvs',
                                    data: data,
                                    success: function (res) {
                                        JuaBox.success(EXX.L(res.resMsg.code), function () {
                                            window.location.href = `advertisement`
                                        });
                                    }.bind(this),
                                    error: function (res) {
                                        if (res.resMsg.code == '7015') {
                                            JuaBox.confirm("<%=LANG('您还未高级实名认证！')%>", {
                                                buttons: {confirm: "去认证"}, callback: function () {
                                                    window.location.href = 'account'
                                                }
                                            })
                                        } else if (res.resMsg.code == '6078') {
                                            JuaBox.confirm("<%=LANG('您还未设置资金密码！')%>", {
                                                buttons: {confirm: "去设置"}, callback: function () {
                                                    window.location.href = 'account'
                                                }
                                            })
                                        } else {
                                            JuaBox.wrong(EXX.L(res.resMsg.code));
                                        }
                                    }
                                })
                            }.bind(this))
                        }
                    }
                },
                queryMyPayType: function () {  //查询自己的支付方式
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectUserPayBankAndPayOnline',
                        data: {},
                        success: function (res) {
                            if (res.datas.length > 0) {
                                this.formModel.payId = res.datas
                            } else {
                                JuaBox.confirm("<%=LANG('您还未设置支付方式！')%>", {
                                    buttons: {confirm: "去设置"}, callback: function () {
                                        window.location.href = 'settingsPayType'
                                    }
                                })
                            }
                        }.bind(this)
                    })
                },
                getPubKey: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/BaseApiController/" + 'getPubKey',
                        success: function (res) {
                            this.pubKey = res.datas.pubKey;
                            this.rsaKeyId = res.datas.keyId;
                        }.bind(this)
                    });
                },
            }
        })
    });
</script>
