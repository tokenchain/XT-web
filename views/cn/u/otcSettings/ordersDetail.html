<div class="ordersDetail" id="ordersDetail">
    <div class="buy" v-if="orderDetail.orderType == 1" v-cloak="">
        <div class="order-title">
            <p><%=LANG('订单')%>：<span>{{orderDetail.orderNo}}</span></p>
            <p><%=LANG('时间')%>：<span>{{orderDetail.createTime}}</span></p>
        </div>
        <div class="order-info">
            <div class="info-title">
                <span><%=LANG('您向')%> {{orderDetail.sellerName}} <%=LANG('购买')%> {{orderDetail.amount + orderDetail.currencyName}}</span>
                <span><%=LANG('对方已缴纳')%><span>{{currencyAmount}} {{orderDetail.currencyName}}</span><%=LANG('保证金')%><span></span>
            </div>
            <p class="price"><%=LANG('单价')%>：<span>{{orderDetail.price}} {{legalCurrencyName.toUpperCase()}}</span></p>
            <p><%=LANG('总价')%>：<span>{{orderDetail.totalAmount}} {{legalCurrencyName && legalCurrencyName.toUpperCase()}}</span></p>
        </div>
        <div class="order-pay-type">
            <p><%=LANG('卖方收款方式')%></p>
            <div class="pay" v-for="item in sellPayList">
                <label :for="item.id">
                    <input v-if="!orderDetail.status == -1" name="payType" type="radio" :id="item.id" @click="changePayId(item.payId)">
                    <img :src="imgSrc(item.payId)" alt="">
                    <span>{{item.bankOwner}}</span>
                    <span>{{item.bankNo}}</span>
                    <span>{{item.bankName}}</span>
                    <span>{{item.bankDetail}}</span>
                </label>
            </div>
            <p v-if="orderDetail.status == -1" class="memo"><span><%=LANG('已申诉')%></span>，<%=LANG('付款参考号：')%> <span>{{orderDetail.no}}</span></p>
            <p v-if="orderDetail.status == 1" class="memo"><span><%=LANG('待支付')%></span>，<%=LANG('请与14分28秒内向{{orderDetail.sellerName}}支付')%> <span>{{orderDetail.totalAmount}} {{legalCurrencyName && legalCurrencyName.toUpperCase()}}</span>,<%=LANG('付款参考号：')%><span>{{orderDetail.no}}</span></p>
            <p v-if="orderDetail.status == 2" class="memo"><span><%=LANG('已支付')%></span>，<%=LANG('待打币，付款参考号：')%> <span>{{orderDetail.no}}</span></p>
            <span v-if="orderDetail.status == 0" class="status"><%=LANG('已完成')%></span>
            <button v-if="!orderDetail.status == 0" @click="statusSubmit">{{getButton}}</button>

            <span class="cancel" v-if="orderDetail.status == 1 || orderDetail.status == 2" @click="cancelOrders"><%=LANG('取消订单')%></span>

            <div class="order-type" v-if="orderDetail.status == 3"><%=LANG('订单已取消！')%></div>
        </div>
        <div class="common-problem">
            <p class="title"><%=LANG('常见问题')%>：</p>
            <div class="content">
                <p><%=LANG('Q：给卖家付款安全吗？')%></p>
                <p><%=LANG('A：当你进入交易时，卖家的数字资产会被锁定在平台的钱包中，因此不必担心给卖家付款。如果卖家在您付款5分钟后还未放行数字资产，点击‘申诉’按钮，我们的客服团队将会帮助您。')%></p>
                <p><%=LANG('Q：我什么时候能收到币？')%></p>
                <p><%=LANG('A：若您已完成付款，请务必点击‘已付款’按钮，卖家确认收款后，您就会收到数字资产。')%></p>
                <p><%=LANG('Q：转款注意事项')%></p>
                <p><%=LANG('A：1、在转账过程中请勿备注类似BTC、USDT、火币等信息，防止造成您的汇款被拦截、银行卡被冻结等问题，因此到账延迟，卖方可选择拒绝成交。')%></p>
                <p><%=LANG('2、请勿使用非平台实名的银行卡、支付宝等进行转款，否则卖家可拒绝成交并投诉。')%></p>
                <p><%=LANG('3、若交易金额大于50,000 CNY，法定假日或工作日17:00点以后汇款到银行卡可能造成到账不及时，请分批支付保证及时到账，若未及时到账，卖家有权拒绝成交。')%></p>
            </div>
        </div>
    </div>

    <div class="sell" v-else v-cloak="">
        <div class="order-title">
            <p><%=LANG('订单')%>：<span>{{orderDetail.orderNo}}</span></p>
            <p><%=LANG('时间')%>：<span>{{getData(orderDetail.createTime, 'YYYY-MM-DD HH:MM:SS')}}</span></p>
        </div>
        <div class="order-info">
            <div class="info-title">
                <span><%=LANG('您向')%> {{orderDetail.sellerName}} <%=LANG('出售')%> {{orderDetail.totalAmount + orderDetail.currencyName}}</span>
                <span v-if="orderDetail.status == 3"><%=LANG('对方已缴纳')%><span>{{currencyAmount}} {{orderDetail.currencyName}}</span><%=LANG('保证金')%><span></span>
            </div>
            <p class="price"><%=LANG('单价')%>：<span>{{orderDetail.price}} {{legalCurrencyName.toUpperCase()}}</span></p>
            <p><%=LANG('总价')%>：<span>{{orderDetail.totalAmount}} {{legalCurrencyName && legalCurrencyName.toUpperCase()}}</span></p>
        </div>
        <div class="order-pay-type">
            <p><%=LANG('卖方收款方式')%></p>
            <div class="pay" v-for="item in sellPayList" v-if="!orderDetail.status == 1 || !orderDetail.status == 3">
                <label :for="item.id">
                    <input v-if="!orderDetail.status == -1" name="payType" type="radio" :id="item.id" @click="changePayId(item.payId)">
                    <img :src="imgSrc(item.payId)" alt="">
                    <span>{{item.bankOwner}}</span>
                    <span>{{item.bankNo}}</span>
                    <span>{{item.bankName}}</span>
                    <span>{{item.bankDetail}}</span>
                </label>
            </div>
            <p v-else><%=LANG('当前订单未支付，无法查看买方付款方式')%></p>
            <p v-if="orderDetail.status == 1" class="memo"><span><%=LANG('待支付')%></span>，<%=LANG('剩余支付 14分28秒')%> <%=LANG('付款参考号：')%><span>{{orderDetail.no}}</span></p>
            <p v-if="orderDetail.status == 2" class="memo"><span><%=LANG('已支付')%></span>，<%=LANG('付款参考号：')%> <span>{{orderDetail.no}}</span></p>
            <span v-if="orderDetail.status == 0" class="status"><%=LANG('已完成')%></span>
            <button v-if="orderDetail.status !== 0 || orderDetail.status !== 2" @click="statusSubmit">{{getButton}}</button>
            <span>{{sellPhone}}</span>

            <div class="order-type" v-if="orderDetail.status == 3"><%=LANG('订单已取消！')%></div>
        </div>
    </div>
</div>

<script>
    require(['vue', 'common/methods', 'common/juabox'], function (Vue, Methods, JuaBox) {
        var ordersDetail = new Vue({
            el: "#ordersDetail",
            data: function () {
                return {
                    orderDetail: {},
                    legalCurrencyName: {
                        cn: 'cny',
                        en: 'usd',
                        kr: 'krw',
                        jp: 'jpy',
                        hk: 'hkd'
                    } [getCookie(ENV + 'lan')],
                    currencyAmount: null,
                    sellPayList: [],
                    payId: null,
                    sellPhone: ''
                }
            },
            created() {
                this.getOrderListDetail(function () {
                    this.querySellPaytype()
                }.bind(this))
                this.getCurrencyAmount()
            },
            computed: {
                getButton: function () {
                    switch (this.orderDetail.status) {
                        case 0:
                            return '<%=LANG('交易成功')%>'
                            break;
                        case 1:
                            return this.orderDetail.orderType == 1 ? '<%=LANG('支付')%>' : '<%=LANG('通知买方付款')%>'
                            break;
                        case 2:
                            return this.orderDetail.orderType == 1 ? '<%=LANG('申诉 ')%>' : '<%=LANG('已付款 ')%>'
                            break;
                        case 3:
                            return '<%=LANG('订单已取消，无法查看支付信息')%>'
                            break;
                        case -1:
                            return '<%=LANG('已申诉')%>'
                            break;
                    }
                },
                timeStamp: function() {
                    console.log(this.orderDetail.createTime)

                }
            },
            methods: {
                getData: function(time, format) {
                    return Methods.getDateTime(time, format)
                },
                changePayId: function(payId) {
                    this.payId = payId
                },
                init: function() {
                    this.payId = null
                },
                imgSrc: function(payId) {
                    return `<%= IMG_STATIC %>/images/${['', '', 'UnionPay', 'aliPay', 'tencentPay', 'paypal', 'usdPay'][payId]}.png`
                },
                getStatus: function (status) {
                    switch (status) {
                        case 0:
                            return '<%=LANG('交易成功')%>'
                            break;
                        case 1:
                            return '<%=LANG('等待付款')%>'
                            break;
                        case 2:
                            return '<%=LANG('确认收款 ')%>'
                            break;
                        case 3:
                            return '<%=LANG('无效订单')%>'
                            break;
                        case -1:
                            return '<%=LANG('申述')%>'
                            break;
                    }
                },
                getOrderListDetail: function (callBack) {
                    var data = {
                        ordersNo: "<%= orderNo %>"
                    }
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectOrdersByOrdersNo',
                        data: data,
                        success: function (res) {
                            this.orderDetail = res.datas
                            callBack && callBack()
                        }.bind(this)
                    })
                },
                getCurrencyAmount: function() {  //获取冻结币数量
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectConfigSetting',
                        data: {},
                        success: function (res) {
                            this.currencyAmount = res.datas
                        }.bind(this)
                    })
                },
                querySellPaytype: function() {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectUserPaymentsBySellerId',
                        data: {
                            advsId: this.orderDetail.advsId,
                            sellerId: this.orderDetail.sellerId
                        },
                        success: function (res) {
                            this.sellPayList = res.datas
                        }.bind(this)
                    })
                },
                updataOrtderApi: function(data) {
                    Methods.ajax({
                        type: 'POST',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/updateOrdersStatus',
                        data: data,
                        success: function (res) {
                            JuaBox.success(EXX.L(res.resMsg.code));
                            this.getOrderListDetail(function () {
                                this.querySellPaytype()
                                this.init()
                            }.bind(this))
                        }.bind(this),
                        error: function (res) {
                            JuaBox.wrong(EXX.L(res.resMsg.message));
                        }
                    })
                },
                statusSubmit: function () { //修改 订单状态
                    var data;
                    var type = this.orderDetail.orderType
                    var status = this.orderDetail.status
                    if (type == 1) {  //买
                        data = {
                            status: 2,   //0 - 交易成功, 1 - 等待付款, 2 - 确认收款(去支付) ,3 - 无效订单 -1 - 申述
                            payId: this.payId,
                            orderNo: this.orderDetail.orderNo,
                            advsId: this.orderDetail.advsId
                        }
                        if (status == 1) {  //待支付
                            if (!this.payId) {
                                JuaBox.wrong('请选择支付方式！');
                                return
                            }
                            data.status = 2
                        } else if (status == 2){ //申诉
                            data.status = -1
                        } else if (status == 3 || status == -1) { //已取消  已申诉
                            return
                        }
                        this.updataOrtderApi(data)
                    } else {  //卖
                        this.querySellPhone()
                    }
                },
                cancelOrders: function () { //取消订单
                    var data = {
                        status: 3,   //0 - 交易成功, 1 - 等待付款, 2 - 确认收款(去支付) ,3 - 无效订单 -1 - 申述
                        // payId: this.payId,
                        amount: this.orderDetail.amount,
                        orderNo: this.orderDetail.orderNo,
                        advsId: this.orderDetail.advsId
                    }
                    this.updataOrtderApi(data)
                },
                querySellPhone: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectUserPhoneByBuyerId',
                        data: {
                            buyerId: this.orderDetail.buyerId
                        },
                        success: function (res) {
                            this.sellPhone = res.datas
                        }.bind(this),
                        error: function (res) {
                            JuaBox.error(EXX.L(res.resMsg.message));
                        }
                    })
                }
            }
        })
    });
</script>