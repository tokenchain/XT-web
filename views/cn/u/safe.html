<script src="/lib/others/jquery.peity.js" charset="utf-8" ></script>
<div id="user-index" :class="{'loading loading-light-bg' : !loaded}">
    <div class="pay-panel safe-panel" v-if="winWidth > 768 && loaded" v-cloak>
        <h2><%= LANG('账号管理') %></h2>
        <div class="account-admin">
            <div class="item active">
                <div class="user-box" :class="'user-type-' + loginUser.userType" v-cloak>
                    <div class="selected">
                        <span>
                            <svg style="width: 16px; height: 16px;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2189">
                                <path d="M468.121 835.12c-93.001-117.869-202.414-207.667-278.997-235.741l180.499-112.287 87.5 174.014c0 0 142.249-353.61 366.579-471.479-5.418 84.132-27.336 157.103 10.917 246.985-98.419 22.41-300.832 275.057-366.497 398.51v0 0z" p-id="2190"></path>
                            </svg>
                        </span>
                    </div>
                    <div @click="linkToMarket(loginUser)" class="avatar">
                        <div v-if="loginUser.userType == '3'" class="gray-mask"><%= LANG('模拟') %></div>
                        <img v-if="loginUser.photo" :src="avatarBaseUrl + loginUser.photo" />
                        <img v-else :src="avatarBaseUrl + 'default.jpg'" />
                    </div>
                    <div class="info">
                        <div class="user-memo">
                            <h3>
                            <template v-if="loginUser.userType === 1">
                                {{loginUser.nickName != '' ? loginUser.nickName : '<%= LANG('主账户') %>' }}
                            </template>
                            <template v-else>
                                {{loginUser.nickName != '' ? loginUser.nickName : loginUser.userName}}
                            </template>
                                <a @click="editUser(loginUser.userId)" class="edit"><%= LANG('编辑') %></a>
                            </h3>
                            <p>{{loginUser.loginName}}</p>

                        </div>
                    </div>
                    <!--<div class="onffflist">
                        <a :class="{on: account.childLogin}" v-if="account.userType == 2 && loginUser.userType == 1" @click="toggleLogin(account.userId)" ><span><%= LANG('登录设置') %></span><i></i></a>
                    </div>-->

                </div>
            </div>
            <!--<div class="item add-account" @click="addUser(isMock)"  v-if="loginUser.userType == 1">
                <div class="user-box">
                    <div class="text">
                        <h4><%= LANG('新建独立账户') %></h4>
                        <p class="desc"><%= LANG('新的独立账号可以用于代理投资、分仓管理等') %></p>
                    </div>
                </div>
            </div>-->
        </div>

        <h2  v-if="loginUser.userType == 1"><%= LANG('安全设置') %></h2>
        <div class="safe-info"  v-if="loginUser.userType == 1">
            <ul>																														                                                      <!--yyyy年MM月dd日  -->
                <li>
                    <div class="l">
                    <h3><%= LANG('登录密码') %></h3>
                    <p>
                        <span class="not-auth" v-if="loginUser.loginPwd == 0"><%= LANG('未设置') %></span>
                        <span class="auth" v-if="loginUser.loginPwd == 1"><%= LANG('已设置') %></span>

                        <span v-if="loginUser.loginPwdLevel <= 40" class="ruo"><%= LANG('弱') %></span>
                        <span v-if="loginUser.loginPwdLevel > 40 && loginUser.loginPwdLevel <= 60" class="zhong"><%= LANG('中') %></span>
                        <span v-if="loginUser.loginPwdLevel > 60" class="gao"><%= LANG('高') %></span>
                    </p>
                    </div>
                    <div class="r">
                        <a  @click="openModal('setloginpwd')"><%= LANG('修改') %></a>
                    </div>
                </li>
                <li>
                    <div class="l">
                    <h3><%= LANG('邮箱') %><span class="">{{loginUser.email}}</span></h3>
                    <p>
                        <span class="not-auth" v-if="loginUser.emailAuth == 0"><%= LANG('未认证') %></span>
                        <span class="auth" v-if="loginUser.emailAuth == 1"><%= LANG('已认证') %></span>
                    </p>
                        <div class="onffflist" v-if="loginUser.emailAuth == 1">
                            <a @click="setLoginAuth(1, loginUser.loginEmailAuth)" :class="loginUser.loginEmailAuth == 1 ? 'on' : ''"><span><%= LANG('登录验证') %></span><i></i></a>
                        </div>
                    </div>
                    <div class="r">
                        <a @click="setEmail" v-if="loginUser.emailAuth == 0"><%= LANG('认证') %></a>
                    </div>


                </li>
                <li>
                    <div class="l">
                        <h3><%= LANG('手机') %><span class="">{{loginUser.mobile}}</span></h3>
                        <p>
                            <span class="not-auth" v-if="loginUser.mobileAuth == 0"><%= LANG('未认证') %></span>
                            <span class="auth" v-if="loginUser.mobileAuth == 1"><%= LANG('已认证') %></span>
                        </p>
                        <div class="onffflist" v-if="loginUser.mobileAuth == 1">
                            <a @click="setLoginAuth(2, loginUser.loginMobileAuth)" :class="loginUser.loginMobileAuth == 1 ? 'on' : ''"><span><%= LANG('登录验证') %></span><i></i></a>
                        </div>
                    </div>
                    <div class="r">
                        <a @click="openModal('setMobile')" v-if="loginUser.mobileAuth == 0"><%= LANG('认证') %></a>
                        <a @click="openModal('setMobile')" v-if="loginUser.mobileAuth == 1 && loginUser.mobileStatus != 1"><%= LANG('修改') %></a>
                        <a v-if="loginUser.mobileStatus == 1"><%= LANG('审核中') %></a>

                    </div>
                </li>
                <li>
                    <div class="l">
                    <h3><%= LANG('Google验证') %></h3>
                    <p>
                        <span class="not-auth" v-if="loginUser.googleAuth == 0"><%= LANG('未认证') %></span>
                        <span class="auth" v-if="loginUser.googleAuth == 1"><%= LANG('已认证') %></span>
                    </p>
                        <div class="onffflist" v-if="loginUser.googleAuth == 1">
                            <a @click="setLoginAuth(0, loginUser.loginGoogleAuth)" :class="loginUser.loginGoogleAuth == 1 ? 'on' : ''"><span><%= LANG('登录验证') %></span><i></i></a>
                        </div>
                    </div>
                    <div class="r">
                        <a v-if="loginUser.googleAuth == 0" @click="openModal('setGoogle')"><%= LANG('认证') %></a>
                        <a v-if="loginUser.googleAuth == 1 && loginUser.googleStatus != 1" @click="openModal('setGoogle')"><%= LANG('修改') %></a>
                        <a v-if="loginUser.googleAuth == 1 && loginUser.googleStatus != 1" @click="openModal('closeGoogle')"><%= LANG('关闭') %></a>
                        <a v-if="loginUser.googleStatus == 1"><%= LANG('审核中') %></a>
                    </div>

                </li>
            </ul>

        </div>
    </div>
    <modal v-cloak :open= "showModal == 'userAction'" @close="showModal = false">
        <user-action :params="userParams" :done="userActionSuccess()" />
    </modal>

    <modal v-cloak :open= "showModal == 'toggleUserAction'" @close="showModal = false">
        <toggle-user-action :params="userParams" :done="userActionSuccess()" />
    </modal>

    <modal v-cloak :open="showModal == 'setMobile'" @close="showModal = false">
        <set-mobile :done="setMobileSuccess()" />
    </modal>

    <modal v-cloak :open="showModal == 'payMobileAuth'" @close="showModal = false">
        <paymobile />
    </modal>

    <modal v-cloak :open="showModal == 'setGoogle'" @close="showModal = false">
        <set-google />
    </modal>

    <modal v-cloak :open="showModal == 'closeGoogle'" @close="showModal = false">
        <set-google :close-google="1" />
    </modal>

    <modal v-cloak :open="showModal == 'setEmail'"  @close="showModal = false">
        <set-email />
    </modal>

    <modal v-cloak :open="showModal == 'safepassword'" @close="showModal = false">
        <safepassword />
    </modal>

    <modal v-cloak :open= "showModal == 'addMarket'" @close="showModal = false">
        <add-market :params="marketParams" />
    </modal>

    <modal v-cloak :open="showModal == 'addCoin'"  @close="showModal = false">
        <add-coin :params="coinParams" />
    </modal>

    <modal v-cloak :open= "showModal == 'payin'" @close="showModal = false">
        <modal-payin :coin="payinCoin" :done="callCloseModal()" />
    </modal>

    <modal v-cloak :open= "showModal == 'payout'" @close="showModal = false">
        <modal-payout ref="payout" :coin="payoutCoin" />
    </modal>

    <modal v-cloak :open="showModal == 'bill'"  @close="showModal = false">
        <bill :params="billParams" theme="light" />
    </modal>

    <modal v-cloak :open= "showModal == 'refund'" @close="showModal = false">
        <modal-refund :params="refundParams" :assets="userAssets" :done="callCloseModal()" />
    </modal>

    <modal v-cloak :open="showModal == 'safeset'"  @close="showModal = false">
        <safeset />
    </modal>

    <modal v-cloak :open="showModal == 'setloginpwd'"  @close="showModal = false">
        <setloginpwd />
    </modal>

    <modal v-cloak :open= "showModal == 'loginAuth'" @close="showModal = false">
        <modal-login-auth :params="loginAuthParams" :done="callCloseModal()" />
    </modal>




</div>


<%-include("../component/json_grid.html")%>
<%-include("../component/json_table.html")%>
<%-include("../component/send_code/index.html")%>
<%-include("../component/page_lite.html")%>
<%-include("../component/modal.html")%>
<%-include("../component/circular_progress.html")%>

<%-include("model/userAction.html")%>
<%-include("model/toggleUserAction.html")%>
<%-include("model/setMobile.html")%>
<%-include("model/payMobileAuth.html")%>
<%-include("model/setgoogle.html")%>
<%-include("model/email.html")%>
<%-include("model/addcoin.html")%>
<%-include("model/safePassword.html")%>
<%-include("model/insideDebit.html")%>
<%-include("model/payin.html")%>
<%-include("model/payout.html")%>
<%-include("model/bill.html")%>
<%-include("model/refund.html")%>
<%-include("model/safeset.html")%>
<%-include("model/setLoginPwd.html")%>
<%-include("model/setLoginAuth.html")%>
<%-include("../activity/_addMarket.html")%>



<script>
    $(function(){
        if( $('.mask span').text() <= 50 ){
            $('.circle_right').css('transform','rotate('+($('.mask span').text()*3.6)+'deg)');
        }else{
            $('.circle_right').css({
                'transform':'rotate(0deg)',
                "background":"#fba81c"
            });
            $('.circle_left').css('transform','rotate('+(($('.mask span').text()-50)*3.6)+'deg)');
        }
    })
</script>


<script>

    $(function(){
        $.fn.peity.defaults.bar = {
            delimiter: ",",
            fill: ["#414253"],
            height: 32,
            max: null,
            min: 0,
            padding: 0.1,
            width: 60
        };
        $(".linebar").peity("bar");
    });


    require(['vue', 'common/methods', 'common/juabox', 'components/country_code/index'], function(Vue, Methods, JuaBox) {

        //释放JuaBox到全局使用
        window.JuaBox = JuaBox;



        EXX.userIndex = new Vue({
            el: "#user-index",
            data: function () {
                return {
                    isLogin : ISLOGIN,
                    loaded: true,
                    pubKey: '',
                    timer: false,
                    showModal: false,
                    showCurrencyList: false,
                    showHidedCoins: false,
                    mShowCoinDetail: false,
                    avatarBaseUrl: '<%= STATIC %>/images/userhead/',
                    repaymentAmount: '',
                    winWidth: window.innerWidth,
                    currentPriceType : MONEY,
                    userAssets: [],
                    mainUserAssets: [],
                    allPriceRate: {
                        btc : {
                            btc : 0,
                            ltc : 0,
                            eth : 0,
                            etc : 0
                        },
                        cny : {
                            btc : 0,
                            ltc : 0,
                            eth : 0,
                            etc : 0
                        },
                        usd : {
                            btc : 0,
                            ltc : 0,
                            eth : 0,
                            etc : 0
                        }
                    },
                    loginUser: Methods.getLocalStorage(ENV + 'userInfo'), //用户信息
                    allSubAccounts: [],
                    safePwd: '',
                    dynamicCode: '',
                    googleCode: '',
                    payinCoin: '',
                    payoutCoin: '',
                    loginAuthParams : {},
                    billParams: {},
                    refundParams: {},
                    coinParams: {},
                    userParams: {},
                    marketParams: {},
                    transferInfo: {},
                    editAccountInfo: {},
                    allMarketsInfo: [],
                    currencyList: [
                        {key:'none', name: "<%= LANG('原始')%>", icon: '', symbol: '฿',decimal : 6},
                        {key: 'usd', name: 'USD', icon: 'icon-meiyuan', symbol: '$',decimal : 2},
                        {key: 'cny', name: 'CNY', icon: 'icon-cny', symbol: '¥',decimal : 2}
                    ],
                    assetsTableSettings: {
                        rowClass: function(item) {
                            return item.cointTag;
                        }
                    },
                    currentAccountId: (Methods.getCookie(ENV + 'currentAccountId') || Methods.getCookie(ENV + 'uid'))
                }
            },
            computed: {
                leverTypes: function() {
                    var types = [
                        {'label': '<%= LANG("不启用") %>', 'value': ''}
                    ];
                    [].map(function(market){
                        var obj = {};
                        obj.label = market.type.toUpperCase().replace(/_/, '/');
                        obj.value = market.type;
                        types.push(obj);
                    });
                    return types;
                },
                isMock : function () {
                    return this.currentUserInfo.userType == 3;
                }
            },
            watch: {
                showModal: function(value) {
                    // 添加class控制弹窗时不滚动主页内容
                    if (value) {
                        $('body').addClass('modal-open');
                    } else {
                        $('body').removeClass('modal-open');
                    }
                }
            },
            methods: {
                //去掉虚拟市场货币的D字符
                getRealCoinName : function (coin) {
                    if(coin.length > 3 && coin.substring(0,1) == 'd'){
                        return coin.substring(1);
                    }else{
                        return coin;
                    }
                },
                //获取本地用户信息
                // getUserInfo: function(id) {
                //     return this.userAssets.getObject('userId', id);
                // },
                currencySymbol: function(currency) {
                    return this.currencyList.getObject('key', currency).symbol;
                },
                // 格式化用户资产数据
                userCoinFunds: function(user, index) {
                    var fundMaps = user.coinFundMap;
                    var assistCoin = user.assistCoin;
                    var arr = [];
                    var allComputeNetTotal = 0;
                    Object.keys(fundMaps).map(function(coin){
                        var moneyPrice = this.moneyPrice(assistCoin, coin);
                        var obj = fundMaps[coin];
                        if (obj.showCoin) {
                            obj.computeTotal = obj.total * moneyPrice;
                            obj.computeNetTotal = obj.total == 0 ? 0 : (obj.total - obj.loanIn) * moneyPrice;
                            allComputeNetTotal += obj.computeNetTotal;
                            obj.netTotal = obj.total == 0 ? 0 : Methods.fixFloat((obj.total - obj.loanIn), 8);
                            obj.computeAvailable = obj.available * moneyPrice;
                            obj.computeLoanIn = obj.loanIn * moneyPrice;
                            obj.computeFreez = obj.freez * moneyPrice;
                            obj.coin = coin;
                            arr.push(obj);
                        }
                    }.bind(this));
                    //this.userAssets[index].allComputeNetTotal = allComputeNetTotal;
                    //console.log(this.userAssets);
                    return arr;
                },
                userHidedCoins: function(user) {
                    var fundMaps = user.coinFundMap;
                    var hidedCoins = [];
                    Object.keys(fundMaps).map(function(coin) {
                        var obj = fundMaps[coin];
                        if (!obj.showCoin) {
                            obj.coin = coin;
                            hidedCoins.push(fundMaps[coin]);
                        }
                    });
                    return hidedCoins;
                },
                priceDisplay: function(num, money){
                    var moneyPrice = this.moneyPrice(money, 'btc');
                    return moneyPrice * Number(num);
                },
                resetCurrency: function(coin) {
                    return coin != '' ? coin : 'usd';
                },
                moneyPrice: function(money, coin){
                    var money = money || 'usd';
                    return Number(this.allPriceRate[money] && this.allPriceRate[money][coin] ? this.allPriceRate[money][coin] : 1)
                },
                userEnabledCoin: function(user) {
                    var coinFundMap = user.coinFundMap;
                    var enabled = [];
                    Object.keys(coinFundMap).forEach(function(coin){
                        if (coinFundMap[coin].show) {
                            coinFundMap[coin]['name'] = coin;
                            enabled.push(coinFundMap[coin]);
                        }
                    });
                    return enabled;
                },
                openModal: function(name) {
                    if (name == 'setMobile' && this.loginUser.emailAuth == 0) {
                        JuaBox.info("<%= LANG('需要先认证邮箱才能修改手机号码。')%>")
                        this.showModal = false;
                        return
                    }
                    this.showModal = name;
                    //this.$refs[name].open = true;
                },
                callCloseModal: function() {
                    return function() {
                        this.showModal = false;
                    }.bind(this)
                },
                closeModal: function() {
                    this.showModal = false;
                },
                linkToMarket: function(account) {
                    // Methods.setLocalStorage(ENV + "currentUserInfo", account);
                    // Methods.setCookie(ENV+'currentAccountId', account.userId);
                    window.location.replace('/trade');
                },
                openCurrencyList: function(id) {
                    this.showCurrencyList = id;
                },
                openPayin: function(coin) {
                    this.showModal = 'payin';
                    this.payinCoin = coin;
                },
                openPayout: function(coin) {
                    this.showModal = 'payout';
                    this.payoutCoin = coin;
                },
                openBill: function(userId, coin) {
                    this.billParams = {
                        userId: userId,
                        coin: coin
                    };
                    this.showModal = 'bill';
                },
                openRefund: function(userId, coin) {
                    this.refundParams = {
                        userId: userId,
                        coin: coin
                    };
                    this.showModal = 'refund';
                },
                openAddMarket: function(account) {
                    this.showModal = 'addMarket';
                    this.showMainHide = false;
                    this.marketParams = {
                        account: account
                    }
                },
                openCoin: function(userId) {
                    this.coinParams = {
                        userId: userId,
                        account: this.loginUser,
                        allPriceRate: this.allPriceRate
                    };
                    this.showModal = 'addCoin';
                },
                setEmail: function() {
                    if (this.loginUser.emailAuth == 1) {
                        return
                    }
                    this.showModal = 'setEmail';
                },
                addUser: function(isMock) {
                    this.userParams = {
                        optType: 2,
                        isMock: isMock
                    };
                    this.showModal = 'userAction';
                },
                editUser: function(userId) {
                    this.userParams = {
                        optType: 3,
                        userId: userId,
                        account: this.loginUser
                    };
                    this.showModal = 'userAction';
                },
                toggleCoinDetail: function(coin, account) {
                    var targetCoin = [coin, account.userId].join('_');
                    if (targetCoin == this.mShowCoinDetail) {
                        this.mShowCoinDetail = false;
                    } else {
                        this.mShowCoinDetail = targetCoin;
                    }
                },
                toggleLogin: function(userId) {
                    this.userParams = {
                        optType: 4,
                        userId: userId,
                        account: this.loginUser
                    };
                    this.showModal = 'toggleUserAction';
                },
                toggleLever: function(userId) {
                    var account = this.loginUser.userId;
                    var enabledCoins = this.userEnabledCoin(account);
                    this.userParams = {
                        optType: 5,
                        userId: userId,
                        account: account
                    };
                    if (enabledCoins.length == 0) {
                        JuaBox.info("<%= LANG('开启杠杆需要添加一个交易市场') %>");
                        this.openAddMarket(account);
                    } else if (enabledCoins.length > 2) {
                        JuaBox.info("<%= LANG('开启杠杆只能应用于一个市场，请把多余的市场删除') %>");
                        this.openAddMarket(account);
                    } else {
                        this.showModal = 'toggleUserAction';
                    }
                },
                toggleHidedCoins: function(userId) {
                    this.showHidedCoins = this.showHidedCoins == userId ? false : userId;
                },
                editAccount: function(userId) {
                    this.showModal = 'addAccount';
                    this.editAccountInfo = {
                        type: 'edit',
                        account: this.loginUser,
                        userId: userId
                    }
                },
                setLoginAuth : function (autoType, type) {
                    this.loginAuthParams.autoType = autoType;
                    this.loginAuthParams.type = type == 1 ? 0 : 1;
                    this.showModal = 'loginAuth';
                },
                // getPubKey: function () {
                //     Methods.ajax({
                //         type: 'GET',
                //         url: DOMAIN_DEV + "/exchange/controller/website/common/baseapicontroller/" + 'getpubkey',
                //         success: function (res) {
                //             this.pubKey = res.datas.pubKey;
                //         }.bind(this)
                //     });
                // },
                // 获取币价汇率
                getPriceRate: function(callback) {
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/base/controller/pricecontroller/" + 'getassistprice',
                        success: function (res) {
                            this.allPriceRate = res.datas;
                            //var oriPrice = res.datas.prices[this.moneyType];
                            /*if (res.datas.rate['USD_CNY']) {
                              this.rate = res.datas.rate['USD_CNY'];
                            }*/
                            //this.oriPiece = oriPrice;
                            //this.moneyPrice = oriPrice/this.rate;
                            if(typeof callback == 'function'){
                                callback();
                            }
                        }.bind(this)
                    });
                },
                editMainUserCoin: function(act, coin, userId) {
                    var data = {
                        fundtype: coin,
                        childId: userId,
                        isType: act
                    };
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_MAIN + API_PREFIX + 'doEditUserFund',
                        data: data,
                        success: function (res) {
                            $.toast({
                                heading: "<%= LANG('修改用户币种信息成功') %>",
                                text: EXX.L(res.resMsg.message),
                                showHideTransition: 'plain',
                                icon: 'success'
                            });
                        }.bind(this)
                    });
                },
                setCurrency: function(coin, userId) {
                    var data = {
                        assistCoin : coin.key,
                        targetUserId: userId
                    };
                    if (!userId) {
                        Methods.setCookie(ENV+'mname', coin.key);
                        window.location.reload();
                        return
                    }

                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_MAIN + API_PREFIX + 'editAssistCoin',
                        data: data,
                        success: function (res) {
                            //如果是主账户直接更新本地存储
                            if (this.loginUser.userType == 1) {
                                var userInfo = this.loginUser;
                                userInfo.assistCoin = coin.key;
                                Methods.setLocalUserInfo(userInfo);
                                this.loginUser = userInfo;
                            }

                            this.showCurrencyList = false;
                            $.toast({
                                heading: "<%= LANG('辅助货币切换成功') %>",
                                text: "<%= LANG('辅助货币已经更改为') %>" + coin.name.toUpperCase(),
                                showHideTransition: 'plain',
                                icon: 'success'
                            });
//                Methods.setCookie(ENV+'mname', coin.name);
//                window.location.reload();
                        }.bind(this)
                    });
                },
                userActionSuccess: function() {
                    return function() {
                        this.closeModal('addAccount');
                    }.bind(this)
                },
                setMobileSuccess: function() {
                    return function() {
                        this.closeModal('setMobile');
                        JuaBox.info("<%= LANG('手机信息设置成功') %>");
                    }.bind(this)
                },
                getWindowWidth: function() {
                    if (!this.timer) {
                        this.timer = true;
                        var _this = this;
                        // 添加延迟处理
                        setTimeout(function () {
                            _this.timer = false
                            _this.winWidth = window.innerWidth;
                        }, 400);
                    }
                },
                handleClickOutsideSelect: function() {
                    this.showCurrencyList = false;
                }
            },
            created: function() {
                //this.getAssets();
                // this.getPubKey();
                // this.getPriceRate();
            },
            mounted: function() {
                document.addEventListener('click', this.handleClickOutsideSelect, true);
                window.addEventListener('resize', this.getWindowWidth, true);
                $('[data-toggle="tooltip"]').tooltip();
            },
            updated: function() {
                $('[data-toggle="tooltip"]').tooltip();
            },
            beforeDestroy: function() {
                document.removeEventListener('click', this.handleClickOutsideSelect, true)
                document.removeEventListener('resize', this.getWindowWidth, true)
            }
        })
    });
</script>
<script type="text/javascript" src="<%= STATIC %>/scripts/slider.js"></script>
<script type="text/javascript" src="<%= STATIC %>/scripts/xulei-v1.js"></script>
