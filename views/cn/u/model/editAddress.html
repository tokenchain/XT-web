<style>
    /*.exx-modal-header .active{
        color: #ff5353
    }*/
</style>
<script type="text/x-template" id="modal-address">
    <div class="modal-address">
        <div class="exx-modal-container">
            <div class="exx-modal-header"><h3>{{modalTitle}}<span class="active" v-text="coin.toUpperCase()"></span></h3></div>

            <div class="exx-modal-body">
                <div class="exx-form-box">
                    <div class="form-box">
                        <div class="form-group">
                            <!--<label>-->
                            <!--<template v-if="coin == 'bts'"><%= LANG('账户') %></template>-->
                            <!--<template v-else><%= LANG('提币地址') %></template>-->
                            <!--</label>-->
                            <label class="control-label"><%= LANG('提币地址') %>：</label>
                            <div class="form-control">
                                <img src="/src/images/user.png" class="title" alt="">
                                <input autocomplete="off"
                                       :placeholder="(coin == 'bts' || coin == 'tv' || coin == 'bds' || coin == 'eos' || coin == 'lst') ? '<%= LANG('账户') %>' : '<%= LANG('提币地址') %>'"
                                       v-model="selectedAddress.address" type="text" :readonly="type != 'add'"/>
                            </div>
                        </div>
                        <div class="form-group" v-if="coin == 'bts' || coin == 'tv' || coin == 'bds' || coin == 'eos' || coin == 'lst'">
                            <label class="control-label"><%= LANG('备注') %>(MEMO)：</label>
                            <div class="form-control">
                                <img src="/src/images/pass.png" class="title" alt="">
                                <input autocomplete="off" placeholder="<%= LANG('备注') %>(MEMO)"
                                       v-model="selectedAddress.btsMemo" type="text" :readonly="type != 'add'"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label"><%= LANG('地址备注') %>：</label>
                            <div class="form-control">
                                <img src="/src/images/pass.png" class="title" alt="">
                                <input autocomplete="off" placeholder="<%= LANG('地址备注') %>"
                                       v-model="selectedAddress.remark" type="text" :readonly="type == 'dele'"/>
                            </div>
                        </div>
                        <!--<div class="form-group">
                            <label>
                            <template v-if="loginUser.safePwdAuth == 0">
                            <%= LANG('登录密码') %>
                            </template>
                            <template v-else>
                            <%= LANG('资金密码') %>
                            </template>
                            </label>
                            <div class="form-control">
                            <input autocomplete="newpassword"
                            :placeholder="loginUser.safePwdAuth == 0 ? '<%= LANG('资金密码') %>' : '<%= LANG('资金密码') %>'"
                            v-model="safePwd" type="password"/>
                            </div>
                        </div>-->
                        <div class="form-group" v-if="type!='dele'">
                            <label class="control-label"><%= LANG('图形验证码') %>：</label>
                            <div class="form-control" style="display: block !important;">
                                <img src="/src/images/pass.png" class="title" alt="">
                                <input autocomplete="off" placeholder="<%= LANG('图形验证码') %>" v-model="imgCode" v-on:blur="handleCheckLength($event)" v-on:focus="clearInputError($event)" maxlength="4" type="text">
                                <div class="code-img" v-cloak=""><img :src="imageCodeUrl" style="z-index: 2;" v-on:click="handleRefreshImgcode" alt="<%= LANG('点击刷新验证码') %>"></div>
                            </div>
                        </div>
                        <div v-if="type != 'dele'" class="form-group">
                            <label class="control-label"><%= LANG('动态验证码') %>：</label>
                            <div class="form-control">
                                <img src="/src/images/pass.png" class="title" alt="">
                                <input autocomplete="off" placeholder="<%= LANG('动态验证码') %>" v-model="dynamicCode"
                                       type="text">
                                <send-code :code-type="3"
                                           :country-code="loginUser.countryCode"
                                           :user-name="loginUser.loginName"
                                           :user-id="loginUser.userId"
                                           :bus-type="21"
                                           :img-code="imgCode"
                                           :img-code-id="imgCodeId"
                                           :error-fun="handleRefreshImgcode"
                                           @type="codeType"/>
                            </div>
                        </div>
                        <div v-if="(loginUser.googleAuth == 1 || loginUser.googleAuth == -1) " class="form-group">
                            <label class="control-label"><%= LANG('谷歌验证码') %>：</label>
                            <div class="form-control">
                                <img src="/src/images/pass.png" class="title" alt="">
                                <input autocomplete="off" placeholder="<%= LANG('谷歌验证码') %>" v-model="googleCode"
                                       type="text"/>
                            </div>
                        </div>
                        <div class="form-button">
                            <button v-if="!requestLocked" type="button" @click="doSubmit" class="button"><span><%= LANG('确认') %></span>
                            </button>
                            <button v-if="requestLocked" type="button" class="button">
                                <span><%= LANG('正在处理') %></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script>
    require(['vue', 'common/methods'], function (Vue, Methods) {
        return Vue.component('modal-address', {
            template: "#modal-address",
            props: {
                done: {
                    type: Function,
                    default: function () {
                        console.log('success');
                    }
                },
                type: {
                    type: String,
                    default: 'add'
                },
                address: {
                    type: Object,
                    default: function () {
                        return {};
                    }
                },
                coin: {
                    type: String,
                    default: ''
                }
            },
            data: function () {
                return {
                    pubKey: '',
                    rsaKeyId: '',
                    safePwd: '',
                    googleCode: '',
                    dynamicCode: '',
                    requestLocked: false,
                    sendCodeType: '',
                    selectedAddress: {
                        // id : '',
                        // account : '',
                        // btsMemo : '', // btsMemo ？
                        // memo : ''
                        userFundAddressId: '',
                        address: '',
                        remark: ''
                    },
                    loginUser: Methods.getLocalUserInfo(),
                    userName: Methods.getCookie(ENV + 'uname'),
                    imgCode: '',
                    imgCodeId: '',
                    imageCodeUrl: ''
                }
            },
            computed: {
                modalTitle: function () {
                    if (this.type == 'add') {
                        return "<%= LANG('添加提币地址') %>";
                    }
                    if (this.type == 'edit') {
                        return "<%= LANG('编辑提币地址') %>";
                    }
                    if (this.type == 'dele') {
                        return "<%= LANG('删除提币地址') %>";
                    }
                },
                currencyId: function () {
                    var currencyId = '';
                    var _this = this;
                    EXX.appPayin.coinConfig.forEach(function (coin, index, arr) {
                        if (coin.name == _this.coin) {
                            currencyId = coin.currencyId;
                        }
                    });

                    return currencyId;
                }
            },
            watch: {},
            methods: {
                getPubKey: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/baseapicontroller/" + 'getpubkey',
                        success: function (res) {
                            this.pubKey = res.datas.pubKey;
                            this.rsaKeyId = res.datas.keyId;
                        }.bind(this)
                    });
                },
                handleAddressSubmit: function () {
                    if (this.requestLocked) {
                        JuaBox.info("<%= LANG('您有未完成的提交，请稍候……') %>");
                        return
                    }
                    if(!this.imgCode && this.type!='dele'){
                        return JuaBox.info("<%= LANG('请输入图形验证码')%>");
                    }
                    var address;
                    if ((this.coin == 'bts' || this.coin == 'tv' || this.coin == 'bds' || this.coin == 'eos' || this.coin == 'lst') && this.selectedAddress.btsMemo != '') {
                        address = [this.selectedAddress.address.replace(/\s+|_/g, ""), this.selectedAddress.btsMemo.replace(/\s+|_/g, "")].join('_');
                    } else {
                        address = this.selectedAddress.address;
                    }
                    var data = {
                        // userId: this.loginUser.userId,
                        account: address,
                        safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
                        rsaKeyId: this.rsaKeyId,
                        googleCode: this.googleCode,
                        currencyId: this.currencyId,
                        coint: this.coin,
                        memo: this.selectedAddress.remark,
                        type: this.type
                        // coint: this.coin,
                        // type: this.type,
                        // account: address,
                        // memo: this.selectedAddress.memo,
                        // safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
                        // dynamicCode: this.dynamicCode,
                        // googleCode: this.googleCode
                    };
                    if (this.sendCodeType == "sms") {
                        data.dynamicCode = this.dynamicCode;
                    } else if (this.sendCodeType == "email") {
                        data.emailCode = this.dynamicCode;
                    }
                    if (this.selectedAddress.id != '') {
                        data.id = this.selectedAddress.id;
                    }
                    this.requestLocked = true;
                    Methods.ajax({
                        type: 'POST',
                        // url: DOMAIN_MAIN + API_PREFIX + 'doSetAddress',
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/fundwebsitecontroller/" + 'dosetaddress',
                        data: JSON.stringify(data),
                        success: function (res) {
                            this.requestLocked = false;
                            this.selectedAddress = {};
                            this.safePwd = '';
                            this.dynamicCode = '';
                            this.googleCode = '';
                            JuaBox.info(EXX.L(res.resMsg.message))
                            this.$parent.close();
                            this.done()
                        }.bind(this),
                        error: function (res) {
                            this.requestLocked = false;
                            JuaBox.showWrong(EXX.L(res.resMsg.code));
                            // JuaBox.info(EXX.L(res.resMsg.message))
                        }.bind(this)
                    });
                },
                doSubmit: function () {
                    this.getPubKey();
                    this.handleAddressSubmit();
                },
                codeType: function (type) {
                    this.sendCodeType = type
                },
                //获取图形验证码
                getImageCode: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/verifycode/controller/website/userverifycontroller/" + 'getvalidatecode',
                        success: function (res) {
                            this.imageCodeUrl = res.datas.img;
                            this.imgCodeId = res.datas.imgCodeId;
                        }.bind(this)
                    });
                },
                handleRefreshImgcode: function () {
                    // this.timestramp = '-' + new Date().getTime();
                    this.getImageCode();
                },
                clearInputError: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    Methods.showLineError(target, "")
                },
                handleCheckLength: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    if ($(target).val() == '') {
                        Methods.showLineError(target, "<%= LANG('验证码格式不正确') %>")
                    } else {
                        Methods.showLineError(target, "")
                    }
                }
            },
            created: function () {

            },
            mounted: function () {
                this.getPubKey();
                this.getImageCode();
                if (this.type != 'add') {
                    for (var key in this.selectedAddress) {
                        Vue.set(this.selectedAddress, key, this.address[key]);
                    }
                    if (this.coin == 'bts' || this.coin == 'tv' || this.coin == 'bds' || this.coin == 'eos'|| this.coin == 'lst' ) {
                        Vue.set(this.selectedAddress, 'address', this.address.account.split('_')[0]);
                        Vue.set(this.selectedAddress, 'btsMemo', this.address.account.split('_')[1]);
                    }
                }
            }
        })
    });


</script>
