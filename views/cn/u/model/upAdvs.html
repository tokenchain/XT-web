<script type="text/x-template" id="upAdvs">
    <div class="exx-modal-container upAdvs" style="width: 800px;">
        <div class="exx-modal-header"><h3><%= LANG('上架广告') %></h3></div>
        <div class="exx-modal-body">
            <div class="exx-form-box">
                <form id="upAdvs">
                    <div class="form-item">
                        <label for=""><%=LANG('法币币种')%>：</label>
                        <select name="" v-cloak="" @change="changeCurrency" v-model="advDetail.legalCurrencyId">
                            <option :value="item.id" v-cloak="" v-for="item in currencyList">{{item.name}}</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('交易币种')%>：</label>
                        <select name="" v-cloak="" @change="changeCoin" v-model="advDetail.orderCoin">
                            <option :value="item.shortName" v-cloak="" v-for="item in coinList">{{item.name}}</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('单价')%>：</label>
                        <input type="text" name="orderPrice" v-model="advDetail.orderPrice" required number="true" NumThanZero="0">
                    </div>
                    <div class="form-item" v-if="advDetail.advType == 2">
                        <label for=""><%=LANG('可用数量')%>：</label>
                        <span class="describe" v-cloak="">{{amount}} {{ advDetail.orderCoin.toUpperCase()}}</span>
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('交易数量')%>：</label>
                        <input type="text" name="orderAmount" v-model="advDetail.orderAmount"
                               required
                               number="true"
                               NumThanZero="0"
                               :than="formModel.orderLimitMax"
                               class="change-valite">
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('单笔最小成交额')%>：</label>
                        <input type="text" name="orderLimitMin" v-model="advDetail.orderLimitMin" required number="true"
                               NumThanZero="0" :lessThan="advDetail.orderLimitMax" class="change-valite">
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('单笔最大成交额')%>：</label>
                        <input type="text" name="orderLimitMax" v-model="advDetail.orderLimitMax" required
                               number="true" NumThanZero="0" :than="formModel.orderLimitMin" class="change-valite">
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('备注(MEMO)')%>：</label>
                        <textarea name="memo" style="height: unset" cols="30" rows="5" v-model="advDetail.memo"></textarea>
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('支持支付方式')%>：</label>
                        <div class="pay">
                            <label for="" v-for="item in formModel.payId">
                                <input name="payId" type="checkbox" :value="item" v-model="payId" required/>
                                <img :src="imgSrc(item)" alt="" >
                            </label>
                        </div>
                    </div>
                    <div class="form-item">
                        <label for=""><%=LANG('交易密码')%>：</label>
                        <input type="password" v-model="formModel.securityPassword" required maxlength="6">
                    </div>
                </form>
            </div>
        </div>

        <div class="exx-modal-button">
            <button @click="close" class="exxbtn btn-cancel"><span><%= LANG('取消') %></span>
            </button>
            <button @click="publishAdvs" class="exxbtn btn-ok"><span><%= LANG('上架') %></span></button>
        </div>
    </div>
</script>

<script>
    require(['vue', 'common/methods', 'common/juabox', 'validate'], function (Vue, Methods, JuaBox) {
        return Vue.component('upAdvs', {
            template: "#upAdvs",
            props: {
                type: {
                    type: String,
                    default: ''
                },
                advDetail: {
                    type: Object,
                    default: {}
                }
            },
            data: function () {
                return {
                    loginUser: Methods.getLocalUserInfo(),
                    currencyList: [],
                    coinList: [],
                    amount: "",
                    formModel: {
                        legalCurrencyId: '1',  //法币默认 cny
                        orderCoin: 'xt',  //虚拟币 默认 xt
                        orderPrice: '',   //单价
                        orderAmount: '',  //交易数量
                        orderLimitMax: '',  //单笔最大成交额
                        orderLimitMin: '',   //单笔最小成交额
                        memo: '',  //备注
                        payId: [], //支付方式
                        securityPassword: '',  //交易密码
                    },
                    payId: [],
                    pubKey: '',
                    rsaKeyId: ''
                }
            },
            created() {
                this.payId = this.advDetail.payId.split(',')
                this.getCoinList()
                this.getCurrencyList()
                this.queryMyPayType()
                this.getPubKey()
                if (this.advDetail.advType == 2) {
                    this.queryAmount()
                }
            },
            mounted: function() {
                $('input.change-valite').on('blur', function (event) {
                    console.log(111)
                    $('#publishAdv form').valid()
                })
            },
            computed: {
                userInfo: function () {
                    return Methods.getLocalUserInfo();
                }
            },
            methods: {
                close: function() {
                    this.$parent.$parent.showModal = false
                },
                imgSrc: function (payId) {
                    return `<%= IMG_STATIC %>/images/${['', '', 'UnionPay', 'aliPay', 'tencentPay', 'paypal', 'usdPay'][payId]}.png`
                },
                changeCurrency: function(e) {
                    console.log(e.target.value)
                    this.formModel.legalCurrencyId = e.target.value
                    var tode = this.currencyList.find(function (item) {
                        return item.id == e.target.value
                    })
                    this.getCoinList(tode.shortName.toLowerCase())
                },
                changeCoin: function(e) {
                    console.log(e.target.value)
                    this.formModel.orderCoin = e.target.value
                },
                getCoinList: function (name) {   //查询 币种列表
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectCoinLists',
                        data: {
                            legalCurrencyName: name ? name : 'cny'
                        },
                        success: function (res) {
                            this.coinList = res.datas
                            this.formModel.orderCoin = this.coinList[0].shortName
                        }.bind(this)
                    })
                },
                getCurrencyList: function () {  //查询法币接口
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectCurrency',
                        data: {},
                        success: function (res) {
                            this.currencyList = res.datas
                        }.bind(this)
                    })
                },
                queryAmount: function () { //查询余额
                    var data = {
                        currencyTypeName: this.formModel.orderCoin
                    }
                    Methods.ajax({
                        type: 'POST',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectUserExchangeCoinAmount',
                        data: data,
                        success: function (res) {
                            this.amount = res.datas.amount
                        }.bind(this)
                    })
                },
                publishAdvs: function () {  //发布广告
                    if ($('#upAdvs').valid()) {
                        if (this.advType == 2 && (this.amount < this.formModel.orderAmount)) {
                            JuaBox.wrong("<%=LANG('交易数量超过可用数量！')%>")
                            return
                        }
                        var data ={}
                        Object.assign(data, this.advDetail, {
                            securityPassword: Methods.encryptPwd(this.formModel.securityPassword, this.pubKey),
                            rsaKeyId: this.rsaKeyId,
                            payId: this.payId.join(','),
                            currencyTypeName: this.advDetail.orderCoin,
                            advStatus: 1
                        })
                        console.log(this.formModel.securityPassword)
                        console.log(data)
                        JuaBox.confirm("<%=LANG('您如果已经发布了该币种的广告，如果继续发布会自动下架已经发布此币种的广告！')%>", function () {
                            Methods.ajax({
                                type: 'POST',
                                url: DOMAIN_DEV +
                                    '/exchange/XtOtcController/updateAdvsStatus',
                                data: data,
                                success: function (res) {
                                    JuaBox.success(EXX.L(res.resMsg.code));
                                    if (this.type == '1') {
                                        this.$parent.$parent.getfinList()
                                    } else {
                                        this.$parent.$parent.getfinListDetail()
                                    }
                                    this.$parent.$parent.showModal = false
                                }.bind(this),
                                error: function (res) {
                                    if (res.resMsg.code == '7015') {
                                        JuaBox.confirm("<%=LANG('您还未高级实名认证！')%>", {
                                            buttons: {confirm: "去认证"}, callback: function () {
                                                window.location.href = 'account'
                                            }
                                        })
                                    } else if (res.resMsg.code == '6078') {
                                        JuaBox.confirm("<%=LANG('您还未设置资金密码！')%>", {
                                            buttons: {confirm: "去设置"}, callback: function () {
                                                window.location.href = 'account'
                                            }
                                        })
                                    } else {
                                        JuaBox.wrong(EXX.L(res.resMsg.code));
                                    }
                                }
                            })
                        }.bind(this))
                    }
                },
                queryMyPayType: function () {  //查询自己的支付方式
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV +
                            '/exchange/XtOtcController/selectUserPayBankAndPayOnline',
                        data: {},
                        success: function (res) {
                            this.formModel.payId = res.datas
                        }.bind(this)
                    })
                },
                getPubKey: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/BaseApiController/" + 'getPubKey',
                        success: function (res) {
                            this.pubKey = res.datas.pubKey;
                            this.rsaKeyId = res.datas.keyId;
                        }.bind(this)
                    });
                },
            },
            mounted: function () {
                this.getPubKey();
            }
        })
    })
</script>