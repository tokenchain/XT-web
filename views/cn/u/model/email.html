<script type="text/x-template" id="set-email">
    <div class="exx-modal-container">
        <div class="exx-modal-header"><h3><%= LANG('邮箱设置') %></h3></div>
        <div class="exx-modal-body">

            <div class="exx-form-box">
                <div class="form-box">
                    <div class="form-group">
                        <label class="control-label"><%= LANG('邮箱地址') %>：</label>
                        <div class="form-control" id="nikeForm">
                            <img src="/src/images/user.png" class="title" alt="">
                            <input autocomplete="off" placeholder="<%= LANG('邮箱地址') %>" v-model="email" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <!--<label>-->
                        <!--<template v-if="userInfo.safePwdAuth == 0">-->
                        <!--<%= LANG('登录密码') %>-->
                        <!--</template>-->
                        <!--<template v-else>-->
                        <!--<%= LANG('二级密码') %>-->
                        <!--</template>-->
                        <!--</label>-->
                        <label class="control-label"><%= LANG('登录密码') %>：</label>
                        <div class="form-control">
                            <img src="/src/images/pass.png" class="title" alt="">
                            <input autocomplete="new-password" :placeholder="'<%= LANG('登录密码') %>'" v-model="safePwd"
                                   type="password">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label"><%= LANG('图形验证码') %>：</label>
                        <div class="form-control" style="display: block !important;">
                            <img src="/src/images/pass.png" class="title" alt="">
                            <input autocomplete="off" placeholder="<%= LANG('图形验证码') %>" v-model="imgCode"
                                   v-on:blur="handleCheckLength($event)" v-on:focus="clearInputError($event)"
                                   maxlength="4" type="text">
                            <div class="code-img" v-cloak="">
                                <img :src="imageCodeUrl" style="z-index: 2;"
                                     v-on:click="handleRefreshImgcode"
                                     alt="<%= LANG('点击刷新验证码') %>"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label"><%= LANG('邮箱验证码') %>：</label>
                        <div class="form-control">
                            <img src="/src/images/pass.png" class="title" alt="">
                            <input autocomplete="off" placeholder="<%= LANG('邮箱验证码') %>" v-model="emailCode"
                                   type="text">
                            <send-code :code-type="1"
                                       :user-name="email"
                                       :user-id="userInfo.userId"
                                       :busType="8"
                                       :img-code="imgCode"
                                       :img-code-id="imgCodeId"
                                       :error-fun="handleRefreshImgcode"/>
                        </div>
                    </div>

                    <div class="form-group" v-if="userInfo.mobileAuth == 1">
                        <label class="control-label"><%= LANG('短信验证码') %>：</label>
                        <div class="form-control">
                            <img src="/src/images/pass.png" class="title" alt="">
                            <input v-model="mobileCode" autocomplete="off" placeholder="<%= LANG('短信验证码') %>"
                                   type="text">
                            <send-code :code-type="2"
                                       :user-name="userInfo.mobile.split(' ')[1]"
                                       :user-id="userInfo.userId"
                                       :busType="8"
                                       :img-code="imgCode"
                                       :img-code-id="imgCodeId"
                                       :error-fun="handleRefreshImgcode"
                            />
                        </div>
                    </div>

                    <div v-if="userInfo.googleAuth == 1 || userInfo.googleAuth == -1" class="form-group">
                        <label class="control-label"><%= LANG('Google验证码') %>：</label>
                        <div class="form-control">
                            <img src="/src/images/pass.png" class="title" alt="">
                            <input autocomplete="off" placeholder="<%= LANG('Google验证码') %>" v-model="googleCode"
                                   name="googleCode" type="text">
                        </div>
                    </div>
                    <div class="form-button">
                        <button v-if="!locked" v-on:click="handleSubmit" :disabled="locked" class="button orange"><%=
                            LANG('提交') %>
                        </button>
                        <button v-if="locked" class="button" disabled><span><%= LANG('正在处理') %></span></button>
                    </div>
                </div>
            </div>
        </div>


    </div>
</script>

<script>
    require(['vue', 'common/methods'], function (Vue, Methods) {
        return Vue.component('set-email', {
            template: "#set-email",
            props: {
                done: {
                    type: Function,
                    default: function () {
                        console.log('success');
                    }
                },
                close: {
                    type: Function,
                    default: function () {
                        console.log('close');
                    }
                }
            },
            data: function () {
                return {
                    locked: false,
                    pubKey: '',
                    rsaKeyId: '',
                    email: '',
                    emailCode: '',
                    mobileCode: '',
                    safePwd: '',
                    googleCode: '',
                    imgCode: '',
                    imgCodeId: '',
                    imageCodeUrl: ''
                }
            },
            computed: {
                authEmail: function () {
                    return Methods.isEmail(this.email);
                },
                userInfo: function () {
                    return Methods.getLocalUserInfo();
                }
            },
            methods: {
                //获取图形验证码
                getImageCode: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/verifycode/controller/website/UserVerifyController/" + 'getValidateCode',
                        success: function (res) {
                            this.imageCodeUrl = res.datas.img;
                            this.imgCodeId = res.datas.imgCodeId;
                        }.bind(this)
                    });
                },
                handleRefreshImgcode: function () {
                    this.getImageCode();
                },
                clearInputError: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    Methods.showLineError(target, "")
                },
                handleCheckLength: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    if ($(target).val() == '') {
                        Methods.showLineError(target, "<%= LANG('验证码格式不正确') %>")
                    } else {
                        Methods.showLineError(target, "")
                    }
                },

                getPubKey: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/BaseApiController/" + 'getPubKey',
                        success: function (res) {
                            this.pubKey = res.datas.pubKey;
                            this.rsaKeyId = res.datas.keyId;
                        }.bind(this)
                    });
                },
                handleSubmit: function () {
                    if (this.locked) {
                        JuaBox.info("<%= LANG('您有未完成的提交，请稍候……') %>");
                        return
                    }
                    var data = {
                        // userId: this.userInfo.userId,
                        email: this.email,
                        emailCode: this.emailCode,
                        dynamicCode: this.mobileCode,
                        rsaKeyId: this.rsaKeyId,
                        safePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
                        googleCode: this.googleCode
                    };
                    if (!this.authEmail) {
                        JuaBox.sure("<%= LANG('请输入有效的邮箱地址') %>");
                    } else if (this.safePwd.length < 6) {
                        JuaBox.sure("<%= LANG('请确认二级密码是否正确') %>");
                    } else if (this.imgCode == '') {
                        JuaBox.sure("<%= LANG('请输入图形验证码') %>");
                    } else if (this.emailCode.length < 6) {
                        JuaBox.sure("<%= LANG('请输入正确的邮箱验证码') %>");
                    } else if (this.mobileCode.length < 6) {
                        JuaBox.sure("<%= LANG('请输入正确的手机验证码') %>");
                    } else {
                        this.locked = true;
                        Methods.ajax({
                            // url: DOMAIN_MAIN + API_PREFIX + 'authEmail',
                            url: DOMAIN_DEV + "/exchange/verifycode/controller/website/UserVerifyController/" + 'authEmail',
                            data: JSON.stringify(data),
                            success: function (res) {
                                this.locked = false;
                                // Methods.setLocalUserInfo(res.datas.getUserInfo);
                                Methods.getUserInfo(function (datas) {
                                    Vue.set(EXX.userIndex.$data, "loginUser", datas);//更新用户中心Vue实例
                                });
                                JuaBox.info(EXX.L(res.resMsg.message), function () {
                                    //reload page
                                    top.location.reload();
                                });

                                this.done();
                            }.bind(this),
                            error: function (res) {
                                this.locked = false;
                                JuaBox.showWrong(EXX.L(res.resMsg.code));
                                // JuaBox.info(EXX.L(res.resMsg.message))
                            }.bind(this)
                        });
                    }
                }
            },
            created: function () {
                this.getPubKey();
                this.getImageCode();
            }
        })
    })
</script>
