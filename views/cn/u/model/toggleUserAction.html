<script type="text/x-template" id="toggle-user-action">

  <div :class="'exx-modal-container exx-' + theme">
    <div class="exx-modal-header"><h3>{{title}}</h3>
    </div>
    <div class="exx-modal-body">
      <div class="exx-account-info">
        <h3>{{params.account.nickName}}</h3>
        <p v-if="params.optType == '4' && !account.childLogin"><%= LANG('设置用户名和密码以允许此子账户独立登录系统') %></p>
        <p v-if="params.optType == '4' && account.childLogin"><%= LANG('设置为不允许此子账户独立登录系统') %></p>
        <p v-if="params.optType == '5' &&  currentMarketLever"><%= LANG('设置此子账户关闭杠杆交易') %></p>
        <p v-if="params.optType == '5' && !currentMarketLever"><%= LANG('设置此子账户开启指定市场的杠杆交易') %></p>
        <div class="avatar"><img :src="userAvatar(params.account)" /></div>
      </div>

      <div class="exx-form-box">
        <div class="form-box">
        <div v-if="params.optType == '4' && !account.childLogin" class="form-group">
          <div class="form-control">
            <input autocomplete="off" placeholder="<%= LANG('账户名') %>" readonly v-model="account.userName" type="text">
          </div>
        </div>
        <div v-if="params.optType == '4' && !account.childLogin" class="form-group">
            <div class="form-control">
            <input autocomplete="new-password" placeholder="<%= LANG('登录密码') %>" v-model="password" type="password">
          </div>
        </div>
        <div class="exx-form-group exx-form-select" v-if="params.optType == '5' && !currentMarketLever">
          <p class="t"><%= LANG('选择杠杆倍数') %>：</p>
          <p>
            <a @click="leverRate = n" v-for="n in (params.maxLever || 3)" :class="{'active': leverRate == n}" role="button">{{n}}倍</a>
          </p>
        </div>


        <div class="form-group">
          <!--<label>-->
            <!--<template v-if="loginUser.userType == 1">-->
              <!--<%= LANG('主账户登录密码') %>-->
            <!--</template>-->
            <!--<template v-else>-->
              <!--<%= LANG('登录密码') %>-->
            <!--</template>-->
          <!--</label>-->
          <div class="form-control">
            <input :placeholder="loginUser.userType == '1' ? '<%= LANG('主账户登录密码') %>' : '<%= LANG('登录密码') %>'" autocomplete="new-password" v-model="safePwd" type="password">
          </div>
        </div>


        <div class="exx-form-row" v-if="params.optType == '5' && !currentMarketLever">
          <div class="exx-checkbox">
            <label><input type="checkbox" v-model="agreenMent"><i></i><span>我已阅读并同意</span></label>
            <p v-if="params.market == 'hpy_hsr'"><a href="/help/forwardRule" target="_blank">《期货规则》</a></p>
            <p v-else=""><a href="/help/leverRule" target="_blank">《杠杆规则》</a></p>
          </div>
        </div>

        <div class="form-button">
          <button @click="saveUserInfo" :disabled="requestLocked" class="button"><span><%= LANG('确定') %></span></button>
        </div>
      </div>
    </div>
    </div>



  </div>

</script>

<script>
    require(['vue', 'common/methods', 'common/juabox'], function (Vue, Methods, JuaBox) {
        return Vue.component('toggle-user-action', {
            template: "#toggle-user-action",
            props: {
                done: {
                    type: Function,
                    default: function () {
                        console.log('success');
                    }
                },
                params: {
                    type: Object,
                    default: function () {
                        return {}
                    }
                },
                theme: {
                    type: String,
                    default: 'light'
                },
                close: {
                    type: Function,
                    default: function () {
                        console.log('close');
                    }
                }
            },
            data: function () {
                return {
                    pubKey: '',
                    requestLocked: false,
                    title: "<%= LANG('子账户登录管理') %>",
                    avatarBasePath: '<%= STATIC %>/images/userhead/',
                    loginUser: Methods.getLocalUserInfo(),
                    password: '',
                    safePwd: '',
                    dynamicCode: '',
                    agreenMent : false,
                    //marketsInfo: EXX.userIndex.allMarketsInfo,
                    //markets: [],
                    userMarkets: [],
                    account: {},
                    leverRate : ''
                }
            },
            computed: {
                currentMarketLever : function () {
                    if(!this.params.account.marketLevers){
                        this.params.account.marketLevers = {}
                    }
                    return this.params.account.marketLevers[this.params.market];
                },
            },
            methods: {
                userAvatar: function (user) {
                    var avatar = user.photo ? user.photo : 'default.jpg';
                    return this.avatarBasePath + avatar;
                },
                handleClose: function () {
                    this.$parent.close()
                    //this.$parent.$parent.showModal = false;
                    /*if (EXX.userIndex) {
                      EXX.userIndex.closeModal()
                    } else if (EXX.tradeSidebar) {
                      EXX.tradeSidebar.closeModal()
                    }*/
                },
                // getPubKey: function () {
                //     Methods.ajax({
                //         type: 'GET',
                //         url: DOMAIN_DEV + "/exchange/controller/website/common/baseapicontroller/" + 'getpubkey',
                //         success: function (res) {
                //             this.pubKey = res.datas.pubKey;
                //         }.bind(this)
                //     });
                // },
                getUserMarkets: function () {
                    var data = {
                        childId: this.params.account.userId
                    };
                    Methods.ajax({
                        url: DOMAIN_MAIN + API_PREFIX + 'getAllMarket',
                        data: data,
                        success: function (res) {
                            if (!res.datas.userMarket) {
                                return console.log('getAllMarket failed.')
                            }
                            this.userMarkets = res.datas.userMarket;
                        }.bind(this)
                    });
                },
                saveUserInfo: function () {
                    if (this.requestLocked) {
                        JuaBox.info("<%= LANG('您有未完成的提交，请稍候……') %>");
                        return
                    }
                    var data = {
                        optType: this.params.optType,
                        targetUserId: this.params.userId,
                        marketName: this.account.loanMarket,
                        userName: this.account.userName,
                        isChildLogin: !this.account.childLogin,
                        isLever: !this.currentMarketLever,
                        leverRate : this.leverRate,
                        targetNewPwd: this.password ? Methods.encryptPwd(this.password, this.pubKey) : '',
                        mainUserPwd: Methods.encryptPwd(this.safePwd, this.pubKey)
                    };
                    //console.log(this.params)
                    if (this.params.optType == '5') {
                        data.marketName = this.params.market;
                    }
                    //console.log(data);
                    /*if (!/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{4,16}$/.test(this.account.userName) && this.params.optType == '4' && data.isChildLogin) {
                        JuaBox.info("<%= LANG('账户名为4到16位包含数字和字母的组合') %>");
                    } else */
                    if (this.password === '' && this.params.optType == '4' && data.isChildLogin) {
                        JuaBox.info("<%= LANG('请输入登录密码') %>");
                    } else if (this.safePwd === '' && (this.params.optType == '4' || this.params.optType == '5')) {
                        JuaBox.info("<%= LANG('请输入主账户登录密码') %>");
                    } else if(this.params.optType == '5' && !this.currentMarketLever && (this.leverRate == '' || this.leverRate < 1 || this.leverRate > this.params.maxLever)){
                        JuaBox.info("<%= LANG('请选择正确的杠杆倍数') %>");
                    } else if(this.params.optType == '5' && !this.currentMarketLever && !this.agreenMent){
                        JuaBox.info("<%= LANG('请您阅读并同意杠杆规则') %>");
                    } else {
                        this.requestLocked = true;
                        Methods.ajax({
                            type: 'POST',
                            url: DOMAIN_MAIN + API_PREFIX + 'saveUserInfo',
                            data: data,
                            success: function (res) {
                                this.requestLocked = false;
                                this.$parent.close();
                                JuaBox.info(EXX.L(res.resMsg.message));
                                this.done()
                            }.bind(this),
                            error: function (res) {
                                this.requestLocked = false;
                                JuaBox.info(EXX.L(res.resMsg.message))
                            }.bind(this)
                        });
                    }
                }
            },
            created: function () {
                var account = this.params.account;
                account.isVirtual = account.isVirtual ? account.isVirtual : false;
                this.account = account;
                if (this.params.optType == '5' && this.currentMarketLever) {
                    this.title = "<%= LANG('关闭杠杆') %> " + this.params.market.replace('_',' / ').toUpperCase();
                } else if (this.params.optType == '5' && ! this.currentMarketLever) {
                    this.title = "<%= LANG('开启杠杆') %> " + this.params.market.replace('_',' / ').toUpperCase();
                }
                //this.getUserMarkets();
                this.getPubKey();
            },
            updated: function () {
            }
        })
    })
</script>

