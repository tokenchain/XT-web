<script type="text/x-template" id="exchangeModal">
    <div class="exx-modal-container exchangeModal">
        <div class="exx-modal-header">
          <h3>{{title}}</h3>
        </div>
        <p class="num-info">可用{{exchangOrigin}}：{{amount | numFilter}}</p>
        <ul>
            <li class="exchangNum">
                <span>兑换{{exchangTarget}}数量：</span><input type="number" :placeholder="'最多可兑换2000' + exchangTarget" v-model="exchangVal" @input = "listenKeyword">
                <!-- <p style="color: red;margin: 10px 0 0 45px;" v-show="warnTips">兑换数量不能超过2000</p> -->
            </li>
            <li class="passWord">
                <span>登录密码：</span><input type="passWord" placeholder="<%= LANG('请输入登录密码') %>" v-model="passWordVal" v-on:focus="clearPwdInputError($event)" autocomplete="new-password">
            </li>
        </ul>
    
      <div class="exx-modal-button">
        <button onclick="EXX.userIndex.closeModal()" class="exxbtn btn-cancel"><span><%= LANG('取消') %></span></button>
        <button class="exxbtn btn-ok" @click="submitExchange"><span><%= LANG('确定') %></span></button>
      </div>
    </div>
</script>

<script>
    require(['vue', 'common/methods', 'common/juabox'], function (Vue, Methods, JuaBox) {
        return Vue.component('exchangeModal', {
            template: "#exchangeModal",
            props: {
                params: {
                    type: Object,
                    default: {}
                },
            },
            data: function () {
                return {
                    title: '',
                    warnTips: false,
                    amount: '',
                    exchangVal: '', // 兑换数量
                    exchangOrigin: '', // 兑换的基础货币
                    exchangTarget: '', // 兑换的目标货币
                    rsaKeyId: '',
                    passWordVal: ''
                }
            },
            filters: {
                numFilter(value) {
                    var realVal = Number(value).toFixed(2)
                    return Number(realVal)
                }
            },
            methods: {
                listenKeyword: function () {
                    console.log(this.exchangVal)
                    if (this.exchangVal >= 2000) {
                        // this.warnTips = true
                    }
                },

                //清除输入框错误信息-ok
                clearPwdInputError: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    Methods.showLineError(target, "")
                    this.pwdState = true;
                },

                //获取公钥-ok
                getPubKey: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/baseapicontroller/" + 'getpubkey',
                        success: function (res) {
                            this.pubKey = res.datas.pubKey;
                            this.rsaKeyId= res.datas.keyId;
                        }.bind(this)
                    });
                },

                submitExchange: function () {
                    if (this.pubKey == "" || this.rsaKeyId == "") {
                        this.getPubKey();
                    }
                    var encryptionPwd = Methods.encryptPwd(this.passWordVal, this.pubKey);
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/xtfundcontroller",
                        data: {
                            rsaKeyId: this.rsaKeyId,
                            passWord: encryptionPwd,
                            subCurrencyTypeName: this.exchangOrigin,
                            addCurrencyTypeName: this.exchangTarget,
                            amount: this.exchangVal
                        },
                        success: function (res) {
                            console.log(res)
                        },
                        error: function (res) {
                            var resMsg = res.resMsg;
                        }
                    })
                }
            },
            created: function () {
                console.log(this.params)
                this.$nextTick(function () {
                    this.getPubKey();
                    this.exchangOrigin = this.params.name.toUpperCase()
                    this.title = this.params.name == 'xc' ? '<%= LANG("XC兑换QC") %>' :
                        '<%= LANG("QC兑换XC") %>'
                    this.exchangTarget = this.params.name == 'xc' ? 'QC' : 'XC'
                    this.amount = this.params.amount
                    console.log(this.amount)
                })
            },
        })
    })
</script>