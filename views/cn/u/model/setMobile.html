<script type="text/x-template" id="set-mobile">
  <div class="exx-modal-container">
    <div class="exx-modal-header"><h3><%= LANG('手机设置') %></h3></div>
    <div class="exx-modal-body">

      <div v-if="step == 1" class="exx-form-box">
        <div class="exx-form-tips" v-if="userInfo.mobileAuth == 1">
          <%= LANG('修改手机并不会立即生效') %>
        </div>
        <div class="form-box">
          <div class="form-group">
            <label class="control-label"><%= LANG('原手机号码') %>：</label>
            <div class="form-control">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" placeholder="<%= LANG('原手机号码') %>" :value="coverPhone(userInfo.mobile)" type="text" readonly>
              <a class="code-num" href="javascript:;" @click="skipOne"><%= LANG('原手机已遗失？') %></a>
            </div>
          </div>
          <div class="form-group">
            <label class="control-label"><%= LANG('图形验证码') %>：</label>
            <div class="form-control" style="display: block !important;">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" placeholder="<%= LANG('图形验证码') %>" v-model="oneImgCode" v-on:blur="handleCheckLength($event)" v-on:focus="clearInputError($event)" maxlength="4" type="text">
              <div class="code-img" v-cloak=""><img :src="imageCodeUrl" style="z-index: 2;" v-on:click="handleRefreshImgcode" alt="<%= LANG('点击刷新验证码') %>"></div>
            </div>
          </div>

          <div class="form-group">
            <label class="control-label"><%= LANG('原手机验证码') %>：</label>
            <div class="form-control">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" placeholder="<%= LANG('原手机验证码') %>" maxlength="6" v-model="oldMobileCode" type="number" >
              <send-code :code-type="2"
                         :country-code="userInfo.countryCode"
                         :user-name="userInfo.mobile.split(' ')[1]"
                         :user-id="userInfo.userId"
                         :bus-type="9"
                         :img-code="oneImgCode"
                         :img-code-id="imgCodeId"
                         :error-fun="handleRefreshImgcode"/>
            </div>
          </div>

          <div class="form-button">
            <button @click="nextStep" class="button"><span><%= LANG('下一步') %></span></button>
          </div>
        </div>
      </div>

      <div v-show="step == 2" class="exx-form-box" style="display:none;">
        <div class="form-box">

          <div class="form-group">
            <!--<label>-->
            <!--<template v-if="userInfo.mobileAuth == 0">-->
            <!--<%= LANG('手机号码') %>-->
            <!--</template>-->
            <!--<template v-else>-->
            <!--<%= LANG('新手机号码') %>-->
            <!--</template>-->
            <!--</label>-->
            <div class="form-control">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" :placeholder="userInfo.mobileAuth == '0' ? '<%= LANG('手机号码') %>' : '<%= LANG('新手机号码') %>'" v-model="mobile" type="text">
              <country-code v-if="showCountry" :selected="selectCountry" />
            </div>
          </div>


          <div class="form-group">
            <div class="form-control" style="display: block !important;">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" placeholder="<%= LANG('图形验证码') %>" v-model="imgCode" v-on:blur="handleCheckLength($event)" v-on:focus="clearInputError($event)" maxlength="4" type="text">
              <div class="code-img" v-cloak=""><img :src="imageCodeUrl" style="z-index: 2;" v-on:click="handleRefreshImgcode" alt="<%= LANG('点击刷新验证码') %>"></div>
            </div>
          </div>

          <div class="form-group">
            <!--<label>-->
            <!--<template v-if="userInfo.mobileAuth == 0">-->
            <!--<%= LANG('手机验证码') %>-->
            <!--</template>-->
            <!--<template v-else>-->
            <!--<%= LANG('新手机验证码') %>-->
            <!--</template>-->
            <!--</label>-->
            <div class="form-control">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" :placeholder="userInfo.mobileAuth == '0' ? '<%= LANG('手机验证码') %>' : '<%= LANG('新手机验证码') %>' " v-model="newMobileCode" type="text">
              <send-code v-if="userInfo.mobileAuth == 0"
                         :code-type="2"
                         :country-code="countryCode"
                         :user-name="mobile"
                         :user-id="userInfo.userId"
                         :bus-type="7"
                         :img-code="imgCode"
                         :img-code-id="imgCodeId"
                         :error-fun="handleRefreshImgcode"/>
              <send-code v-if="userInfo.mobileAuth == 1"
                         :code-type="2"
                         :country-code="countryCode"
                         :user-name="mobile"
                         :user-id="userInfo.userId"
                         :bus-type="9"
                         :img-code="imgCode"
                         :img-code-id="imgCodeId"
                         :error-fun="handleRefreshImgcode"/>
            </div>
          </div>

          <div class="form-group">
            <div class="form-control">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" placeholder="<%= LANG('邮箱验证码') %>" v-model="emailCode" type="text">
              <send-code v-if="userInfo.mobileAuth == 0"
                         :code-type="1"
                         :country-code="countryCode"
                         :user-name="userInfo.email"
                         :user-id="userInfo.userId"
                         :bus-type="7"
                         :img-code="imgCode"
                         :img-code-id="imgCodeId"
                         :error-fun="handleRefreshImgcode"/>
              <send-code v-if="userInfo.mobileAuth == 1"
                         :code-type="1"
                         :country-code="countryCode"
                         :user-name="userInfo.email"
                         :user-id="userInfo.userId"
                         :bus-type="9"
                         :img-code="imgCode"
                         :img-code-id="imgCodeId"
                         :error-fun="handleRefreshImgcode"/>
            </div>
          </div>

          <div class="form-group">
            <label>
              <!--<template v-if="userInfo.safePwdAuth == 0">-->
              <!--<%= LANG('登录密码') %>-->
              <!--</template>-->
              <!--<template v-else>-->
              <!--<%= LANG('资金密码') %>-->
              <!--</template>-->
            </label>
            <div class="form-control">
              <!--<input autocomplete="new-password" :placeholder="userInfo.safePwdAuth == '0' ? '<%= LANG('登录密码') %>' : '<%= LANG('资金密码') %>' " v-model="safePwd" type="password">-->
              <!--<a  v-if="userInfo.safePwdAuth == 1" class="label-a" href="/u/safe/resetSafePwd" target="_blank"><%= LANG('忘记资金密码？') %></a>-->
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="new-password" :placeholder="'<%= LANG('登录密码') %>'" v-model="safePwd" type="password">
              <a style="padding: 10px;display: block;" class="label-a" href="/findLoginPwd" target="_blank"><%= LANG('忘记登录密码') %>？</a>
            </div>
          </div>


          <div v-if="userInfo.googleAuth == 1 || userInfo.googleAuth == -1" class="form-group">
            <div class="form-control">
              <img src="/src/images/pass.png" class="title" alt="">
              <input autocomplete="off" placeholder="<%= LANG('Google验证码') %>" v-model="googleCode" name="googleCode" type="number">
            </div>
          </div>


          <div class="form-button">
            <button v-if="!locked" v-on:click="handleSubmit" class="button"><span><%= LANG('提交') %></span></button>
            <button v-if="locked" class="button" disabled><span><%= LANG('正在处理') %></span></button>
          </div>
        </div>
      </div>


    </div>






  </div>
</script>
<script>
    require(['vue', 'common/methods', 'common/juabox', 'components/country_code/index'], function (Vue, Methods, JuaBox) {
        return Vue.component('set-mobile', {
            template: "#set-mobile",
            props: {
                done: {
                    type: Function,
                    default: function () {
                        // console.log('success');
                    }
                },
                close: {
                    type: Function,
                    default: function () {
                        // console.log('close');
                    }
                }
            },
            data: function () {
                return {
                    pubKey: '',
                    rsaKeyId:'',
                    locked: false,
                    step: 1,
                    // loginUser: Methods.getLocalUserInfo(),
                    countryCode: '+86',
                    mobile: '',
                    newMobileCode: '',
                    oldMobileCode: '',
                    emailCode: '',
                    safePwd: '',
                    googleCode: '',
                    imgCode: '',
                    imgCodeId: '',
                    imageCodeUrl: '',
                    oneImgCode:''
                }
            },
            computed: {
                userInfo: function () {
                    return Methods.getLocalUserInfo();
                },
                showCountry: function () {
                    return this.mobile.length && Methods.isAllNumber(this.mobile);
                }
            },
            methods: {
                clearInputError: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    Methods.showLineError(target, "")
                },
                handleCheckLength: function (e) {
                    var target = e.target || e.currentTarget || e.srcElement;
                    if ($(target).val() == '') {
                        Methods.showLineError(target, "<%= LANG('验证码格式不正确') %>")
                    } else {
                        Methods.showLineError(target, "")
                    }
                },
                //获取图形验证码
                getImageCode: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/verifycode/controller/website/UserVerifyController/" + 'getValiDateCode',
                        success: function (res) {
                            this.imageCodeUrl = res.datas.img;
                            this.imgCodeId = res.datas.imgCodeId;
                        }.bind(this)
                    });
                },
                handleRefreshImgcode: function () {
                    this.getImageCode();
                },
                getPubKey: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/BaseApiController/" + 'getPubKey',
                        success: function (res) {
                            this.pubKey = res.datas.pubKey;
                            this.rsaKeyId= res.datas.keyId;
                        }.bind(this)
                    });
                },
                coverPhone: function (phone) {
                    return Methods.coverPhone(phone);
                },
                selectCountry: function (country) {
                    this.countryCode = country.code
                },
                nextStep: function () {
                    if(this.oneImgCode.length!=4&&this.oneImgCode==''){
                        JuaBox.sure("<%= LANG('请输入图形验证码(四位数字)') %>");
                    }else{
                        if (this.oldMobileCode.length != 6) {
                            JuaBox.sure("<%= LANG('请输入原手机验证码(六位数字)') %>");
                            return
                        }
                        this.getImageCode();
                        this.step = 2;
                    }

                },
                skipOne: function () {
                    this.step = 2;
                    this.oldMobileCode = '';
                },
                handleSubmit: function () {
                    var _this = this;
                    if (this.locked) {
                        JuaBox.info("<%= LANG('您有未完成的提交，请稍候……') %>");
                        return
                    }
                    var data = {
                        // userId: this.userInfo.userId,
                        countryCode: this.countryCode,
                        phone: this.mobile,
                        emailCode: this.emailCode,
                        mobileCode: this.newMobileCode,
                        rsaKeyId: this.rsaKeyId,
                        rsaEncodePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
                        googleCode: this.googleCode
                    };
                    var url = DOMAIN_DEV + "/exchange/user/controller/website/usercontroller/" + 'doAuthMobile';

                    if (this.userInfo.mobileAuth == 1) {
                        url = DOMAIN_DEV + "/exchange/user/controller/website/usercontroller/" + 'domodifymobile';
                        data = {
                            // userId: this.userInfo.userId,
                            countryCode: this.countryCode,
                            phone: this.mobile,
                            emailCode: this.emailCode,
                            oldMobileCode: this.oldMobileCode,
                            newMobileCode: this.newMobileCode,
                            rsaKeyId: this.rsaKeyId,
                            rsaEncodePwd: Methods.encryptPwd(this.safePwd, this.pubKey),
                            googleCode: this.googleCode
                        }
                    }

                    if (!this.mobile) {
                        JuaBox.sure("<%= LANG('请输入有效的手机号码') %>");
                    } else if (this.safePwd.length < 6) {
                        JuaBox.sure("<%= LANG('登录密码不正确') %>");
                    } else if (!this.oldMobileCode.length && this.emailCode.length < 6 && this.userInfo.mobileAuth == 1) {
                        JuaBox.sure("<%= LANG('请输入正确的邮箱验证码') %>");
                    } else if (this.imgCode=='') {
                        JuaBox.sure("<%= LANG('请输入图形验证码') %>");
                    }else if (this.newMobileCode.length < 6) {
                        JuaBox.sure("<%= LANG('请输入正确的手机验证码') %>");
                    } else {
                        _this.locked = true;
                        Methods.ajax({
                            url: url,
                            data: data,
                            success: function (res) {
                                _this.locked = false;
                                Methods.getUserInfo(function (datas) {//重新获取用户信息并保存到本地用户信息
                                    Vue.set(EXX.userIndex.$data, "loginUser", datas);//更新用户中心Vue实例
                                });
                                JuaBox.info(EXX.L(res.resMsg.message), function () {
                                    top.location.reload();
                                });

                                _this.done();
                            }.bind(this),
                            error: function (res) {
                                _this.locked = false;
                                JuaBox.showWrong(EXX.L(res.resMsg.code));
                                // JuaBox.info(EXX.L(res.resMsg.message))
                            }.bind(this)
                        });
                    }
                }
            },
            created: function () {
                this.getPubKey();
                if (this.userInfo.mobileAuth == 0) {
                    this.step = 2;
                }
                this.getImageCode();
            }
        });
    });

</script>

