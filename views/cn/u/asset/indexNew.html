<style type="text/css">
    button {
        width: auto;
    }

    .sweet-alert .sa-icon.sa-custom {
        width: 180px !important;
    }
</style>
<script>
    require(['vue', 'common/methods'], function (Vue, Methods) {
        EXX.userNav = new Vue({
            el: '#user-nav',
            data: function () {
                return {
                    loaded: true,
                    isLogin: ISLOGIN,
                    assistPrice: '',
                    // topNews: [],
                    hasReadNews: [],
                    showTopNews: false,
                    showAssetDrop: false,
                    assetInterVal: null,
                    lastAssetTime: 0,
                    isMobile: Methods.isMobile(),
                    ExchangeMode: [
                        "<%= LANG('模拟交易')%>",
                        "<%= LANG('实盘交易')%>"
                    ],
                    currentExchangeMode: Methods.getCookie(ENV + 'ExchangeMode') || 1,
                    tradeTheme: 'dark',
                    showModal: false,
                    transferInfo: {},
                    payinCoin: '',
                    marketConfig: '',
                    userInfo: '',
                    userAssets: [],
                    coinConfig: '',
                    loginUser: Methods.getLocalUserInfo(ENV + 'userInfo'), //用户信息,
                    marketAreaList: [],
                }
            },
            watch: {
                showAssetDrop: function (newVal, oldVal) {
                    //下拉展开资产的时候立即获取资产并且开启定时器
                    if (this.showAssetDrop && this.isLogin) {
                        //获取汇率
                        this.getAssistPrice();
                        //获取用户资金
                        this.getAccountAssets();
                        //获取货币信息
                        this.getCoinConfig();

                        this.assetInterVal = setInterval(function () {
                            //获取汇率
                            this.getAssistPrice();
                            //获取用户资金
                            this.getAccountAssets();
                            //获取货币信息
                            this.getCoinConfig();
                        }.bind(this), 3000)
                    } else {
                        window.clearInterval(this.assetInterVal);
                    }
                },
                showTopNews: function () {
                    if (!this.showTopNews) {
                        $('body').removeClass('notice-open');
                    } else {
                        $('body').addClass('notice-open');
                    }
                }
            },
            computed: {
                currentAccountId: function () {
                    if (this.isLogin) {
                        return Methods.getCookie(ENV + 'currentAccountId') || Methods.getCookie(ENV + 'uid');
                    }
                },
                /**
                 * 格式化用户资产数据
                 * 将金额不为0的货币与所有货币列表整合
                 */
                userCoinFunds: function () {
                    var coins = this.coinConfig || [];
                    var userAssets = this.userAssets;

                    var coinAssets = [];
                    coins.forEach(function (coin, index, array) {
                        var coinItem = coin;
                        userAssets.forEach(function (asset, idx, arr) {
                            if (coin.currencyId == asset.currencyTypeId) {
                                for (var k in asset) {
                                    coin[k] = asset[k];
                                }
                            }
                        });
                        coinAssets.push(coinItem);
                    }.bind(this));

                    return coinAssets;
                }
            },
            methods: {
                logout: function () {
                    Methods.logout();
                },
                //获取大写货币名称
                getCoinName: function (market) {
                    // return !market ? '' :  market.split('_')[0].toUpperCase();
                    if (market.name.split('_').length > 1) {
                        return !market ? '' : market.name.split('_')[0].toUpperCase();
                    } else {
                        // console.log('coin name incorrect: ' + market.name);
                        return '';
                    }
                },
                //获取小写货币名称
                getCoinMinName: function (market) {
                    // return !market ? '' :  market.split('_')[0].toLowerCase();
                    if (market.name.split('_').length > 1) {
                        return !market ? '' : market.name.split('_')[0].toLowerCase();
                    } else {
                        // console.log('coin name incorrect: ' + market.name);
                        return '';
                    }
                },
                //获取交易所属类型
                getMoneyName: function (market) {
                    // return !market ? '' :  market.split('_')[1].toUpperCase();
                    if (market.name.split('_').length > 1) {
                        return !market ? '' : market.name.split('_')[1].toUpperCase();
                    } else {
                        // console.log('coin name incorrect: ' + market.name);
                        return '';
                    }
                },
                //获取交易名称
                getTradeName: function (market) {
                    // return !market ? '' :  market.split('_')[1].toUpperCase();
                    if (market.name.split('_').length > 1) {
                        return !market ? '' : market.name.split('_')[0].toLowerCase() + '_' + market.name.split('_')[1].toLowerCase();
                    } else {
                        // console.log('coin name incorrect: ' + market.name);
                        return '';
                    }
                },
                goToExchange: function (type, market) {
                    Methods.setCookie(ENV + 'ExchangeMode', 1, 7);

                    if (type == 2) {
                        window.location.href = '/trade/' + market;
                    } else {
                        window.location.href = '/tradePro/' + market;
                        //window.location.href = DOMAIN_MAIN + '/trade?market=' + market;
                    }
                },
                //设置语言
                setLan: function (lan) {
                    console.log(lan)
                    var name = ENV + 'lan';
                    Methods.setCookie(name, lan);
                    top.location.reload();
                },
                openPayin: function (coin) {
                    this.payinCoin = coin;
                    this.showModal = 'payin';
                },
                openTransfer: function (type, userId, coin) {
                    this.transferInfo = {
                        type: type,
                        userId: userId,
                        coin: coin
                    };
                    this.showModal = 'transfer';
                },
                /*
                * 获取所有货币信息
                * */
                getCoinConfig: function () {
                    var data = {
                        // webId: 100
                    };
                    Methods.ajax({
                        type: 'GET',
                        //url: DOMAIN_MAIN + API_PREFIX + 'getCoinMaps',
                        data: data,
                        url: DOMAIN_DEV + "/exchange/config/controller/website/currencycontroller/" + 'getCurrencyList',
                        success: function (res) {
                            this.coinConfig = res.datas;
                        }.bind(this)
                    });
                },
                // 获取用户总额不为零的货币信息(财务中心)
                getAccountAssets: function () {
                    var data = {
                        // webId: 100,
                        userId: Methods.getLocalUserInfo(ENV + 'userInfo').userId,
                        pageSize: 9999,
                        pageNum: 1
                    };
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/fundcontroller/" + 'findbypage',
                        data: JSON.stringify(data),
                        success: function (res) {
                            this.loaded = true;

                            if (res.datas.list) {
                                this.userAssets = res.datas.list;
                            }
                        }.bind(this),
                        error: function () {
                        }
                    });
                },
                // 获取币价汇率
                getAssistPrice: function (callback) {
                    Methods.ajax({
                        // url: DOMAIN_MAIN + API_PREFIX + 'getAssistPrice',
                        url: DOMAIN_DEV + "/exchange/config/controller/website/pricecontroller/" + 'getassistprice',
                        success: function (res) {
                            this.assistPrice = res.datas;
                            callback && callback();
                        }.bind(this),
                        error: function () {
                        }
                    });
                },
                //获取用户信息-ok
                getUserInfo: function () {
                    var _this = this;
                    Methods.ajax({
                        type: 'POST',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/usercontroller/" + 'getuserinfo',
                        success: function (res) {
                            _this.userInfo = res.datas;
                            //更新用户信息
                            Methods.setLocalUserInfo(res.datas);
                        }
                    });
                },

                initSwiftTrade: function () {
                    $(".group-list.l1").on('mouseover', '.group-tab li', function () {
                        $(".group-list.l1 .group-tab li").removeClass('active');
                        $(this).addClass('active');

                        $(".group-list.l1 .group-box ul").removeClass('block');
                        $(".group-list.l1 .group-box ul").eq($(this).index()).addClass('block');
                        //console.log($(this).index())
                    })
                    $(".group-list.l2").on('mouseover', '.group-tab li', function () {
                        $(".group-list.l2 .group-tab li").removeClass('active');
                        $(this).addClass('active');

                        $(".group-list.l2 .group-box ul").removeClass('block');
                        $(".group-list.l2 .group-box ul").eq($(this).index()).addClass('block');
                        //console.log($(this).index())
                    })
                },
                // 获取市场配置
                getMarketConfig: function () {
                    var _this = this;

                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/config/controller/website/marketcontroller/" + 'getByWebId',
                        success: function (res) {
                            _this.marketConfig = res.datas;
                        }
                    });
                },
                getMarketAreaListByWebId: function () {
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/config/controller/website/MarketController/" + 'getMarketAreaListByWebId',
                        success: function (res) {
                            this.marketAreaList = res.datas
                        }.bind(this)
                    });
                },
                getMarketClass: function (item, index) {
                    var index = index
                    if (index == 0) {
                        console.log(item)
                        return item.name + ' block'
                    } else {
                        return 'block'
                    }
                }
            },
            mounted: function () {
                this.getMarketAreaListByWebId();

                if (this.isLogin) {
                    //获取用户信息
                    this.getUserInfo();
                    //获取用户资金
                    this.getAccountAssets();
                }
                //获取货币信息
                this.getCoinConfig();
                //获取市场配置
                this.getMarketConfig();
                //初始化鼠标监听
                this.initSwiftTrade();

                // 消息相关
                // this.getTopNewsList();
                // this.getHasReadNews();
            },
            created: function () {
            }
        })
    })
</script>
<script src="/lib/others/jquery.peity.js" charset="utf-8"></script>
<div class="user-container" id="user-index">
    <div v-if="!loaded" class="cd-loading">
        <div class="vertical-bars">
            <p class="layer-1"></p>
            <p class="layer-2"></p>
            <p class="layer-3"></p>
            <p class="layer-4"></p>
            <p class="layer-5"></p>
            <p class="layer-6"></p>
            <p class="layer-7"></p>
            <p class="layer-8"></p>
            <p class="layer-9"></p>
        </div>
    </div>
    <div v-else>
        <div class="assets-list" v-cloak="" v-if="loaded">
            <!--<div class="total-assets">-->
            <!--<h3><%= LANG('账户资产价值') %></h3>-->
            <!--<p class="num">{{allTotalAsset}} USD</p>-->
            <!--</div>-->
            <div class="cd-table">

                <div class="filter">
                    <search-box v-model="keyWord"></search-box>
                    <div class="cd-select"><p><%= LANG('隐藏0资产币种') %></p><a role="button" @click="hideZero = !hideZero"
                                                                           :class="{'on' : hideZero}"></a></div>
                </div>
                <div class="head">
                    <ul>
                        <li class="coin-name"><%= LANG('币种') %></li>
                        <li><%= LANG('总额') %></li>
                        <li><%= LANG('可用') %></li>
                        <li><%= LANG('冻结') %></li>
                        <li class="oper"><%= LANG('操作') %></li>
                    </ul>
                </div>
                <div class="body">
                    <ul v-for="(item,index) in filterUserCoinFunds(userCoinFunds)"
                        v-if="(hideZero && getTotalPriceByAssist(item) > 0) || !hideZero">
                        <li class="coin-name">
                            <img
                                    v-if="item.name =='dcr'||item.name =='sc'||item.name =='xz'||item.name =='xtz'||item.name =='dash'||item.name =='xem'||item.name =='xlm'||item.name =='ada'||item.name =='xwc'||item.name =='xt'||item.name =='doge'||item.name =='bch'"
                                 :src="'<%= STATIC %>/images/icon/coin/' + item.name.toLowerCase() + '.png?<%= VERSION%>'"
                                 class="icon-coin"/>
                            <img v-else :src="'<%= STATIC %>/images/icon/coin/' + item.name.toLowerCase() + '.svg?<%= VERSION%>'"
                                class="icon-coin"/><b>{{getRealCoinName(item.name).toUpperCase()}}</b></li>
                        <li><span class="hint--top" :aria-label="showTotalAssistHint(item)">{{fixTotalDecimal(item,8) | filterNum}}</span>
                        </li>
                        <li><span class="hint--top" :aria-label="showAvailableAssistHint(item)">{{fixAvailableDecimal(item,8) | filterNum}}</span>
                        </li>
                        <li><span class="hint--top" :aria-label="showFreezeAssistHint(item)">{{fixFreezeDecimal(item,8) | filterNum}}</span>
                        </li>
                        <li class="oper">
                            <template v-if="loginUser.userType == 1"><!--onclick="transFromZb('btc')"-->
                                <!--2018年07月25日 新增功能-->
                                <!--<a class="hint&#45;&#45;top" :aria-label="'当前锁仓'+ getuserfeetotalData.totalLockAmount" v-if="item.name.toUpperCase() == 'ZT'"-->
                                   <!--@click="unlockZT()">-->
                                    <!--<%= LANG('解锁ZT') %>-->
                                <!--</a>-->
                                <a v-if="item && item.rechargeFlag == 1 && item.isLegalCoin == 0"
                                   :href="'/u/payin/' + item.name" target="_self"><%= LANG('充值') %></a>
                                <a v-else-if="item && item.rechargeFlag == 1 && item.isLegalCoin == 1"
                                   :href="'/u/payin/legaltender/' + item.name"><%= LANG('充值') %></a>
                                <a v-else onclick="JuaBox.info('Not open yet...')" class="disabled"><%= LANG('充值')
                                    %></a>
                                <a v-if="item.drawFlag == 1 && item.isLegalCoin == 0" :href="'/u/payout/' + item.name"><%=
                                    LANG('提币') %></a>
                                <a v-else-if="item.drawFlag == 1 && item.isLegalCoin == 1"
                                   :href="'/u/payout/legaltender/' + item.name"><%= LANG('提币') %></a>
                                <a v-else onclick="JuaBox.info('Not open yet...')" class="disabled"><%= LANG('提币')
                                    %></a>
                            </template>
                            <a :href="'/u/bill/' + item.name"><%= LANG('账单') %></a>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="trade-form-modal" v-if="isShowIntoModle" v-cloak>
            <div class="trade-form-verification">
                <span class="verification-close" @click="closeInto">X</span>
                <div class="verification-title">XT<%= LANG('转入')%></div>
                <input id="verification-input-2" type="number" min="0" placeholder="<%= LANG('请输入数量') %>"
                       v-model="intoNum">
                <button class="" @click="AssetsInto(intoNum)"><%= LANG('确定')%></button>
            </div>
        </div>
    </div>
    <modal :open="showModal == 'userAction'" @close="showModal = false">
        <user-action :params="userParams" :done="userActionSuccess()"/>
    </modal>

    <modal :open="showModal == 'toggleUserAction'" @close="showModal = false">
        <toggle-user-action :params="userParams" :done="userActionSuccess()"/>
    </modal>

    <modal :open="showModal == 'setMobile'" @close="showModal = false">
        <set-mobile :done="setMobileSuccess()"/>
    </modal>

    <modal :open="showModal == 'payMobileAuth'" @close="showModal = false">
        <paymobile/>
    </modal>

    <modal :open="showModal == 'setGoogle'" @close="showModal = false">
        <set-google/>
    </modal>

    <modal :open="showModal == 'setEmail'" @close="showModal = false">
        <set-email/>
    </modal>

    <modal :open="showModal == 'safepassword'" @close="showModal = false">
        <safepassword/>
    </modal>

    <modal :open="showModal == 'addMarket'" @close="showModal = false">
        <add-market :params="marketParams"/>
    </modal>

    <modal :open="showModal == 'addCoin'" @close="showModal = false">
        <add-coin :params="coinParams"/>
    </modal>

    <modal :open="showModal == 'transfer'" @close="showModal = false">
        <transfer :info="transferInfo" :done="transferSuccess"/>
    </modal>

    <modal :open="showModal == 'payin'" @close="showModal = false">
        <modal-payin :coin="payinCoin" :done="callCloseModal()"/>
    </modal>

    <modal :open="showModal == 'payout'" @close="showModal = false">
        <modal-payout ref="payout" :coin="payoutCoin"/>
    </modal>

    <modal :open="showModal == 'bill'" @close="showModal = false">
        <bill :params="billParams" theme="light"/>
    </modal>

    <modal :open="showModal == 'refund'" @close="showModal = false">
        <modal-refund :params="refundParams" :user-asset="userAssets.getObject('userId', currentAccountId)"
                      :done="callCloseModal()"/>
    </modal>

    <modal :open="showModal == 'safeset'" @close="showModal = false">
        <safeset/>
    </modal>

    <modal :open="showModal == 'setloginpwd'" @close="showModal = false">
        <setloginpwd/>
    </modal>
</div>


<%-include("../../component/search_box.html")%>
<%-include("../../component/json_grid.html")%>
<%-include("../../component/json_table.html")%>
<%-include("../../component/send_code.html")%>
<%-include("../../component/page_lite.html")%>
<%-include("../../component/modal.html")%>
<%-include("../../component/circular_progress.html")%>

<%-include("../model/userAction.html")%>
<%-include("../model/toggleUserAction.html")%>
<%-include("../model/setMobile.html")%>
<%-include("../model/payMobileAuth.html")%>
<%-include("../model/setgoogle.html")%>
<%-include("../model/email.html")%>
<%-include("../model/addcoin.html")%>
<%-include("../model/safePassword.html")%>
<%-include("../model/insideDebit.html")%>
<%-include("../model/payin.html")%>
<%-include("../model/payout.html")%>
<%-include("../model/bill.html")%>
<%-include("../model/refund.html")%>
<%-include("../model/safeset.html")%>
<%-include("../model/setLoginPwd.html")%>


<script>
    $(function () {
        if ($('.mask span').text() <= 50) {
            $('.circle_right').css('transform', 'rotate(' + ($('.mask span').text() * 3.6) + 'deg)');
        } else {
            $('.circle_right').css({
                'transform': 'rotate(0deg)',
                "background": "#fba81c"
            });
            $('.circle_left').css('transform', 'rotate(' + (($('.mask span').text() - 50) * 3.6) + 'deg)');
        }
    })
</script>


<script>

    $(function () {
        $.fn.peity.defaults.bar = {
            delimiter: ",",
            fill: ["#414253"],
            height: 32,
            max: null,
            min: 0,
            padding: 0.1,
            width: 60
        };
        $(".linebar").peity("bar");
    });


    require(['vue', 'common/methods', 'common/juabox', 'components/country_code/index'], function (Vue, Methods, JuaBox) {

        //释放JuaBox到全局使用
        window.JuaBox = JuaBox;


        EXX.userIndex = new Vue({
            el: "#user-index",
            data: function () {
                return {
                    isShowIntoModle: false,
                    curIntoCurrency: '',
                    intoNum: '',
                    // isLogin : ISLOGIN,
                    loaded: false,
                    // pubKey: '',
                    timer: false,
                    hideZero: false,
                    showModal: false,
                    showAllAsset: false,
                    showCurrencyList: false,
                    mShowCoinDetail: false,
                    avatarBaseUrl: '<%= STATIC %>/images/userhead/',
                    repaymentAmount: '',
                    winWidth: window.innerWidth,
                    currentPriceType: MONEY,
                    userAssets: EXX.userNav.userAssets, //旧的逻辑是 用户头部基本信息和各种货币金额信息，现在改为金额不为零的货币的信息
                    mainUserAssets: [],
                    coinConfig: EXX.userNav.coinConfig,  //从顶部vue实例获取数据
                    assistPrice: {
                        'btc': {
                            btc: 0,
                            ltc: 0,
                            eth: 0,
                            etc: 0
                        },
                        '<%= UNIT %>': {
                            btc: 0,
                            ltc: 0,
                            eth: 0,
                            etc: 0
                        },
                        'usd': {
                            btc: 0,
                            ltc: 0,
                            eth: 0,
                            etc: 0
                        }
                    },
                    loginUser: Methods.getLocalUserInfo(),
                    allSubAccounts: [],
                    safePwd: '',
                    dynamicCode: '',
                    googleCode: '',
                    payinCoin: '',
                    payoutCoin: '',
                    billParams: {},
                    refundParams: {},
                    coinParams: {},
                    userParams: {},
                    marketParams: {},
                    transferInfo: {},
                    editAccountInfo: {},
                    // allMarketsInfo: [],
                    // currencyList: [
                    //     {key: 'usd', name: 'USD', icon: 'icon-meiyuan', symbol: '$',decimal : 2},
                    //     {key: 'cny', name: 'CNY', icon: 'icon-cny', symbol: '¥',decimal : 2}
                    // ],
                    MONEY: 'usd',
                    // MONEY: MONEY == 'none' ? '<%= UNIT %>' : MONEY,

                    currentAccountId: (Methods.getCookie(ENV + 'currentAccountId') || Methods.getCookie(ENV + 'uid')),
                    keyWord: '',
                    xt_eth_exchangeList: ["xt", "ink", "chat", "topc", "bat", "1st", "qun", "true", "cdc", "ddm", "hotc", "xuc", "gram", "omg", "btm", "snt", "ae", "icx", "zrx", "edo", "fun", "mana", "rcn", "mco", "mith", "knc", "gnt", "mtl", "sub", "eosdac", "kan"],
                    getuserfeetotalData: '',
                    todayminerstatDta:'',
                    getuserfeetotalData:{
                        totalLockAmount:'--'
                    },//个人ZT资产数据
                    sortBy: 'lastPrice',   //'rateDown',
                }
            },
            computed: {
                /**
                 * 格式化用户资产数据
                 * 将金额不为0的货币与所有货币列表整合
                 */
                userCoinFunds: function () {
                    var coins = this.coinConfig || [];
                    var userAssets = this.userAssets;

                    var coinAssets = [];
                    coins.forEach(function (coin, index, array) {
                        var coinItem = coin;
                        userAssets.forEach(function (asset, idx, arr) {
                            if (coin.currencyId == asset.currencyTypeId) {
                                for (var k in asset) {
                                    coin[k] = asset[k];
                                }
                            }
                        });
                        coinAssets.push(coinItem);
                    }.bind(this));

                    return coinAssets;
                },
                //计算总资产金额
                allTotalAsset: function () {
                    var alltotal = 0;
                    var money = this.MONEY == 'none' ? 'btc' : this.MONEY;
                    var _this = this;

                    this.userCoinFunds.forEach(function (coin, index) {
                        var amount = coin.amount || 0;
                        console.log(parseFloat(amount * _this.moneyPrice(money, coin.name)))
                        alltotal += parseFloat(amount * _this.moneyPrice(money, coin.name));

                    });
                    return Methods.fixNumber(alltotal, 3);
                },
                isMock: function () {
                    return this.currentUserInfo.userType == 3;
                }
            },
            watch: {
                showModal: function (value) {
                    // 添加class控制弹窗时不滚动主页内容
                    if (value) {
                        $('body').addClass('modal-open');
                    } else {
                        $('body').removeClass('modal-open');
                    }
                }
            },
            methods: {
                //查询zb支持充值的币种
                findCurrency: function (name) {
                    var bool = false;
                    this.zb_eth_exchangeList.forEach(function (value) {
                        if (value == name) {
                            bool = true;
                        }
                    });
                    return bool;
                },
                closeInto: function () {
                    this.isShowIntoModle = false;
                    this.intoNum = '';
                },
                checkNumber: function (theObj) {
                    var reg = /^[0-9]+.?[0-9]*$/;
                    if (reg.test(theObj)) {
                        return true;
                    }
                    return false;
                },
                AssetsInto: function (num) {
                    if (!this.intoNum) {
                        JuaBox.info("<%= LANG('请输入数量')%>");
                        return;
                    }
                    var that = this;
                    var data = {
                        "currency": this.curIntoCurrency,             // 币种
                        "amount": num,                // 数量
                        "zbUserId": this.loginUser.externalUserId     // zb平台的用户ID
                    }
                    this.closeInto();
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/FundController/fundTransfer",
                        data: data,
                        success: function (res) {
                            JuaBox.success("<%= LANG('成功')%>", function () {
                                // window.location.reload();
                                that.getCoinConfig();
                            });
                        }.bind(this),
                        error: function (res) {
                            JuaBox.wrong(res.resMsg.message);
                        }
                    });
                },
                currencySymbol: function (currency) {
                    return this.currencyList.getObject('key', currency).symbol;
                },
                //排序的方法-ok
                doSortMarket: function (markets) {
                    if (sortBy == '' || markets.length == 0) {
                        return markets;
                    }
                    // console.log(markets, 'markets')
                    // console.log(this.assistPrice, 'this.assistPrice')
                    var sortBy = this.sortBy;
                    var xtArr = markets.filter(function (item, i) {
                        return item.name.indexOf('xt') !== -1
                    }).sort(function (x, y) {
                        if (sortBy == 'lastPrice') {
                            return this.assistPrice.cny[x.name] - this.assistPrice.cny[y.name];
                        }
                        /*if (sortBy == 'rateUp') {
                            // return x.rate - y.rate;
                            return x.rate - y.rate;
                        } else if (sortBy == 'rateDown') {
                            // return y.rate - x.rate;
                            return y.rate - x.rate;
                        } else if (sortBy == 'volumeUp') {
                            // return x.convertVolume - y.convertVolume;
                            return x.convertVolume - y.convertVolume;
                        } else if (sortBy == 'volumeDown') {
                            // return y.convertVolume - x.convertVolume;
                            return y.convertVolume - x.convertVolume;
                        } else if(sortBy == 'lastPrice') {
                            return y.lastPrice - x.lastPrice;
                        }*/
                    })
                    // console.log(markets, 'marketsmarketsmarketsmarkets')
                    markets.sort(function (x, y) {
                        if (sortBy == 'lastPrice') {
                            return (this.assistPrice.cny[y.name] - this.assistPrice.cny[x.name]);
                        }
                    }.bind(this));
                    return xtArr.concat(markets.filter(function (item, i) {
                        return item.name !== 'xt'
                    }));
                },
                //搜索过滤
                filterUserCoinFunds: function (objs) {
                    var _this = this;
                    if (!_this.keyWord) {
                        return this.doSortMarket(objs.filter(function (item, i) {
                            return item.name !== 'qtum'
                        }))
                    }
                    var nObj = [];
                    objs.forEach(function (coin, index) {
                        var coinName = coin.name;
                        if (coinName.toLowerCase().indexOf(_this.keyWord.toLowerCase()) != -1 && coinName !== 'qtum') {
                            nObj.push(coin);
                        }
                    });
                    return this.doSortMarket(nObj);
                },
                userHidedCoins: function (user) {
                    var fundMaps = user.coinFundMap;
                    var hidedCoins = [];
                    Object.keys(fundMaps).map(function (coin) {
                        var obj = fundMaps[coin];
                        if (!obj.showCoin) {
                            obj.coin = coin;
                            hidedCoins.push(fundMaps[coin]);
                        }
                    });
                    return hidedCoins;
                },
                showFixNumber: function (price) {
                    return Methods.fixNumber(price, 3);
                },
                showNumber: function (val) {
                    return Methods.fixDecimal(val, 8)
                },
                priceDisplay: function (num, money) {
                    var moneyPrice = this.moneyPrice(money, 'btc');
                    return moneyPrice * Number(num);
                },
                resetCurrency: function (coin) {
                    return coin != '' && coin != 'none' ? coin : '<%= UNIT %>';
                },
                moneyPrice: function (money, coin) {
                    var money = money || 'usd';
                    return Number(this.assistPrice[money] && this.assistPrice[money][coin] ? this.assistPrice[money][coin] : 1)
                },
                userEnabledCoin: function (user) {
                    var coinFundMap = user.coinFundMap;
                    var enabled = [];
                    Object.keys(coinFundMap).forEach(function (coin) {
                        if (coinFundMap[coin].show) {
                            coinFundMap[coin]['name'] = coin;
                            enabled.push(coinFundMap[coin]);
                        }
                    });
                    return enabled;
                },
                openModal: function (name) {
                    if (name == 'setMobile' && this.loginUser.emailAuth == 0) {
                        JuaBox.info("<%= LANG('需要先认证邮箱才能修改手机号码。')%>")
                        this.showModal = false;
                        return
                    }
                    this.showModal = name;
                    //this.$refs[name].open = true;
                },
                callCloseModal: function () {
                    return function () {
                        this.showModal = false;
                    }.bind(this)
                },
                closeModal: function () {
                    this.showModal = false;
                },
                linkToMarket: function (account) {
                    // Methods.setCookie(ENV+'currentAccountId', account.userId);
                    window.location.replace('/trade');
                },
                openCurrencyList: function (id) {
                    this.showCurrencyList = id;
                },
                openPayin: function (coin) {
                    this.showModal = 'payin';
                    this.payinCoin = coin;
                },
                openPayout: function (coin) {
                    this.showModal = 'payout';
                    this.payoutCoin = coin;
                },
                openBill: function (userId, coin) {
                    this.billParams = {
                        userId: userId,
                        coin: coin
                    };
                    this.showModal = 'bill';
                },
                openRefund: function (userId, coin) {
                    this.refundParams = {
                        userId: userId,
                        coin: coin
                    };
                    this.showModal = 'refund';
                },
                openAddMarket: function (account) {
                    this.showModal = 'addMarket';
                    this.showMainHide = false;
                    this.marketParams = {
                        account: account
                    }
                },
                setEmail: function () {
                    if (this.loginUser.emailAuth == 1) {
                        return
                    }
                    this.showModal = 'setEmail';
                },
                editUser: function (userId) {
                    this.userParams = {
                        optType: 3,
                        userId: userId,
                        account: this.loginUser
                    };
                    this.showModal = 'userAction';
                },
                //获取指定辅助货币的总价格-ok
                getTotalPriceByAssist: function (coin) {
                    if (!coin || !this.assistPrice) {
                        return ''
                    }
                    var assistCoin = this.MONEY;
                    var amount = coin.amount || 0;
                    if (assistCoin == 'none' || assistCoin == '') {
                        return Methods.fixNumber(amount, 4);
                    } else {
                        return Methods.fixNumber(parseFloat(amount) * parseFloat(this.assistPrice[assistCoin][coin.name]), 4) || '--';
                    }
                },
                //获取指定辅助货币折算的价格-ok price-要折算的价格
                getConvertPriceByAssist: function (coin, price) {
                    if (!coin || !this.assistPrice) {
                        return ''
                    }
                    var assistCoin = this.MONEY;
                    if (price != 0) {
                        if (assistCoin == 'none' || assistCoin == '') {
                            return Methods.fixNumber(price, 4);
                        } else {
                            return Methods.fixNumber(parseFloat(price) * parseFloat(this.assistPrice[assistCoin][coin.name.toLowerCase()]), 4) || '--';
                        }
                    } else {
                        return '--'
                    }

                },
                //获取当前货币单位
                showAssistCoin: function () {
                    //显示辅助货币名字，不显示默认
                    if (this.MONEY == 'none') {
                        return '';
                    } else {
                        return this.MONEY.toUpperCase();
                    }
                },
                //总金额
                showTotalAssistHint: function (coin) {
                    var price = this.fixTotalDecimal(coin, 8);
                    return "<%= LANG('折合')%>:" + this.getConvertPriceByAssist(coin, price) + " " + this.showAssistCoin();
                },
                //可用价格折合的提示内容
                showAvailableAssistHint: function (coin) {
                    var price = this.fixAvailableDecimal(coin, 8);
                    return "<%= LANG('折合')%>:" + this.getConvertPriceByAssist(coin, price) + " " + this.showAssistCoin();
                },
                //冻结价格折合的提示内容
                showFreezeAssistHint: function (coin) {
                    var price = this.fixFreezeDecimal(coin, 8);
                    return "<%= LANG('折合')%>:" + this.getConvertPriceByAssist(coin, price) + " " + this.showAssistCoin();
                },
                fixFloat: function (value, unit) {
                    return Methods.fixFloat(value, unit);
                },
                fixNumber: function (value, unit) {
                    return Methods.fixNumber(value, unit);
                },
                //总资金
                fixTotalDecimal: function (coin, unit) {
                    var amount = parseFloat(coin.amount || 0);
                    var freeze = parseFloat(coin.freeze || 0);
                    // console.log(freeze);

                    return Methods.fixDecimal(amount + freeze, unit);
                },

                //可用资金
                fixAvailableDecimal: function (coin, unit) {
                    var amount = coin.amount || 0;
                    var value = parseFloat(amount);
                    // var freeze = coin.freeze || 0;
                    // var value = parseFloat(amount - freeze);

                    return Methods.fixDecimal(value, unit);
                },
                //冻结资金
                fixFreezeDecimal: function (coin, unit) {
                    var freeze = parseFloat(coin.freeze || 0);

                    return Methods.fixDecimal(freeze, unit);
                },
                //去掉虚拟市场货币的D字符
                getRealCoinName: function (coin) {
                    /*if (coin.length > 3 && coin.substring(0, 1) == 'd') {
                        return coin.substring(1);
                    } else {
                        return coin;
                    }*/
                    return coin;
                },
                // 获取币价汇率
                getPriceRate: function (callback) {
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/config/controller/website/pricecontroller/" + 'getassistprice',
                        success: function (res) {
                            this.loaded = true;

                            this.assistPrice = res.datas;
                            //var oriPrice = res.datas.prices[this.moneyType];
                            /*if (res.datas.rate['USD_CNY']) {
                              this.rate = res.datas.rate['USD_CNY'];
                            }*/
                            //this.oriPiece = oriPrice;
                            //this.moneyPrice = oriPrice/this.rate;
                            if (typeof callback == 'function') {
                                callback();
                            }
                        }.bind(this),
                        error: function () {
                        }
                    });
                },
                /*
                * 获取所有货币信息
                * */
                getCoinConfig: function () {
                    var data = {
                        // webId: 100
                    };
                    Methods.ajax({
                        type: 'GET',
                        //url: DOMAIN_MAIN + API_PREFIX + 'getCoinMaps',
                        data: data,
                        url: DOMAIN_DEV + "/exchange/config/controller/website/currencycontroller/" + 'getCurrencyList',
                        success: function (res) {
                            this.coinConfig = res.datas;
                        }.bind(this)
                    });
                },
                // 获取用户总额不为零的货币信息(财务中心)
                getAccountAssets: function () {
                    var data = {
                        // webId: 100,
                        userId: Methods.getLocalUserInfo(ENV + 'userInfo').userId,
                        pageSize: 9999,
                        pageNum: 1
                    };
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/fundcontroller/" + 'findbypage',
                        data: JSON.stringify(data),
                        success: function (res) {
                            if (res.datas.list) {
                                this.userAssets = res.datas.list;
                            }
                        }.bind(this),
                        error: function () {
                        }
                    });
                },
                //置顶货币 接口暂无
                topUserCoin: function (coin, userId) {
                    var data = {
                        coin: coin,
                        targetUserId: userId
                    };
                    // Methods.ajax({
                    //     type: 'GET',
                    //     url: DOMAIN_MAIN + API_PREFIX + 'topUserCoin',
                    //     data: data,
                    //     success: function (res) {
                    //         this.getAccountAssets(1);
                    //         $.toast({
                    //             heading: "<%= LANG('修改用户币种信息成功') %>",
                    //             text: EXX.L(res.resMsg.message),
                    //             showHideTransition: 'plain',
                    //             icon: 'success'
                    //         });
                    //     }.bind(this)
                    // });
                },
                getSubAccounts: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_MAIN + API_PREFIX + 'getSubAccounts',
                        success: function (res) {
                            this.allSubAccounts = res.datas.accounts;
                        }.bind(this)
                    });
                },
                // 设置辅助币种
                setCurrency: function (coin) {
                    if (!this.isLogin) {
                        Methods.setCookie(ENV + 'mname', coin);
                        this.MONEY = coin;
                        return
                    }

                    var data = {
                        assistCoin: coin
                    };
                    Methods.ajax({
                        // url: DOMAIN_MAIN + API_PREFIX + 'editAssistCoin',
                        url: DOMAIN_DEV + "/exchange/user/controller/website/usercontroller/" + 'editassistcoin',
                        data: JSON.stringify(data),
                        success: function (res) {
                            Methods.setCookie(ENV + 'mname', coin);
                            this.MONEY = coin;
                            //top.location.reload();
                        }.bind(this)
                    });
                },
                getUserInfo: function () {
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_MAIN + API_PREFIX + 'getuserinfo',
                        success: function (res) {
                            //this.allSubAccounts = res.datas.accounts;
                        }.bind(this)
                    });
                },
                transfer: function (type, userId, coin) {
                    this.transferInfo = {
                        type: type,
                        userId: userId,
                        coin: coin
                    };
                    this.showModal = 'transfer';
                },
                transferSuccess: function () {
                    this.getAccountAssets();
                    this.showModal = false;
                },
                userActionSuccess: function () {
                    return function () {
                        this.getAccountAssets();
                        this.closeModal('addAccount');
                    }.bind(this)
                },
                setMobileSuccess: function () {
                    return function () {
                        this.closeModal('setMobile');
                        JuaBox.info("<%= LANG('手机信息设置成功') %>");
                    }.bind(this)
                },
                getWindowWidth: function () {
                    if (!this.timer) {
                        this.timer = true;
                        var _this = this;
                        // 添加延迟处理
                        setTimeout(function () {
                            _this.timer = false
                            _this.winWidth = window.innerWidth;
                        }, 400);
                    }
                },
                handleClickOutsideSelect: function () {
                    this.showCurrencyList = false;
                },
                //个人加速池接口
                getuserfeetotal:function(){
                    if (!ISLOGIN) {
                        return
                    }
                    var that=this;
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/FundMinerStatController/getuserfeetotal",
                        success: function (res) {
                            that.getuserfeetotalData=res.datas
                        }
                    })
                },
                //公共加速池接口
                todayminerstat: function(){
                    var that=this;
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/FundMinerStatController/todayminerstat",
                        success: function (res) {
                            that.todayminerstatDta=res.datas
                        },
                        error: function (res) {
                            var resMsg = res.resMsg;
                            // authErrorUi(EXX.L(resMsg.message));
                        }
                    })
                },
                unlockZT:function () {
                    if (Number(this.getuserfeetotalData.totalLockAmount) <=0){
                        Alert({
                            title: "<%= LANG('提示') %>",
                            //text: "<%= LANG('您还未投入ZT到加速池中') %>",
                            text: "您还未投入ZT到加速池中,请到交易挖矿页面【加速挖矿】",
                            animation: "slide-from-top",
                        })
                        return
                    }

                    var that=this;
                    Alert({
                            title: "<%= LANG('解锁ZT') %>",
                            text: "<%= LANG('您当前加速池中拥有') %>" + that.getuserfeetotalData.totalLockAmount +",<%= LANG('是否解锁ZT，解锁用户无法收到交易当天的ZT分红和手续费返还。') %>",
                            showCancelButton: true,
                            closeOnConfirm: false,
                            animation: "slide-from-top",
                            showLoaderOnConfirm: true
                        },
                        function () {
                            Methods.ajax({
                                url: DOMAIN_DEV + "/exchange/fund/controller/website/FundMinerStatController/closeminer",
                                success: function (res) {
                                    that.getuserfeetotal()
                                    that.todayminerstat()
                                    that.isshutmodel = false
                                    Alert({
                                        title: "<%= LANG('提示') %>",
                                        text: "<%= LANG('1分钟内可同步完成，刷新页面可见。') %>",
                                        animation: "slide-from-top",
                                    })
                                },
                                error: function (res) {
                                    var resMsg = res.resMsg;
                                    // authErrorUi(EXX.L(resMsg.message));
                                    Alert({
                                        title: "<%= LANG('提示') %>",
                                        text: "<%= LANG('关闭加速错误，请重新尝试') %>",
                                        icon: "error",
                                        animation: "slide-from-top",
                                    })
                                }
                            })
                        });
                },
                getuserfeetotal:function(){
                    if (!ISLOGIN) {
                        return
                    }
                    var that=this;
                    Methods.ajax({
                        url: DOMAIN_DEV + "/exchange/fund/controller/website/FundMinerStatController/getuserfeetotal",
                        success: function (res) {
                            that.getuserfeetotalData=res.datas
                            if (that.getuserfeetotalData.totalLockAmount){
                                that.getuserfeetotalData.totalLockAmount = Math.floor((that.getuserfeetotalData.totalLockAmount)*1000000)/1000000
                            }else {
                                that.getuserfeetotalData.totalLockAmount = "--"
                            }
                        },
                        error: function (res) {
                            var resMsg = res.resMsg;
                            // authErrorUi(EXX.L(resMsg.message));

                        }
                    })
                },

            },
            filters: {
                filterNum: function (num) {
                    if (num <= 0 || num == '') {
                        return '--'
                    }
                    return num
                }
            },
            created: function () {
                //获取用户资金
                this.getAccountAssets();
                //获取货币信息
                this.getCoinConfig();

                this.getPriceRate();
                this.getuserfeetotal();
            },
            mounted: function () {
                document.addEventListener('click', this.handleClickOutsideSelect, true);
                window.addEventListener('resize', this.getWindowWidth, true);
                $('[data-toggle="tooltip"]').tooltip();
            },
            updated: function () {
                $('[data-toggle="tooltip"]').tooltip();
            },
            beforeDestroy: function () {
                document.removeEventListener('click', this.handleClickOutsideSelect, true)
                document.removeEventListener('resize', this.getWindowWidth, true)
            }
        })
    });


</script>
<script type="text/javascript" src="<%= STATIC %>/scripts/slider.js"></script>
<script type="text/javascript" src="<%= STATIC %>/scripts/xulei-v1.js"></script>
