<div class="content" id="mainForm">
  <nav class="breadcrumb" aria-label="breadcrumbs">
    <ul>
      <li class="dashboard">Dashboard</li>
      <li><a href="/u"><i class="icon iconfont icon-home"></i></a></li>
      <li><a href="/u"><%= LANG('账户面板') %></a></li>
      <li><a href="/u/safe"><%= LANG('基本信息') %></a></li>
      <li class="is-active"><a href="/u/safe/setGoogle"><%= LANG('Google认证') %></a></li>
    </ul>
  </nav>

  <h2><%= LANG('Google认证') %></h2>

  <div v-if="type != 0" class="vip-tip">
    <dl class="clearfix">
      <img :src="googleQrCodeUrl" class="pull-left mr15" style="width:120px; height:auto;">
      <dt><%= LANG('使用帮助') %>：</dt>
      <dd>1.<%= LANG('下载安装Google认证器') %></dd>
      <dd>2.<%= LANG('然后选择“扫描条形码”。') %></dd>
      <dd>3.<%= LANG('扫描左侧条形码，输入Google验证码，完成认证。') %></dd>
      <dd>4.<%= LANG('如果您无法扫描成功上图的条形码，您还可以手动添加账户，并输入如下密匙') %>：<span>{{googleSecret}}</span></dd>
      <dd>5.<%= LANG('请勿删除此双重验证密码账户，否则会导致您无法进行账户操作；如果误删，您可通过重置密钥重新获取。') %></dd>
    </dl>
  </div>

  <div class="fill-form">
    <div class="fill-form-bd">
      <div v-if="type != 0" class="fill-group">
        <em class="name"><%= LANG('密钥') %>：</em>
        <input class="fill-control" v-model="googleSecret" readonly type="text">
      </div>

      <div class="fill-group">
        <em class="name"><%= LANG('Google验证码') %>：</em>
        <input class="fill-control" v-model="googleCode" type="text">
      </div>

      <div class="fill-group">
        <em class="name"><%= LANG('动态验证码') %>：</em>
        <input class="fill-control" v-model="dynamicCode" type="text">
        <send-code class="hq btn-five btn-sm" :code-type="12" :country-code="userInfo.mobile.split(' ')[0]" :user-name="userInfo.mobile.split(' ')[1]" />
      </div>
    </div>
    <div class="fill-form-fd text-center">
      <a v-on:click="handleSubmit" class="btn btn-primary btn-block">
        {{btnText}}
      </a>
    </div>
  </div>

</div>

<%-include("../../component/send_code/index.html")%>
<script>
  require(['vue', 'common/methods', 'common/juabox'], function(Vue, Methods, JuaBox) {
    var mainForm = new Vue({
      el: '#mainForm',
      data: function () {
        return {
          googleSecret: '',
          dynamicCode: '',
          googleCode: ''
        }
      },
      computed: {
        userInfo: function () {
          return Methods.getLocalUserInfo();
        },
        googleQrCodeUrl: function () {
          return DOMAIN_MAIN + '/manage/getGoogleAuthQr?secret=' + this.googleSecret;
        },
        type: function () {
          var query = Methods.parseQueryString();
          var type = query["type"] ? query["type"] : '1';
          return type;
        },
        btnText: function () {
          var text = '';
          switch (this.type) {
            case '0':
              text = "<%= LANG('验证并关闭') %>";
              break;
            case '1':
              text = "<%= LANG('验证并开启') %>";
              break;
            case '2':
              text = "<%= LANG('验证并修改') %>";
              break;
          }
          return text;
        }
      },
      methods: {
        getGoogleSecret: function () {
          var _this = this;
          Methods.ajax({
            url: DOMAIN_MAIN + API_PREFIX + 'getGoogleSecret',
            success: function (res) {
              _this.googleSecret = res.datas.secret;
            }
          });
        },
        handleSubmit: function () {
          var data = {
            type: this.type,
            googleSecret: this.googleSecret,
            googleCode: this.googleCode,
            dynamicCode: this.dynamicCode
          };
          Methods.ajax({
            url: DOMAIN_MAIN + API_PREFIX + 'doSetGoogleAuth',
            data: data,
            success: function (res) {
              Methods.setLocalUserInfo(JSON.stringify(res.datas.userInfo));
              window.location.replace('/u/safe');
            }
          });
        }
      },
      mounted: function (){
        this.getGoogleSecret();
      }
    });
  });
</script>