<div id="help-left" class="help-ld loaded" :class="{'out': showMenu}" v-cloak>
  <div class="rightbtn"><i @click="setShowMenu(true)" class="iconfont icon-liebiao"></i><i @click="setShowMenu(false)"  class="iconfont icon-jiantouleft"></i></div>
  <div class="help-ldlist">
    <div v-for="category in categories" class="list vue-init">
      <h3 @click="changeCategory(category)" :class="{add: sharedState.currentCategoryId == category.code}">{{category.name}}</h3>
      <transition name="slide-down">
        <ul v-show="sharedState.currentCategoryId == category.code">
          <li v-for="article in articles[category.code]"><a href="javascript:;" @click="changeArticle(article.id)">{{article.title}}</a></li>
        </ul>
      </transition>
    </div>
  </div>
</div>

<script>
  var store = {
    state: {
      currentCategoryIndex: '',
      currentCategoryId: '',
      currentCategoryName: '',
      articleId: '',
      articles: {}
    },
    setArticles: function(articles) {
      this.state.articles = articles;
    }
  };
  require(['vue', 'common/methods'], function(Vue, Methods) {
    var helpLeft = new Vue({
      el: "#help-left",
      data: function() {
        return {
          loaded: true,
          showMenu: false,
          fid: 4,
          sharedState: store.state,
          categories: [],
          articles: {},
          catalog: []
        }
      },
      computed: {
      },
      methods: {
        getCategory: function() {
          var data = {
            tag: ''
          };
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getProblCategor',
            data: data,
            success: function(res) {
              this.categories = res.datas.problCategor
            }.bind(this)
          });
        },
        setShowMenu: function(boolean) {
          this.showMenu = boolean;
        },
        changeCategory: function(category) {
          this.sharedState.currentCategoryId = category.code;
          this.sharedState.currentCategoryName = category.name;
            var articles = this.sharedState.articles[this.sharedState.currentCategoryId] || [];
            this.sharedState.articleId = articles.length ? articles[0].id : '';
          this.$forceUpdate();
        },
        changeArticle: function(id) {
          if (EXX.helpDisplay) {
            EXX.helpDisplay.getArticle(id);
          } else {
            window.location.replace('/help/display?id=' + id+ '&cid=' + this.sharedState.currentCategoryId + '&fid=' + this.sharedState.fid);
          }
          this.sharedState.articleId = id;
        },
        getCatalog: function() {
          var data = {
            tab: this.sharedState.fid
          };
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getProblemCategorType',
            data: data,
            success: function(res) {
              var categories = res.datas.problemType[0].problCategor;
              this.categories = categories;
              if (categories.length && this.sharedState.currentCategoryId == '') {
                this.changeCategory(categories[0]);
              }
              this.$nextTick(function () {
                this.categories.forEach(function(category, index){
                  this.getArticlesList(category.code, index);
                }.bind(this));
                this.$forceUpdate();
                  if (EXX.helpDisplay) {
                      EXX.helpDisplay.$forceUpdate();
                  }
              });
            }.bind(this)
          });
        },
        getArticlesList: function(categoryId) {
          var data = {
            problemType: this.sharedState.fid,
            problCategor: categoryId
          };
          Methods.ajax({
            type: 'GET',
            url: DOMAIN_MAIN + API_PREFIX + 'getProblemTitleList',
            data: data,
            success: function(res) {
              var articles = this.articles;
              articles[categoryId] = res.datas.titelList;
              this.articles = articles;
              //store.setArticles(articles);
              this.sharedState.articles[categoryId] = res.datas.titelList;
              this.$nextTick(function () {
                  this.$forceUpdate();
                if (EXX.helpDisplay) {
                  EXX.helpDisplay.$forceUpdate();
                }
              });
            }.bind(this)
          });
        }
      },
      created: function() {
        var params = Methods.parseQueryString();
        if (params.cid) {
          this.sharedState.currentCategoryId = params.cid;
        }
        this.sharedState.fid = params.fid;
        this.getCatalog();
      },
      mounted: function() {
      },
      watch: {
      }
    });
  })

</script>