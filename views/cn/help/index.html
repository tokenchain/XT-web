<link rel="stylesheet" href="<%= STATIC %>/styles/help/index.css?<%= VERSION %>">

<div class="help" id="help-index">
    <div class="help-banner" id="help-banner" v-if="type == 0" v-cloak>
        <h2 class="banner-h2">EXX帮助中心</h2>
        <span class="banner-span">欢迎使用EXX帮助中心，我们对以往搜集到的问题进行汇总与解答，希望能够帮助到您。</span>
    </div>

    <%-include("help_search.html")%>

    <div class="help-content" id="help-content">
        <div class="help-container">

            <!--侧边栏-->
            <div class="help-ld loaded " :class="{'out': showMenu}" v-cloak>
                <div class="help-ldlist">
                    <div v-for="(category,key) in categories" class="list vue-init">
                        <h3 class="help-left-h3"
                            @click="changeCategory(category)"
                            :class="{add: sharedState.currentCategoryId == category.categoryId}">
                            {{category.categoryName}}
                        </h3>
                        <transition name="slide-down">
                            <ul v-show="sharedState.currentCategoryId == category.categoryId">
                                <!--情况1-->
                                <li v-for="article in category.subArticle">
                                    <a href="javascript:;"
                                       @click="changeArticle(article)">
                                        {{article.articleTitle}}
                                    </a>
                                </li>

                                <!--情况2-->
                                <li v-for="article in category.subsetCategory">
                                    <a href="javascript:;" @click="changeArticle(article)">{{article.categoryName}}</a>
                                </li>
                            </ul>
                        </transition>
                    </div>
                </div>
            </div>
            <!--侧边栏结束-->

            <!--主内容区-->
            <div class="help_right" v-cloak>
                <div v-if="type == 0">
                    <div>
                        <h2>热门问题</h2>
                        <span>大家都在搜索的，或许是您所要了解的.</span>
                        <ul class="articles-ul">
                            <li class="articles-li" v-for="(item,key) in hotArticles" @click="changeUrl(item)">
                                {{item.articleTitle}}
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h2>常见问题</h2>
                        <span>汇总了不同场景下常用操作指南教程，快速找到您的问题！</span>
                        <ul class="articles-ul">
                            <li class="articles-li articles-li-border" v-for="(item,key) in faqArticles"
                                @click="changeUrl(item)">
                                {{item.articleTitle}}
                            </li>
                        </ul>
                    </div>
                </div>

                <div class='article-box' v-if="type == 1">
                    <div class="article-box-nav"></div>
                    <div class="article-border">
                        <h2 class="article-title">{{article.articleTitle}}</h2>
                        <div v-html="decodeURI(article.content)"></div>
                    </div>

                    <div class="help-feedback">
                        是否对你有帮助？
                        <button v-if="feedback == false" class="feedback-button" @click="isHelpFul('help_count')">是
                        </button>
                        <button v-if="feedback == false" class="feedback-button" @click="isHelpFul('no_help_count')">否
                        </button>
                        <button v-if="feedback == true" class="feedback-button">已提交</button>
                    </div>

                    <div class="help-customer-service">
                        不是你想要的答案？试试
                        <button class="feedback-button">联系客服</button>
                    </div>

                    <div class="related-questions">
                        <h3 class="related-title">相关问题</h3>
                        <ul>
                            <li></li>
                        </ul>
                    </div>
                </div>

                <div class='cascading-menu' v-if="type == 2">
                    <div class="article-box-nav"></div>
                    <h2 class="menu-title">{{categoriesMenu.categoryName}}</h2>
                    <ul class="menu-ul">
                        <li class="menu-li" v-for="item in categoriesMenu.subArticle" @click="changeArticle(item)">{{item.articleTitle}}</li>
                    </ul>
                    <div class="help-customer-service">
                        不是你想要的答案？试试
                        <button class="feedback-button">联系客服</button>
                    </div>
                </div>
            </div>
            <!--主内容区结束-->
        </div>
    </div>
</div>
<script>
    var store = {
        state: {
            currentCategoryIndex: '',
            currentCategoryId: '',
            currentCategoryName: '',
            articleId: '',
            articles: {}
        },
        setArticles: function (articles) {
            this.state.articles = articles;
        }
    };

    require(['vue', 'common/methods'], function (Vue, Methods) {
        new Vue({
            el: '#help-content',
            mounted: function () {
                this.getCategoryByType()
                this.getCatalog();
                var params = Methods.parseQueryString();
                if (params.categoryId) {
                    this.sharedState.currentCategoryId = params.categoryId;
                } else {
                    this.sharedState.currentCategoryId = params.levelOneId
                }
                this.sharedState.fid = params.fid;
                if (params.categoryId && params.articleId) {
                    this.urlParams.categoryId = params.categoryId
                    this.urlParams.articleId = params.articleId
                    this.type = 1;
                    this.getArticleById(params.articleId)

                } else if (params.levelOneId) {
                    this.type = 2;
                } else {
                    this.type = 0;
                    this.getHotArticles()
                    this.getFaqArticles()
                }
            },
            data: function () {
                return {
                    hotArticles: [],
                    faqArticles: [],
                    article: '',
                    type: 0,
                    urlParams: {},
                    feedback: false,

                    loaded: true,
                    showMenu: false,
                    fid: 4,
                    sharedState: store.state,
                    categories: [],
                    articles: {},
                    catalog: [],
                    categoriesMenu: []
                }
            },
            methods: {
                getHotArticles: function () {
                    var lanNum = 1
                    switch (LAN) {
                        case "cn":
                            lanNum = 1
                            break;
                        case "en":
                            lanNum = 2
                            break;
                        case "kr":
                            lanNum = 3
                            break;
                        case "jp":
                            lanNum = 4
                            break;
                    }
                    var data = {
                        lanType: lanNum
                    };
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/support/controller/website/articlecontroller/" + 'gethotarticles',
                        data: data,
                        success: function (res) {
                            this.hotArticles = res.datas
                        }.bind(this)
                    });
                },
                getFaqArticles: function () {
                    var that = this
                    var lanNum = 1
                    switch (LAN) {
                        case "cn":
                            lanNum = 1
                            break;
                        case "en":
                            lanNum = 2
                            break;
                        case "kr":
                            lanNum = 3
                            break;
                        case "jp":
                            lanNum = 4
                            break;
                    }
                    var data = {
                        lanType: lanNum
                    };

                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/support/controller/website/articlecontroller/" + 'getfaqarticles',
                        data: data,
                        success: function (res) {
                            if (res.datas.length > 0) {
                                that.faqArticles = res.datas
                            }
                        }
                    });
                },
                changeUrl: function (item) {
                    window.location.replace('/help/articles?categoryId=' + item.categoryId + '&articleId=' + item.articleId);
                },
                getArticleById: function (articleId) {
                    var lanNum = 1
                    switch (LAN) {
                        case "cn":
                            lanNum = 1
                            break;
                        case "en":
                            lanNum = 2
                            break;
                        case "kr":
                            lanNum = 3
                            break;
                        case "jp":
                            lanNum = 4
                            break;
                    }
                    var data = {
                        articleId: articleId,
                        lanType: lanNum
                    };
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/support/controller/website/articlecontroller/" + 'getarticlebyid',
                        data: data,
                        success: function (res) {
                            this.article = res.datas
                        }.bind(this)
                    });
                },
                isHelpFul: function (helpType) {
                    var data = {
                        articleId: this.urlParams.articleId,
                        helpType: helpType
                    };
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/support/controller/website/articlecontroller/" + 'ishelpful',
                        data: data,
                        success: function (res) {
                            if (res.resMsg.code == 1) {
                                this.feedback = true
                            }
                        }.bind(this)
                    });
                },

                getCategory: function () {
                    var data = {
                        tag: ''
                    };
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_MAIN + API_PREFIX + 'getProblCategor',
                        data: data,
                        success: function (res) {
                            this.categories = res.datas.problCategor
                        }.bind(this)
                    });
                },
                setShowMenu: function (boolean) {
                    this.showMenu = boolean;
                },
                changeCategory: function (category) {
                    this.sharedState.currentCategoryId = category.categoryId;
                    this.sharedState.currentCategoryName = category.name;
                    var articles = this.sharedState.articles[this.sharedState.currentCategoryId] || [];
                    this.sharedState.articleId = articles.length ? articles[0].id : '';
                    this.$forceUpdate();
                },
                changeArticle: function (item) {
                    if (item.articleId) {
                        window.location.replace('/help/articles?categoryId=' + item.categoryId + '&articleId=' + item.articleId);
                    } else {
                        window.location.replace('/help/articles?levelOneId=' + item.parentId + '&levelTwoId=' + item.categoryId);
                    }
                },
                getCatalog: function () {
                    var data = {
                        tab: this.sharedState.fid
                    };
                },
                getArticlesList: function (categoryId) {
                    var data = {
                        problemType: this.sharedState.fid,
                        problCategor: categoryId
                    };
                },
                getCategoryByType: function () {
                    var lanNum = 1
                    switch (LAN) {
                        case "cn":
                            lanNum = 1
                            break;
                        case "en":
                            lanNum = 2
                            break;
                        case "kr":
                            lanNum = 3
                            break;
                        case "jp":
                            lanNum = 4
                            break;
                    }
                    var data = {
                        type: 1,
                        lanType: lanNum
                    };
                    Methods.ajax({
                        type: 'GET',
                        url: DOMAIN_DEV + "/exchange/support/controller/website/articlecategorycontroller/" + 'getCategoryByType',
                        data: data,
                        success: function (res) {
                            var params = Methods.parseQueryString()
                            // console.log(params)
                            if (res.datas.length > 0) {
                                this.categories = res.datas[0].subsetCategory
                                if (params.levelOneId && params.levelOneId) {
                                    for (var i = 0; i < this.categories.length; i++) {
                                        if (this.categories[i].categoryId == params.levelOneId) {
                                            // console.log('查找到')
                                            var menu = this.categories[i].subsetCategory
                                            for (var j = 0; j < menu.length; j++) {
                                                if (menu[i].categoryId == params.levelTwoId) {
                                                    this.categoriesMenu = menu[i]
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                        }.bind(this)
                    });
                }
            }
        })
    })

    require(['vue', 'common/methods'], function (Vue, Methods) {
        new Vue({
            el: '#help-banner',
            created: function () {
                var param = Methods.parseQueryString()
                if (param.categoryId || param.levelOneId){
                    this.type = -1
                }
            },
            data: function () {
                return {
                    type: 0
                }
            }
        })
    })
</script>
